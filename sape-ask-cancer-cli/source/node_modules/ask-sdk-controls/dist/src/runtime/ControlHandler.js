"use strict";
/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.extractStateFromControlTree = exports.attachStateToControlTree = exports.ControlHandler = void 0;
const tslib_1 = require("tslib");
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const ControlInput_1 = require("../controls/ControlInput");
const ControlResult_1 = require("../controls/ControlResult");
const IContainerControl_1 = require("../controls/interfaces/IContainerControl");
const Logger_1 = require("../logging/Logger");
const ControlResponseBuilder_1 = require("../responseGeneration/ControlResponseBuilder");
const ControlTreeVisualization_1 = require("../utils/ControlTreeVisualization");
const ControlVisitor_1 = require("../utils/ControlVisitor");
const RequestUtils_1 = require("../utils/RequestUtils");
const SerializationValidator_1 = require("../utils/SerializationValidator");
const SessionBehavior_1 = require("./SessionBehavior");
const log = new Logger_1.Logger('AskSdkControls:ControlHandler');
/**
 * Session context information in addition to that provided by Alexa Service.
 */
class AdditionalSessionContext {
    constructor() {
        this.turnNumber = 0;
    }
}
/**
 * RequestHandler for a skill built using Controls.
 *
 * This is the common runtime that drives the processing flow for a skill that
 * uses Controls.  Please see the user guide for a thorough discussion of the
 * phases of processing and how the common `ControlHandler` interfaces with
 * an instance of `ControlManager` and the control tree.
 *
 */
class ControlHandler {
    constructor(controlManager) {
        /**
         * Determines if the controls state will be correctly reestablished on the
         * next turn
         *
         * Usage:
         *  * If a skill uses more than one ControlHandler the state validation
         *    procedure gets confused due to unexpected control states in session
         *    attributes. In this situation, set `validateStateRoundtrip = false`.
         */
        this.validateStateRoundtrip = true; // TODO improve the validation testing and remove this
        this.controlManager = controlManager;
    }
    prepare(handlerInput) {
        if (this.preparedRequestId === handlerInput.requestEnvelope.request.requestId) {
            return; // don't prepare again for the same requestId.
        }
        this.preparedRequestId = handlerInput.requestEnvelope.request.requestId;
        // retrieve and update the context object.
        const retrievedContext = handlerInput.attributesManager.getSessionAttributes()[ControlHandler.attributeNameContext];
        this.additionalSessionContext = retrievedContext !== undefined ? JSON.parse(retrievedContext) : new AdditionalSessionContext();
        this.additionalSessionContext.turnNumber += 1;
        // retrieve the control state
        const stateMap = this.getStateMapFromSessionAttributes(handlerInput);
        // build the control tree and attach state
        this.rootControl = this.controlManager.createControlTree(stateMap);
        attachStateToControlTree(this.rootControl, stateMap);
        // create the input object for use in the main processing.
        const controls = ControlHandler.createControlMap(this.rootControl, {});
        this.controlInput = new ControlInput_1.ControlInput(handlerInput, this.additionalSessionContext.turnNumber, controls);
    }
    getStateMapFromSessionAttributes(handlerInput) {
        const retrievedStateJSON = handlerInput.attributesManager.getSessionAttributes()[ControlHandler.attributeNameState];
        const stateMap = retrievedStateJSON !== undefined ? JSON.parse(retrievedStateJSON) : {};
        return stateMap;
    }
    static createControlMap(control, mapAcc) {
        mapAcc[control.id] = control;
        if (IContainerControl_1.isContainerControl(control)) {
            for (const child of control.children) {
                ControlHandler.createControlMap(child, mapAcc);
            }
        }
        return mapAcc; // returning the accumulator allows the call-site to be more readable
    }
    /**
     * Determines if this RequestHandler handle the input.
     *
     * @param handlerInput - HandlerInput
     */
    async canHandle(handlerInput) {
        try {
            this.prepare(handlerInput);
            return this.rootControl.canHandle(this.controlInput);
        }
        catch (error) {
            if (this.controlManager.handleInternalError) {
                this.controlManager.handleInternalError(this.controlInput, error, handlerInput.responseBuilder);
            }
            throw error; // rethrow so top-level observes it too.
        }
    }
    /**
     * Handle the input.
     *
     * @param handlerInput - HandlerInput
     */
    async handle(handlerInput, processInput = true) {
        try {
            this.prepare(handlerInput);
            /*
             * Process the turn through the application.
             * Do the work (state updates and dialog policy)
             */
            const responseBuilder = new ControlResponseBuilder_1.ControlResponseBuilder(handlerInput.responseBuilder);
            const resultBuilder = new ControlResult_1.ControlResultBuilder();
            await ControlHandler.handleCore(this.rootControl, this.controlInput, resultBuilder, processInput);
            // Compose the response
            const response = await this.buildResponseCore(resultBuilder.build(), responseBuilder, this.controlInput);
            // Collate the Control state objects for serialization
            /* Note: we merge onto the prevailing state for the edge-case of multiple ControlHandlers in the skill that are active on different turns.
             *       merging avoid one controlHandler stomping on the state of the other.  Context is currently OK/good to be stomped on.
             */
            const priorStateMap = this.getStateMapFromSessionAttributes(handlerInput);
            const currentStateMap = this.getSerializableControlStates();
            const mergedStateMap = Object.assign(Object.assign({}, priorStateMap), currentStateMap);
            const stateToSaveJson = JSON.stringify(mergedStateMap, null, 2);
            log.info(`Saving state...\n${stateToSaveJson} `);
            const contextToSaveJson = JSON.stringify(this.additionalSessionContext, null, 2);
            log.info(`Saving context...\n${contextToSaveJson}`);
            this.controlInput.handlerInput.attributesManager.getSessionAttributes()[ControlHandler.attributeNameState] = stateToSaveJson;
            this.controlInput.handlerInput.attributesManager.getSessionAttributes()[ControlHandler.attributeNameContext] = contextToSaveJson;
            // Check that the serialized state will survive the round trip
            if (this.validateStateRoundtrip) {
                SerializationValidator_1.validateSerializedState(stateToSaveJson, this.controlManager, this.controlInput);
            }
            return response;
        }
        catch (error) {
            if (this.controlManager.handleInternalError) {
                this.controlManager.handleInternalError(this.controlInput, error, handlerInput.responseBuilder);
            }
            return Object.assign(Object.assign({}, handlerInput.responseBuilder.getResponse()), { isTurnEnding: true });
        }
    }
    /**
     * Creates a string 'C:<nControls>' for inclusion in UserAgent to indicate usage.
     *
     * The information gathered is only the number of Controls being used.
     * This will help the dev team to understand usage - thank you!
     */
    userAgentInfo() {
        var _a;
        const rootControl = (_a = this.rootControl) !== null && _a !== void 0 ? _a : this.controlManager.createControlTree({});
        let nControls = 0;
        ControlVisitor_1.visitControls(rootControl, () => { nControls++; });
        return `nCtrl:${nControls}`;
    }
    /**
     * Implements the core of the processing loop
     *
     * Public for testing
     */
    static async handleCore(rootControl, input, resultBuilder, handleInput = true) {
        log.info("-------------------------------------------------------------------------------------------------");
        log.info(`Turn ${input.turnNumber} started`);
        log.info(`Input: ${RequestUtils_1.requestToString(input.handlerInput.requestEnvelope.request)}`);
        log.info(`UI at start: \n${ControlTreeVisualization_1.generateControlTreeTextDiagram(rootControl, input.turnNumber)}`);
        if (handleInput) {
            const canHandleResponse = await rootControl.canHandle(input);
            if (!canHandleResponse) {
                log.warn(" *WARN* rootControl returned canHandle=false.  Closing session");
                log.info(`UI at end of turn: \n${ControlTreeVisualization_1.generateControlTreeTextDiagram(rootControl, input.turnNumber)}`);
                return;
            }
            // HANDLE
            await rootControl.handle(input, resultBuilder);
        }
        // Optional INITIATIVE PHASE
        if (!resultBuilder.hasInitiativeAct() && resultBuilder.sessionBehavior === SessionBehavior_1.SessionBehavior.OPEN) {
            await ControlHandler.initiativePhase(rootControl, input, resultBuilder);
        }
        // TODO: track the specific controlID that generated the initiative. make it available so that controls
        // can use a hasInitiative() predicate and reason about whether they are actively running the conversation.
        log.info(`HandleResponse: ${resultBuilder}`);
        log.info(`UI at end of turn: \n${ControlTreeVisualization_1.generateControlTreeTextDiagram(rootControl, input.turnNumber)}`);
    }
    static async initiativePhase(rootControl, input, resultBuilder) {
        log.debug(`UI at start of initiative phase: \n${ControlTreeVisualization_1.generateControlTreeTextDiagram(rootControl, input.turnNumber)}`);
        const canTakeInitiative = await rootControl.canTakeInitiative(input);
        if (canTakeInitiative) {
            await rootControl.takeInitiative(input, resultBuilder);
            if (!resultBuilder.hasInitiativeAct()) {
                throw new Error("Something responded with `canTakeInitiative=true` but no initiative item was produced.");
            }
        }
        else {
            log.debug("End of handle: nothing wanted to take initiative.");
        }
        return;
    }
    /**
     * Take the initiative in the dialog.
     *
     * Any existing content in the Response's prompt & reprompt is overwritten.
     * To avoid losing this content, pass it in using parameters promptPrefix &
     * repromptPrefix.
     *
     * Usage:
     *  * This method is used to transition from a regular `RequestHandler` into
     *    Controls For example, when a regular `RequestHandler` consumes the
     *    input but doesn't want to keep the initiative, it can ask a
     *    ControlHandler to take the initiative to complete the turn.  A
     *    prompt/reprompt fragment can be specified by the `RequestHandler`
     *    which will be included as the start of the overall prompt/reprompt.
     *
     * @param handlerInput - Handler input
     * @param promptPrefix - Prompt fragment to prefix the prompt generated via
     * Controls.
     * @param repromptPrefix - Reprompt fragment to prefix to the prompt
     * generated via Controls
     */
    async takeInitiative(handlerInput, promptPrefix, repromptPrefix) {
        if (repromptPrefix === undefined) {
            repromptPrefix = promptPrefix;
        }
        /* NOTE: we call handle(.., false) rather than directly calling initiativePhase() as we need all
         * the usual turn book-keeping (prepare, logging, state loading & saving) to occur
         */
        const response = await this.handle(handlerInput, false);
        const [prompt, reprompt] = ControlHandler.getPromptAndRepromptFromResponse(response);
        if (response.outputSpeech === undefined) {
            response.outputSpeech = { type: 'PlainText', text: promptPrefix };
        }
        else if (response.outputSpeech.type === 'SSML') {
            response.outputSpeech = { type: 'SSML', ssml: prompt.replace('<speak>', `<speak>${promptPrefix}`) };
        }
        else {
            response.outputSpeech = { type: 'PlainText', text: promptPrefix + prompt };
        }
        if (response.reprompt === undefined) {
            response.reprompt = { outputSpeech: { type: 'PlainText', text: repromptPrefix } };
        }
        else if (response.reprompt.outputSpeech.type === 'SSML') {
            response.reprompt.outputSpeech = { type: 'SSML', ssml: reprompt.replace('<speak>', `<speak>${repromptPrefix}`) };
        }
        else {
            response.reprompt.outputSpeech = { type: 'PlainText', text: repromptPrefix + reprompt };
        }
        return response;
    }
    static getPromptAndRepromptFromResponse(response) {
        const prompt = response.outputSpeech === undefined
            ? ''
            : (response.outputSpeech.type === 'SSML')
                ? response.outputSpeech.ssml.replace('<ssml>', '').replace('</ssml>', '')
                : response.outputSpeech.text;
        const reprompt = response.reprompt === undefined
            ? ''
            : (response.reprompt.outputSpeech.type === 'SSML')
                ? response.reprompt.outputSpeech.ssml.replace('<ssml>', '').replace('</ssml>', '')
                : response.reprompt.outputSpeech.text;
        return [prompt, reprompt];
    }
    async buildResponseCore(result, controlResponseBuilder, input) {
        await this.controlManager.render(result, input, controlResponseBuilder);
        const response = controlResponseBuilder.getResponse();
        switch (result.sessionBehavior) {
            case SessionBehavior_1.SessionBehavior.OPEN:
                response.shouldEndSession = false;
                break;
            case SessionBehavior_1.SessionBehavior.END:
                response.shouldEndSession = true;
                break;
            case SessionBehavior_1.SessionBehavior.IDLE:
                response.shouldEndSession = undefined;
                break;
            default: throw new Error(`unknown SessionBehavior value: ${JSON.stringify(result)}`);
        }
        return Object.assign(Object.assign({}, response), { isTurnEnding: result.hasInitiativeAct() });
    }
    // public for testing
    getSerializableControlStates() {
        return extractStateFromControlTree(this.rootControl);
    }
}
exports.ControlHandler = ControlHandler;
ControlHandler.attributeNameState = "__controlState";
ControlHandler.attributeNameContext = "__controlContext";
/**
 * Visits each control in the tree and attaches the corresponding state object.
 *
 * @param control - Control
 * @param state - Map of state data to attach to the controls
 */
function attachStateToControlTree(control, state) {
    if (state === undefined) {
        return;
    }
    const myState = state[control.id];
    if (myState !== undefined) {
        control.setSerializableState(myState);
    }
    if (IContainerControl_1.isContainerControl(control)) {
        for (const child of control.children) {
            attachStateToControlTree(child, state);
        }
    }
}
exports.attachStateToControlTree = attachStateToControlTree;
/**
 * Visits each controls and collates the state objects.
 *
 * @param rootControl - Root control
 */
function extractStateFromControlTree(rootControl) {
    const stateObj = {};
    extractStateCore(rootControl, stateObj);
    return stateObj;
}
exports.extractStateFromControlTree = extractStateFromControlTree;
function extractStateCore(control, state) {
    if (lodash_1.default.has(state, control.id)) {
        throw new Error(`Duplicate control id: ${control.id}`);
    }
    state[control.id] = control.getSerializableState();
    if (IContainerControl_1.isContainerControl(control)) {
        for (const child of control.children) {
            extractStateCore(child, state);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udHJvbEhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcnVudGltZS9Db250cm9sSGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7Ozs7QUFJSCw0REFBdUI7QUFDdkIsMkRBQXdEO0FBQ3hELDZEQUFpRTtBQUNqRSxnRkFBOEU7QUFNOUUsOENBQTJDO0FBQzNDLHlGQUFzRjtBQUN0RixnRkFBbUY7QUFDbkYsNERBQXdEO0FBQ3hELHdEQUF3RDtBQUN4RCw0RUFBMEU7QUFDMUUsdURBQW9EO0FBRXBELE1BQU0sR0FBRyxHQUFHLElBQUksZUFBTSxDQUFDLCtCQUErQixDQUFDLENBQUM7QUFFeEQ7O0dBRUc7QUFDSCxNQUFNLHdCQUF3QjtJQUE5QjtRQUNJLGVBQVUsR0FBVyxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUFBO0FBU0Q7Ozs7Ozs7O0dBUUc7QUFDSCxNQUFhLGNBQWM7SUF5QnZCLFlBQVksY0FBK0I7UUFYM0M7Ozs7Ozs7O1dBUUc7UUFDSCwyQkFBc0IsR0FBRyxJQUFJLENBQUMsQ0FBRSxzREFBc0Q7UUFHbEYsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7SUFDekMsQ0FBQztJQUVPLE9BQU8sQ0FBQyxZQUEwQjtRQUN0QyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsS0FBSyxZQUFZLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUU7WUFDM0UsT0FBTyxDQUFDLDhDQUE4QztTQUN6RDtRQUNELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxZQUFZLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7UUFFeEUsMENBQTBDO1FBQzFDLE1BQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDcEgsSUFBSSxDQUFDLHdCQUF3QixHQUFHLGdCQUFnQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLHdCQUF3QixFQUFFLENBQUM7UUFDL0gsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUM7UUFFOUMsNkJBQTZCO1FBQzdCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUdyRSwwQ0FBMEM7UUFDMUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25FLHdCQUF3QixDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFckQsMERBQTBEO1FBQzFELE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSwyQkFBWSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsd0JBQXdCLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzNHLENBQUM7SUFHTyxnQ0FBZ0MsQ0FBQyxZQUEwQjtRQUMvRCxNQUFNLGtCQUFrQixHQUFHLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3BILE1BQU0sUUFBUSxHQUFHLGtCQUFrQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDeEYsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUVPLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFpQixFQUFFLE1BQXFDO1FBQ3BGLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQzdCLElBQUksc0NBQWtCLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDN0IsS0FBSyxNQUFNLEtBQUssSUFBSyxPQUFlLENBQUMsUUFBUSxFQUFFO2dCQUMzQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQ2xEO1NBQ0o7UUFDRCxPQUFPLE1BQU0sQ0FBQyxDQUFDLHFFQUFxRTtJQUN4RixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILEtBQUssQ0FBQyxTQUFTLENBQUMsWUFBMEI7UUFDdEMsSUFBSTtZQUNBLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDM0IsT0FBTyxJQUFJLENBQUMsV0FBWSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDekQ7UUFDRCxPQUFPLEtBQUssRUFBRTtZQUNWLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRTtnQkFDekMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBRSxZQUFZLENBQUMsZUFBZSxDQUFDLENBQUM7YUFDbkc7WUFDRCxNQUFNLEtBQUssQ0FBQyxDQUFDLHdDQUF3QztTQUN4RDtJQUNMLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLE1BQU0sQ0FBQyxZQUEwQixFQUFFLFlBQVksR0FBRyxJQUFJO1FBQ3hELElBQUk7WUFDQSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRTNCOzs7ZUFHRztZQUVILE1BQU0sZUFBZSxHQUFHLElBQUksK0NBQXNCLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2pGLE1BQU0sYUFBYSxHQUFHLElBQUksb0NBQW9CLEVBQUUsQ0FBQztZQUNqRCxNQUFNLGNBQWMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVksRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLGFBQWEsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUVuRyx1QkFBdUI7WUFDdkIsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxFQUFFLGVBQWUsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFekcsc0RBQXNEO1lBRXREOztlQUVHO1lBQ0gsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzFFLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxDQUFDO1lBQzVELE1BQU0sY0FBYyxtQ0FBTyxhQUFhLEdBQUssZUFBZSxDQUFDLENBQUM7WUFFOUQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2hFLEdBQUcsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLGVBQWUsR0FBRyxDQUFDLENBQUM7WUFFakQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDakYsR0FBRyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO1lBRXBELElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUMsY0FBYyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsZUFBZSxDQUFDO1lBQzdILElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsaUJBQWlCLENBQUM7WUFFakksOERBQThEO1lBQzlELElBQUksSUFBSSxDQUFDLHNCQUFzQixFQUFDO2dCQUM1QixnREFBdUIsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDcEY7WUFDRCxPQUFPLFFBQVEsQ0FBQztTQUNuQjtRQUNELE9BQU8sS0FBSyxFQUFFO1lBQ1YsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLG1CQUFtQixFQUFFO2dCQUN6QyxJQUFJLENBQUMsY0FBYyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsS0FBSyxFQUFFLFlBQVksQ0FBQyxlQUFlLENBQUMsQ0FBQzthQUNuRztZQUVELHVDQUFZLFlBQVksQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLEtBQUUsWUFBWSxFQUFFLElBQUksSUFBRztTQUNoRjtJQUNMLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILGFBQWE7O1FBQ1QsTUFBTSxXQUFXLFNBQUcsSUFBSSxDQUFDLFdBQVcsbUNBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsRixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDbEIsOEJBQWEsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLEdBQUcsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuRCxPQUFPLFNBQVMsU0FBUyxFQUFFLENBQUM7SUFDaEMsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxXQUFxQixFQUFFLEtBQW9CLEVBQUUsYUFBb0MsRUFBRSxXQUFXLEdBQUcsSUFBSTtRQUNoSSxHQUFHLENBQUMsSUFBSSxDQUFDLG1HQUFtRyxDQUFDLENBQUM7UUFDOUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEtBQUssQ0FBQyxVQUFVLFVBQVUsQ0FBQyxDQUFDO1FBQzdDLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSw4QkFBZSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsRixHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQix5REFBOEIsQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUU1RixJQUFJLFdBQVcsRUFBRTtZQUNiLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxXQUFXLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTdELElBQUksQ0FBQyxpQkFBaUIsRUFBRTtnQkFDcEIsR0FBRyxDQUFDLElBQUksQ0FBQyxnRUFBZ0UsQ0FBQyxDQUFDO2dCQUMzRSxHQUFHLENBQUMsSUFBSSxDQUFDLHdCQUF3Qix5REFBOEIsQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDbEcsT0FBTzthQUNWO1lBRUQsU0FBUztZQUNULE1BQU0sV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7U0FDbEQ7UUFFRCw0QkFBNEI7UUFDNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLGFBQWEsQ0FBQyxlQUFlLEtBQUssaUNBQWUsQ0FBQyxJQUFJLEVBQUU7WUFDN0YsTUFBTSxjQUFjLENBQUMsZUFBZSxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7U0FDM0U7UUFFRCx1R0FBdUc7UUFDdkcsMkdBQTJHO1FBRTNHLEdBQUcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLGFBQWEsRUFBRSxDQUFDLENBQUM7UUFDN0MsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IseURBQThCLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdEcsQ0FBQztJQUVPLE1BQU0sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLFdBQXFCLEVBQUUsS0FBb0IsRUFBRSxhQUFvQztRQUVsSCxHQUFHLENBQUMsS0FBSyxDQUFDLHNDQUFzQyx5REFBOEIsQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNqSCxNQUFNLGlCQUFpQixHQUFHLE1BQU0sV0FBVyxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JFLElBQUksaUJBQWlCLEVBQUU7WUFDbkIsTUFBTSxXQUFXLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQztZQUV2RCxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLEVBQUU7Z0JBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsd0ZBQXdGLENBQUMsQ0FBQzthQUM3RztTQUNKO2FBQ0k7WUFDRCxHQUFHLENBQUMsS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7U0FDbEU7UUFFRCxPQUFPO0lBQ1gsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztPQW9CRztJQUNJLEtBQUssQ0FBQyxjQUFjLENBQUMsWUFBMEIsRUFBRSxZQUFvQixFQUFFLGNBQXVCO1FBRWpHLElBQUksY0FBYyxLQUFLLFNBQVMsRUFBRTtZQUM5QixjQUFjLEdBQUcsWUFBWSxDQUFDO1NBQ2pDO1FBRUQ7O1dBRUc7UUFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3hELE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLEdBQUcsY0FBYyxDQUFDLGdDQUFnQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXJGLElBQUksUUFBUSxDQUFDLFlBQVksS0FBSyxTQUFTLEVBQUU7WUFDckMsUUFBUSxDQUFDLFlBQVksR0FBRyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDO1NBQ3JFO2FBQ0ksSUFBSSxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDNUMsUUFBUSxDQUFDLFlBQVksR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFVBQVUsWUFBWSxFQUFFLENBQUMsRUFBRSxDQUFDO1NBQ3ZHO2FBQ0k7WUFDRCxRQUFRLENBQUMsWUFBWSxHQUFHLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsWUFBWSxHQUFHLE1BQU0sRUFBRSxDQUFDO1NBQzlFO1FBRUQsSUFBSSxRQUFRLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRTtZQUNqQyxRQUFRLENBQUMsUUFBUSxHQUFHLEVBQUUsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEVBQUUsQ0FBQztTQUNyRjthQUNJLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUNyRCxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFVBQVUsY0FBYyxFQUFFLENBQUMsRUFBRSxDQUFDO1NBQ3BIO2FBQ0k7WUFDRCxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksR0FBRyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLGNBQWMsR0FBRyxRQUFRLEVBQUUsQ0FBQztTQUMzRjtRQUVELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxNQUFNLENBQUMsZ0NBQWdDLENBQUMsUUFBMEI7UUFDOUQsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLFlBQVksS0FBSyxTQUFTO1lBQzlDLENBQUMsQ0FBQyxFQUFFO1lBQ0osQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDO2dCQUNyQyxDQUFDLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQztnQkFDekUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDO1FBRXJDLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxRQUFRLEtBQUssU0FBUztZQUM1QyxDQUFDLENBQUMsRUFBRTtZQUNKLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxNQUFNLENBQUM7Z0JBQzlDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQztnQkFDbEYsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQztRQUM5QyxPQUFPLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFHTyxLQUFLLENBQUMsaUJBQWlCLENBQUMsTUFBc0IsRUFBRSxzQkFBOEMsRUFBRSxLQUFvQjtRQUN4SCxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUN4RSxNQUFNLFFBQVEsR0FBRyxzQkFBc0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN0RCxRQUFRLE1BQU0sQ0FBQyxlQUFlLEVBQUU7WUFDNUIsS0FBSyxpQ0FBZSxDQUFDLElBQUk7Z0JBQUUsUUFBUSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztnQkFBQyxNQUFNO1lBQ3BFLEtBQUssaUNBQWUsQ0FBQyxHQUFHO2dCQUFFLFFBQVEsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7Z0JBQUMsTUFBTTtZQUNsRSxLQUFLLGlDQUFlLENBQUMsSUFBSTtnQkFBRSxRQUFRLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDO2dCQUFDLE1BQU07WUFDeEUsT0FBTyxDQUFDLENBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDeEY7UUFFRCx1Q0FBWSxRQUFRLEtBQUUsWUFBWSxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxJQUFHO0lBQ3BFLENBQUM7SUFHRCxxQkFBcUI7SUFDZCw0QkFBNEI7UUFDL0IsT0FBTywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsV0FBWSxDQUFDLENBQUM7SUFDMUQsQ0FBQzs7QUExU0wsd0NBMlNDO0FBelNVLGlDQUFrQixHQUFHLGdCQUFnQixDQUFDO0FBQ3RDLG1DQUFvQixHQUFHLGtCQUFrQixDQUFDO0FBMFNyRDs7Ozs7R0FLRztBQUNILFNBQWdCLHdCQUF3QixDQUFDLE9BQWlCLEVBQUUsS0FBNkI7SUFDckYsSUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFO1FBQ3JCLE9BQU87S0FDVjtJQUNELE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEMsSUFBSSxPQUFPLEtBQUssU0FBUyxFQUFFO1FBQ3ZCLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUN6QztJQUVELElBQUksc0NBQWtCLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDN0IsS0FBSyxNQUFNLEtBQUssSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFO1lBQ2xDLHdCQUF3QixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMxQztLQUNKO0FBQ0wsQ0FBQztBQWRELDREQWNDO0FBRUQ7Ozs7R0FJRztBQUNILFNBQWdCLDJCQUEyQixDQUFDLFdBQXFCO0lBQzdELE1BQU0sUUFBUSxHQUFRLEVBQUUsQ0FBQztJQUN6QixnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDeEMsT0FBTyxRQUFRLENBQUM7QUFDcEIsQ0FBQztBQUpELGtFQUlDO0FBR0QsU0FBUyxnQkFBZ0IsQ0FBQyxPQUFpQixFQUFFLEtBQVU7SUFDbkQsSUFBSSxnQkFBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQzFEO0lBQ0QsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUVuRCxJQUFJLHNDQUFrQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzdCLEtBQUssTUFBTSxLQUFLLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtZQUNsQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDbEM7S0FDSjtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMjAgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBIYW5kbGVySW5wdXQsIFJlcXVlc3RIYW5kbGVyIH0gZnJvbSBcImFzay1zZGstY29yZVwiO1xuaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tIFwiYXNrLXNkay1tb2RlbFwiO1xuaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgQ29udHJvbElucHV0IH0gZnJvbSAnLi4vY29udHJvbHMvQ29udHJvbElucHV0JztcbmltcG9ydCB7IENvbnRyb2xSZXN1bHRCdWlsZGVyIH0gZnJvbSAnLi4vY29udHJvbHMvQ29udHJvbFJlc3VsdCc7XG5pbXBvcnQgeyBpc0NvbnRhaW5lckNvbnRyb2wgfSBmcm9tICcuLi9jb250cm9scy9pbnRlcmZhY2VzL0lDb250YWluZXJDb250cm9sJztcbmltcG9ydCB7IElDb250cm9sIH0gZnJvbSAnLi4vY29udHJvbHMvaW50ZXJmYWNlcy9JQ29udHJvbCc7XG5pbXBvcnQgeyBJQ29udHJvbElucHV0IH0gZnJvbSAnLi4vY29udHJvbHMvaW50ZXJmYWNlcy9JQ29udHJvbElucHV0JztcbmltcG9ydCB7IElDb250cm9sTWFuYWdlciB9IGZyb20gJy4uL2NvbnRyb2xzL2ludGVyZmFjZXMvSUNvbnRyb2xNYW5hZ2VyJztcbmltcG9ydCB7IElDb250cm9sUmVzdWx0IH0gZnJvbSAnLi4vY29udHJvbHMvaW50ZXJmYWNlcy9JQ29udHJvbFJlc3VsdCc7XG5pbXBvcnQgeyBJQ29udHJvbFJlc3VsdEJ1aWxkZXIgfSBmcm9tICcuLi9jb250cm9scy9pbnRlcmZhY2VzL0lDb250cm9sUmVzdWx0QnVpbGRlcic7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnaW5nL0xvZ2dlcic7XG5pbXBvcnQgeyBDb250cm9sUmVzcG9uc2VCdWlsZGVyIH0gZnJvbSAnLi4vcmVzcG9uc2VHZW5lcmF0aW9uL0NvbnRyb2xSZXNwb25zZUJ1aWxkZXInO1xuaW1wb3J0IHsgZ2VuZXJhdGVDb250cm9sVHJlZVRleHREaWFncmFtIH0gZnJvbSAnLi4vdXRpbHMvQ29udHJvbFRyZWVWaXN1YWxpemF0aW9uJztcbmltcG9ydCB7IHZpc2l0Q29udHJvbHMgfSBmcm9tICcuLi91dGlscy9Db250cm9sVmlzaXRvcic7XG5pbXBvcnQgeyByZXF1ZXN0VG9TdHJpbmcgfSBmcm9tICcuLi91dGlscy9SZXF1ZXN0VXRpbHMnO1xuaW1wb3J0IHsgdmFsaWRhdGVTZXJpYWxpemVkU3RhdGUgfSBmcm9tICcuLi91dGlscy9TZXJpYWxpemF0aW9uVmFsaWRhdG9yJztcbmltcG9ydCB7IFNlc3Npb25CZWhhdmlvciB9IGZyb20gJy4vU2Vzc2lvbkJlaGF2aW9yJztcblxuY29uc3QgbG9nID0gbmV3IExvZ2dlcignQXNrU2RrQ29udHJvbHM6Q29udHJvbEhhbmRsZXInKTtcblxuLyoqXG4gKiBTZXNzaW9uIGNvbnRleHQgaW5mb3JtYXRpb24gaW4gYWRkaXRpb24gdG8gdGhhdCBwcm92aWRlZCBieSBBbGV4YSBTZXJ2aWNlLlxuICovXG5jbGFzcyBBZGRpdGlvbmFsU2Vzc2lvbkNvbnRleHQge1xuICAgIHR1cm5OdW1iZXI6IG51bWJlciA9IDA7XG59XG5cbi8qKlxuICogRXh0ZW5kZWQgUmVzcG9uc2UsIHN1cmZhY2luZyBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbnRyb2xSZXNwb25zZSBleHRlbmRzIFJlc3BvbnNlIHtcbiAgICBpc1R1cm5FbmRpbmc6IGJvb2xlYW47XG59XG5cbi8qKlxuICogUmVxdWVzdEhhbmRsZXIgZm9yIGEgc2tpbGwgYnVpbHQgdXNpbmcgQ29udHJvbHMuXG4gKlxuICogVGhpcyBpcyB0aGUgY29tbW9uIHJ1bnRpbWUgdGhhdCBkcml2ZXMgdGhlIHByb2Nlc3NpbmcgZmxvdyBmb3IgYSBza2lsbCB0aGF0XG4gKiB1c2VzIENvbnRyb2xzLiAgUGxlYXNlIHNlZSB0aGUgdXNlciBndWlkZSBmb3IgYSB0aG9yb3VnaCBkaXNjdXNzaW9uIG9mIHRoZVxuICogcGhhc2VzIG9mIHByb2Nlc3NpbmcgYW5kIGhvdyB0aGUgY29tbW9uIGBDb250cm9sSGFuZGxlcmAgaW50ZXJmYWNlcyB3aXRoXG4gKiBhbiBpbnN0YW5jZSBvZiBgQ29udHJvbE1hbmFnZXJgIGFuZCB0aGUgY29udHJvbCB0cmVlLlxuICpcbiAqL1xuZXhwb3J0IGNsYXNzIENvbnRyb2xIYW5kbGVyIGltcGxlbWVudHMgUmVxdWVzdEhhbmRsZXIge1xuXG4gICAgc3RhdGljIGF0dHJpYnV0ZU5hbWVTdGF0ZSA9IFwiX19jb250cm9sU3RhdGVcIjtcbiAgICBzdGF0aWMgYXR0cmlidXRlTmFtZUNvbnRleHQgPSBcIl9fY29udHJvbENvbnRleHRcIjtcblxuICAgIGNvbnRyb2xNYW5hZ2VyOiBJQ29udHJvbE1hbmFnZXI7XG4gICAgcm9vdENvbnRyb2w/OiBJQ29udHJvbDtcblxuICAgIHByaXZhdGUgYWRkaXRpb25hbFNlc3Npb25Db250ZXh0OiBBZGRpdGlvbmFsU2Vzc2lvbkNvbnRleHQ7XG4gICAgcHJpdmF0ZSBjb250cm9sSW5wdXQ6IElDb250cm9sSW5wdXQ7XG5cbiAgICBwcml2YXRlIHByZXBhcmVkUmVxdWVzdElkOiBzdHJpbmc7XG5cblxuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgaWYgdGhlIGNvbnRyb2xzIHN0YXRlIHdpbGwgYmUgY29ycmVjdGx5IHJlZXN0YWJsaXNoZWQgb24gdGhlXG4gICAgICogbmV4dCB0dXJuXG4gICAgICpcbiAgICAgKiBVc2FnZTpcbiAgICAgKiAgKiBJZiBhIHNraWxsIHVzZXMgbW9yZSB0aGFuIG9uZSBDb250cm9sSGFuZGxlciB0aGUgc3RhdGUgdmFsaWRhdGlvblxuICAgICAqICAgIHByb2NlZHVyZSBnZXRzIGNvbmZ1c2VkIGR1ZSB0byB1bmV4cGVjdGVkIGNvbnRyb2wgc3RhdGVzIGluIHNlc3Npb25cbiAgICAgKiAgICBhdHRyaWJ1dGVzLiBJbiB0aGlzIHNpdHVhdGlvbiwgc2V0IGB2YWxpZGF0ZVN0YXRlUm91bmR0cmlwID0gZmFsc2VgLlxuICAgICAqL1xuICAgIHZhbGlkYXRlU3RhdGVSb3VuZHRyaXAgPSB0cnVlOyAgLy8gVE9ETyBpbXByb3ZlIHRoZSB2YWxpZGF0aW9uIHRlc3RpbmcgYW5kIHJlbW92ZSB0aGlzXG5cbiAgICBjb25zdHJ1Y3Rvcihjb250cm9sTWFuYWdlcjogSUNvbnRyb2xNYW5hZ2VyKSB7XG4gICAgICAgIHRoaXMuY29udHJvbE1hbmFnZXIgPSBjb250cm9sTWFuYWdlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByZXBhcmUoaGFuZGxlcklucHV0OiBIYW5kbGVySW5wdXQpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMucHJlcGFyZWRSZXF1ZXN0SWQgPT09IGhhbmRsZXJJbnB1dC5yZXF1ZXN0RW52ZWxvcGUucmVxdWVzdC5yZXF1ZXN0SWQpIHtcbiAgICAgICAgICAgIHJldHVybjsgLy8gZG9uJ3QgcHJlcGFyZSBhZ2FpbiBmb3IgdGhlIHNhbWUgcmVxdWVzdElkLlxuICAgICAgICB9XG4gICAgICAgIHRoaXMucHJlcGFyZWRSZXF1ZXN0SWQgPSBoYW5kbGVySW5wdXQucmVxdWVzdEVudmVsb3BlLnJlcXVlc3QucmVxdWVzdElkO1xuXG4gICAgICAgIC8vIHJldHJpZXZlIGFuZCB1cGRhdGUgdGhlIGNvbnRleHQgb2JqZWN0LlxuICAgICAgICBjb25zdCByZXRyaWV2ZWRDb250ZXh0ID0gaGFuZGxlcklucHV0LmF0dHJpYnV0ZXNNYW5hZ2VyLmdldFNlc3Npb25BdHRyaWJ1dGVzKClbQ29udHJvbEhhbmRsZXIuYXR0cmlidXRlTmFtZUNvbnRleHRdO1xuICAgICAgICB0aGlzLmFkZGl0aW9uYWxTZXNzaW9uQ29udGV4dCA9IHJldHJpZXZlZENvbnRleHQgIT09IHVuZGVmaW5lZCA/IEpTT04ucGFyc2UocmV0cmlldmVkQ29udGV4dCkgOiBuZXcgQWRkaXRpb25hbFNlc3Npb25Db250ZXh0KCk7XG4gICAgICAgIHRoaXMuYWRkaXRpb25hbFNlc3Npb25Db250ZXh0LnR1cm5OdW1iZXIgKz0gMTtcblxuICAgICAgICAvLyByZXRyaWV2ZSB0aGUgY29udHJvbCBzdGF0ZVxuICAgICAgICBjb25zdCBzdGF0ZU1hcCA9IHRoaXMuZ2V0U3RhdGVNYXBGcm9tU2Vzc2lvbkF0dHJpYnV0ZXMoaGFuZGxlcklucHV0KTtcblxuXG4gICAgICAgIC8vIGJ1aWxkIHRoZSBjb250cm9sIHRyZWUgYW5kIGF0dGFjaCBzdGF0ZVxuICAgICAgICB0aGlzLnJvb3RDb250cm9sID0gdGhpcy5jb250cm9sTWFuYWdlci5jcmVhdGVDb250cm9sVHJlZShzdGF0ZU1hcCk7XG4gICAgICAgIGF0dGFjaFN0YXRlVG9Db250cm9sVHJlZSh0aGlzLnJvb3RDb250cm9sLCBzdGF0ZU1hcCk7XG5cbiAgICAgICAgLy8gY3JlYXRlIHRoZSBpbnB1dCBvYmplY3QgZm9yIHVzZSBpbiB0aGUgbWFpbiBwcm9jZXNzaW5nLlxuICAgICAgICBjb25zdCBjb250cm9scyA9IENvbnRyb2xIYW5kbGVyLmNyZWF0ZUNvbnRyb2xNYXAodGhpcy5yb290Q29udHJvbCwge30pO1xuICAgICAgICB0aGlzLmNvbnRyb2xJbnB1dCA9IG5ldyBDb250cm9sSW5wdXQoaGFuZGxlcklucHV0LCB0aGlzLmFkZGl0aW9uYWxTZXNzaW9uQ29udGV4dC50dXJuTnVtYmVyLCBjb250cm9scyk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIGdldFN0YXRlTWFwRnJvbVNlc3Npb25BdHRyaWJ1dGVzKGhhbmRsZXJJbnB1dDogSGFuZGxlcklucHV0KSB7XG4gICAgICAgIGNvbnN0IHJldHJpZXZlZFN0YXRlSlNPTiA9IGhhbmRsZXJJbnB1dC5hdHRyaWJ1dGVzTWFuYWdlci5nZXRTZXNzaW9uQXR0cmlidXRlcygpW0NvbnRyb2xIYW5kbGVyLmF0dHJpYnV0ZU5hbWVTdGF0ZV07XG4gICAgICAgIGNvbnN0IHN0YXRlTWFwID0gcmV0cmlldmVkU3RhdGVKU09OICE9PSB1bmRlZmluZWQgPyBKU09OLnBhcnNlKHJldHJpZXZlZFN0YXRlSlNPTikgOiB7fTtcbiAgICAgICAgcmV0dXJuIHN0YXRlTWFwO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZUNvbnRyb2xNYXAoY29udHJvbDogSUNvbnRyb2wsIG1hcEFjYzogeyBbaW5kZXg6IHN0cmluZ106IElDb250cm9sIH0pOiB7IFtpbmRleDogc3RyaW5nXTogSUNvbnRyb2wgfSB7XG4gICAgICAgIG1hcEFjY1tjb250cm9sLmlkXSA9IGNvbnRyb2w7XG4gICAgICAgIGlmIChpc0NvbnRhaW5lckNvbnRyb2woY29udHJvbCkpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgKGNvbnRyb2wgYXMgYW55KS5jaGlsZHJlbikge1xuICAgICAgICAgICAgICAgIENvbnRyb2xIYW5kbGVyLmNyZWF0ZUNvbnRyb2xNYXAoY2hpbGQsIG1hcEFjYyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1hcEFjYzsgLy8gcmV0dXJuaW5nIHRoZSBhY2N1bXVsYXRvciBhbGxvd3MgdGhlIGNhbGwtc2l0ZSB0byBiZSBtb3JlIHJlYWRhYmxlXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGV0ZXJtaW5lcyBpZiB0aGlzIFJlcXVlc3RIYW5kbGVyIGhhbmRsZSB0aGUgaW5wdXQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaGFuZGxlcklucHV0IC0gSGFuZGxlcklucHV0XG4gICAgICovXG4gICAgYXN5bmMgY2FuSGFuZGxlKGhhbmRsZXJJbnB1dDogSGFuZGxlcklucHV0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLnByZXBhcmUoaGFuZGxlcklucHV0KTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJvb3RDb250cm9sIS5jYW5IYW5kbGUodGhpcy5jb250cm9sSW5wdXQpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKHRoaXMuY29udHJvbE1hbmFnZXIuaGFuZGxlSW50ZXJuYWxFcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbE1hbmFnZXIuaGFuZGxlSW50ZXJuYWxFcnJvcih0aGlzLmNvbnRyb2xJbnB1dCwgZXJyb3IsIGhhbmRsZXJJbnB1dC5yZXNwb25zZUJ1aWxkZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7IC8vIHJldGhyb3cgc28gdG9wLWxldmVsIG9ic2VydmVzIGl0IHRvby5cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhhbmRsZSB0aGUgaW5wdXQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaGFuZGxlcklucHV0IC0gSGFuZGxlcklucHV0XG4gICAgICovXG4gICAgYXN5bmMgaGFuZGxlKGhhbmRsZXJJbnB1dDogSGFuZGxlcklucHV0LCBwcm9jZXNzSW5wdXQgPSB0cnVlKTogUHJvbWlzZTxJQ29udHJvbFJlc3BvbnNlPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLnByZXBhcmUoaGFuZGxlcklucHV0KTtcblxuICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAqIFByb2Nlc3MgdGhlIHR1cm4gdGhyb3VnaCB0aGUgYXBwbGljYXRpb24uXG4gICAgICAgICAgICAgKiBEbyB0aGUgd29yayAoc3RhdGUgdXBkYXRlcyBhbmQgZGlhbG9nIHBvbGljeSlcbiAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUJ1aWxkZXIgPSBuZXcgQ29udHJvbFJlc3BvbnNlQnVpbGRlcihoYW5kbGVySW5wdXQucmVzcG9uc2VCdWlsZGVyKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdEJ1aWxkZXIgPSBuZXcgQ29udHJvbFJlc3VsdEJ1aWxkZXIoKTtcbiAgICAgICAgICAgIGF3YWl0IENvbnRyb2xIYW5kbGVyLmhhbmRsZUNvcmUodGhpcy5yb290Q29udHJvbCEsIHRoaXMuY29udHJvbElucHV0LCByZXN1bHRCdWlsZGVyLCBwcm9jZXNzSW5wdXQpO1xuXG4gICAgICAgICAgICAvLyBDb21wb3NlIHRoZSByZXNwb25zZVxuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmJ1aWxkUmVzcG9uc2VDb3JlKHJlc3VsdEJ1aWxkZXIuYnVpbGQoKSwgcmVzcG9uc2VCdWlsZGVyLCB0aGlzLmNvbnRyb2xJbnB1dCk7XG5cbiAgICAgICAgICAgIC8vIENvbGxhdGUgdGhlIENvbnRyb2wgc3RhdGUgb2JqZWN0cyBmb3Igc2VyaWFsaXphdGlvblxuXG4gICAgICAgICAgICAvKiBOb3RlOiB3ZSBtZXJnZSBvbnRvIHRoZSBwcmV2YWlsaW5nIHN0YXRlIGZvciB0aGUgZWRnZS1jYXNlIG9mIG11bHRpcGxlIENvbnRyb2xIYW5kbGVycyBpbiB0aGUgc2tpbGwgdGhhdCBhcmUgYWN0aXZlIG9uIGRpZmZlcmVudCB0dXJucy5cbiAgICAgICAgICAgICAqICAgICAgIG1lcmdpbmcgYXZvaWQgb25lIGNvbnRyb2xIYW5kbGVyIHN0b21waW5nIG9uIHRoZSBzdGF0ZSBvZiB0aGUgb3RoZXIuICBDb250ZXh0IGlzIGN1cnJlbnRseSBPSy9nb29kIHRvIGJlIHN0b21wZWQgb24uXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGNvbnN0IHByaW9yU3RhdGVNYXAgPSB0aGlzLmdldFN0YXRlTWFwRnJvbVNlc3Npb25BdHRyaWJ1dGVzKGhhbmRsZXJJbnB1dCk7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50U3RhdGVNYXAgPSB0aGlzLmdldFNlcmlhbGl6YWJsZUNvbnRyb2xTdGF0ZXMoKTtcbiAgICAgICAgICAgIGNvbnN0IG1lcmdlZFN0YXRlTWFwID0gey4uLnByaW9yU3RhdGVNYXAsIC4uLmN1cnJlbnRTdGF0ZU1hcH07XG5cbiAgICAgICAgICAgIGNvbnN0IHN0YXRlVG9TYXZlSnNvbiA9IEpTT04uc3RyaW5naWZ5KG1lcmdlZFN0YXRlTWFwLCBudWxsLCAyKTtcbiAgICAgICAgICAgIGxvZy5pbmZvKGBTYXZpbmcgc3RhdGUuLi5cXG4ke3N0YXRlVG9TYXZlSnNvbn0gYCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbnRleHRUb1NhdmVKc29uID0gSlNPTi5zdHJpbmdpZnkodGhpcy5hZGRpdGlvbmFsU2Vzc2lvbkNvbnRleHQsIG51bGwsIDIpO1xuICAgICAgICAgICAgbG9nLmluZm8oYFNhdmluZyBjb250ZXh0Li4uXFxuJHtjb250ZXh0VG9TYXZlSnNvbn1gKTtcblxuICAgICAgICAgICAgdGhpcy5jb250cm9sSW5wdXQuaGFuZGxlcklucHV0LmF0dHJpYnV0ZXNNYW5hZ2VyLmdldFNlc3Npb25BdHRyaWJ1dGVzKClbQ29udHJvbEhhbmRsZXIuYXR0cmlidXRlTmFtZVN0YXRlXSA9IHN0YXRlVG9TYXZlSnNvbjtcbiAgICAgICAgICAgIHRoaXMuY29udHJvbElucHV0LmhhbmRsZXJJbnB1dC5hdHRyaWJ1dGVzTWFuYWdlci5nZXRTZXNzaW9uQXR0cmlidXRlcygpW0NvbnRyb2xIYW5kbGVyLmF0dHJpYnV0ZU5hbWVDb250ZXh0XSA9IGNvbnRleHRUb1NhdmVKc29uO1xuXG4gICAgICAgICAgICAvLyBDaGVjayB0aGF0IHRoZSBzZXJpYWxpemVkIHN0YXRlIHdpbGwgc3Vydml2ZSB0aGUgcm91bmQgdHJpcFxuICAgICAgICAgICAgaWYgKHRoaXMudmFsaWRhdGVTdGF0ZVJvdW5kdHJpcCl7XG4gICAgICAgICAgICAgICAgdmFsaWRhdGVTZXJpYWxpemVkU3RhdGUoc3RhdGVUb1NhdmVKc29uLCB0aGlzLmNvbnRyb2xNYW5hZ2VyLCB0aGlzLmNvbnRyb2xJbnB1dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jb250cm9sTWFuYWdlci5oYW5kbGVJbnRlcm5hbEVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sTWFuYWdlci5oYW5kbGVJbnRlcm5hbEVycm9yKHRoaXMuY29udHJvbElucHV0LCBlcnJvciwgaGFuZGxlcklucHV0LnJlc3BvbnNlQnVpbGRlcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7IC4uLmhhbmRsZXJJbnB1dC5yZXNwb25zZUJ1aWxkZXIuZ2V0UmVzcG9uc2UoKSwgaXNUdXJuRW5kaW5nOiB0cnVlIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgc3RyaW5nICdDOjxuQ29udHJvbHM+JyBmb3IgaW5jbHVzaW9uIGluIFVzZXJBZ2VudCB0byBpbmRpY2F0ZSB1c2FnZS5cbiAgICAgKlxuICAgICAqIFRoZSBpbmZvcm1hdGlvbiBnYXRoZXJlZCBpcyBvbmx5IHRoZSBudW1iZXIgb2YgQ29udHJvbHMgYmVpbmcgdXNlZC5cbiAgICAgKiBUaGlzIHdpbGwgaGVscCB0aGUgZGV2IHRlYW0gdG8gdW5kZXJzdGFuZCB1c2FnZSAtIHRoYW5rIHlvdSFcbiAgICAgKi9cbiAgICB1c2VyQWdlbnRJbmZvKCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHJvb3RDb250cm9sID0gdGhpcy5yb290Q29udHJvbCA/PyB0aGlzLmNvbnRyb2xNYW5hZ2VyLmNyZWF0ZUNvbnRyb2xUcmVlKHt9KTtcbiAgICAgICAgbGV0IG5Db250cm9scyA9IDA7XG4gICAgICAgIHZpc2l0Q29udHJvbHMocm9vdENvbnRyb2wsICgpID0+IHsgbkNvbnRyb2xzKys7IH0pO1xuICAgICAgICByZXR1cm4gYG5DdHJsOiR7bkNvbnRyb2xzfWA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50cyB0aGUgY29yZSBvZiB0aGUgcHJvY2Vzc2luZyBsb29wXG4gICAgICpcbiAgICAgKiBQdWJsaWMgZm9yIHRlc3RpbmdcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGhhbmRsZUNvcmUocm9vdENvbnRyb2w6IElDb250cm9sLCBpbnB1dDogSUNvbnRyb2xJbnB1dCwgcmVzdWx0QnVpbGRlcjogSUNvbnRyb2xSZXN1bHRCdWlsZGVyLCBoYW5kbGVJbnB1dCA9IHRydWUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgbG9nLmluZm8oXCItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXCIpO1xuICAgICAgICBsb2cuaW5mbyhgVHVybiAke2lucHV0LnR1cm5OdW1iZXJ9IHN0YXJ0ZWRgKTtcbiAgICAgICAgbG9nLmluZm8oYElucHV0OiAke3JlcXVlc3RUb1N0cmluZyhpbnB1dC5oYW5kbGVySW5wdXQucmVxdWVzdEVudmVsb3BlLnJlcXVlc3QpfWApO1xuICAgICAgICBsb2cuaW5mbyhgVUkgYXQgc3RhcnQ6IFxcbiR7Z2VuZXJhdGVDb250cm9sVHJlZVRleHREaWFncmFtKHJvb3RDb250cm9sLCBpbnB1dC50dXJuTnVtYmVyKX1gKTtcblxuICAgICAgICBpZiAoaGFuZGxlSW5wdXQpIHtcbiAgICAgICAgICAgIGNvbnN0IGNhbkhhbmRsZVJlc3BvbnNlID0gYXdhaXQgcm9vdENvbnRyb2wuY2FuSGFuZGxlKGlucHV0KTtcblxuICAgICAgICAgICAgaWYgKCFjYW5IYW5kbGVSZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGxvZy53YXJuKFwiICpXQVJOKiByb290Q29udHJvbCByZXR1cm5lZCBjYW5IYW5kbGU9ZmFsc2UuICBDbG9zaW5nIHNlc3Npb25cIik7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oYFVJIGF0IGVuZCBvZiB0dXJuOiBcXG4ke2dlbmVyYXRlQ29udHJvbFRyZWVUZXh0RGlhZ3JhbShyb290Q29udHJvbCwgaW5wdXQudHVybk51bWJlcil9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBIQU5ETEVcbiAgICAgICAgICAgIGF3YWl0IHJvb3RDb250cm9sLmhhbmRsZShpbnB1dCwgcmVzdWx0QnVpbGRlcik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBPcHRpb25hbCBJTklUSUFUSVZFIFBIQVNFXG4gICAgICAgIGlmICghcmVzdWx0QnVpbGRlci5oYXNJbml0aWF0aXZlQWN0KCkgJiYgcmVzdWx0QnVpbGRlci5zZXNzaW9uQmVoYXZpb3IgPT09IFNlc3Npb25CZWhhdmlvci5PUEVOKSB7XG4gICAgICAgICAgICBhd2FpdCBDb250cm9sSGFuZGxlci5pbml0aWF0aXZlUGhhc2Uocm9vdENvbnRyb2wsIGlucHV0LCByZXN1bHRCdWlsZGVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE86IHRyYWNrIHRoZSBzcGVjaWZpYyBjb250cm9sSUQgdGhhdCBnZW5lcmF0ZWQgdGhlIGluaXRpYXRpdmUuIG1ha2UgaXQgYXZhaWxhYmxlIHNvIHRoYXQgY29udHJvbHNcbiAgICAgICAgLy8gY2FuIHVzZSBhIGhhc0luaXRpYXRpdmUoKSBwcmVkaWNhdGUgYW5kIHJlYXNvbiBhYm91dCB3aGV0aGVyIHRoZXkgYXJlIGFjdGl2ZWx5IHJ1bm5pbmcgdGhlIGNvbnZlcnNhdGlvbi5cblxuICAgICAgICBsb2cuaW5mbyhgSGFuZGxlUmVzcG9uc2U6ICR7cmVzdWx0QnVpbGRlcn1gKTtcbiAgICAgICAgbG9nLmluZm8oYFVJIGF0IGVuZCBvZiB0dXJuOiBcXG4ke2dlbmVyYXRlQ29udHJvbFRyZWVUZXh0RGlhZ3JhbShyb290Q29udHJvbCwgaW5wdXQudHVybk51bWJlcil9YCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgaW5pdGlhdGl2ZVBoYXNlKHJvb3RDb250cm9sOiBJQ29udHJvbCwgaW5wdXQ6IElDb250cm9sSW5wdXQsIHJlc3VsdEJ1aWxkZXI6IElDb250cm9sUmVzdWx0QnVpbGRlcik6IFByb21pc2U8dm9pZD4ge1xuXG4gICAgICAgIGxvZy5kZWJ1ZyhgVUkgYXQgc3RhcnQgb2YgaW5pdGlhdGl2ZSBwaGFzZTogXFxuJHtnZW5lcmF0ZUNvbnRyb2xUcmVlVGV4dERpYWdyYW0ocm9vdENvbnRyb2wsIGlucHV0LnR1cm5OdW1iZXIpfWApO1xuICAgICAgICBjb25zdCBjYW5UYWtlSW5pdGlhdGl2ZSA9IGF3YWl0IHJvb3RDb250cm9sLmNhblRha2VJbml0aWF0aXZlKGlucHV0KTtcbiAgICAgICAgaWYgKGNhblRha2VJbml0aWF0aXZlKSB7XG4gICAgICAgICAgICBhd2FpdCByb290Q29udHJvbC50YWtlSW5pdGlhdGl2ZShpbnB1dCwgcmVzdWx0QnVpbGRlcik7XG5cbiAgICAgICAgICAgIGlmICghcmVzdWx0QnVpbGRlci5oYXNJbml0aWF0aXZlQWN0KCkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJTb21ldGhpbmcgcmVzcG9uZGVkIHdpdGggYGNhblRha2VJbml0aWF0aXZlPXRydWVgIGJ1dCBubyBpbml0aWF0aXZlIGl0ZW0gd2FzIHByb2R1Y2VkLlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIkVuZCBvZiBoYW5kbGU6IG5vdGhpbmcgd2FudGVkIHRvIHRha2UgaW5pdGlhdGl2ZS5cIik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGFrZSB0aGUgaW5pdGlhdGl2ZSBpbiB0aGUgZGlhbG9nLlxuICAgICAqXG4gICAgICogQW55IGV4aXN0aW5nIGNvbnRlbnQgaW4gdGhlIFJlc3BvbnNlJ3MgcHJvbXB0ICYgcmVwcm9tcHQgaXMgb3ZlcndyaXR0ZW4uXG4gICAgICogVG8gYXZvaWQgbG9zaW5nIHRoaXMgY29udGVudCwgcGFzcyBpdCBpbiB1c2luZyBwYXJhbWV0ZXJzIHByb21wdFByZWZpeCAmXG4gICAgICogcmVwcm9tcHRQcmVmaXguXG4gICAgICpcbiAgICAgKiBVc2FnZTpcbiAgICAgKiAgKiBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIHRyYW5zaXRpb24gZnJvbSBhIHJlZ3VsYXIgYFJlcXVlc3RIYW5kbGVyYCBpbnRvXG4gICAgICogICAgQ29udHJvbHMgRm9yIGV4YW1wbGUsIHdoZW4gYSByZWd1bGFyIGBSZXF1ZXN0SGFuZGxlcmAgY29uc3VtZXMgdGhlXG4gICAgICogICAgaW5wdXQgYnV0IGRvZXNuJ3Qgd2FudCB0byBrZWVwIHRoZSBpbml0aWF0aXZlLCBpdCBjYW4gYXNrIGFcbiAgICAgKiAgICBDb250cm9sSGFuZGxlciB0byB0YWtlIHRoZSBpbml0aWF0aXZlIHRvIGNvbXBsZXRlIHRoZSB0dXJuLiAgQVxuICAgICAqICAgIHByb21wdC9yZXByb21wdCBmcmFnbWVudCBjYW4gYmUgc3BlY2lmaWVkIGJ5IHRoZSBgUmVxdWVzdEhhbmRsZXJgXG4gICAgICogICAgd2hpY2ggd2lsbCBiZSBpbmNsdWRlZCBhcyB0aGUgc3RhcnQgb2YgdGhlIG92ZXJhbGwgcHJvbXB0L3JlcHJvbXB0LlxuICAgICAqXG4gICAgICogQHBhcmFtIGhhbmRsZXJJbnB1dCAtIEhhbmRsZXIgaW5wdXRcbiAgICAgKiBAcGFyYW0gcHJvbXB0UHJlZml4IC0gUHJvbXB0IGZyYWdtZW50IHRvIHByZWZpeCB0aGUgcHJvbXB0IGdlbmVyYXRlZCB2aWFcbiAgICAgKiBDb250cm9scy5cbiAgICAgKiBAcGFyYW0gcmVwcm9tcHRQcmVmaXggLSBSZXByb21wdCBmcmFnbWVudCB0byBwcmVmaXggdG8gdGhlIHByb21wdFxuICAgICAqIGdlbmVyYXRlZCB2aWEgQ29udHJvbHNcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgdGFrZUluaXRpYXRpdmUoaGFuZGxlcklucHV0OiBIYW5kbGVySW5wdXQsIHByb21wdFByZWZpeDogc3RyaW5nLCByZXByb21wdFByZWZpeD86IHN0cmluZyk6IFByb21pc2U8SUNvbnRyb2xSZXNwb25zZT4ge1xuXG4gICAgICAgIGlmIChyZXByb21wdFByZWZpeCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXByb21wdFByZWZpeCA9IHByb21wdFByZWZpeDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qIE5PVEU6IHdlIGNhbGwgaGFuZGxlKC4uLCBmYWxzZSkgcmF0aGVyIHRoYW4gZGlyZWN0bHkgY2FsbGluZyBpbml0aWF0aXZlUGhhc2UoKSBhcyB3ZSBuZWVkIGFsbFxuICAgICAgICAgKiB0aGUgdXN1YWwgdHVybiBib29rLWtlZXBpbmcgKHByZXBhcmUsIGxvZ2dpbmcsIHN0YXRlIGxvYWRpbmcgJiBzYXZpbmcpIHRvIG9jY3VyXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuaGFuZGxlKGhhbmRsZXJJbnB1dCwgZmFsc2UpO1xuICAgICAgICBjb25zdCBbcHJvbXB0LCByZXByb21wdF0gPSBDb250cm9sSGFuZGxlci5nZXRQcm9tcHRBbmRSZXByb21wdEZyb21SZXNwb25zZShyZXNwb25zZSk7XG5cbiAgICAgICAgaWYgKHJlc3BvbnNlLm91dHB1dFNwZWVjaCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXNwb25zZS5vdXRwdXRTcGVlY2ggPSB7IHR5cGU6ICdQbGFpblRleHQnLCB0ZXh0OiBwcm9tcHRQcmVmaXggfTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChyZXNwb25zZS5vdXRwdXRTcGVlY2gudHlwZSA9PT0gJ1NTTUwnKSB7XG4gICAgICAgICAgICByZXNwb25zZS5vdXRwdXRTcGVlY2ggPSB7IHR5cGU6ICdTU01MJywgc3NtbDogcHJvbXB0LnJlcGxhY2UoJzxzcGVhaz4nLCBgPHNwZWFrPiR7cHJvbXB0UHJlZml4fWApIH07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXNwb25zZS5vdXRwdXRTcGVlY2ggPSB7IHR5cGU6ICdQbGFpblRleHQnLCB0ZXh0OiBwcm9tcHRQcmVmaXggKyBwcm9tcHQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXNwb25zZS5yZXByb21wdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXNwb25zZS5yZXByb21wdCA9IHsgb3V0cHV0U3BlZWNoOiB7IHR5cGU6ICdQbGFpblRleHQnLCB0ZXh0OiByZXByb21wdFByZWZpeCB9IH07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAocmVzcG9uc2UucmVwcm9tcHQub3V0cHV0U3BlZWNoLnR5cGUgPT09ICdTU01MJykge1xuICAgICAgICAgICAgcmVzcG9uc2UucmVwcm9tcHQub3V0cHV0U3BlZWNoID0geyB0eXBlOiAnU1NNTCcsIHNzbWw6IHJlcHJvbXB0LnJlcGxhY2UoJzxzcGVhaz4nLCBgPHNwZWFrPiR7cmVwcm9tcHRQcmVmaXh9YCkgfTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJlc3BvbnNlLnJlcHJvbXB0Lm91dHB1dFNwZWVjaCA9IHsgdHlwZTogJ1BsYWluVGV4dCcsIHRleHQ6IHJlcHJvbXB0UHJlZml4ICsgcmVwcm9tcHQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0UHJvbXB0QW5kUmVwcm9tcHRGcm9tUmVzcG9uc2UocmVzcG9uc2U6IElDb250cm9sUmVzcG9uc2UpOiBbc3RyaW5nLCBzdHJpbmddIHtcbiAgICAgICAgY29uc3QgcHJvbXB0ID0gcmVzcG9uc2Uub3V0cHV0U3BlZWNoID09PSB1bmRlZmluZWRcbiAgICAgICAgICAgID8gJydcbiAgICAgICAgICAgIDogKHJlc3BvbnNlLm91dHB1dFNwZWVjaC50eXBlID09PSAnU1NNTCcpXG4gICAgICAgICAgICAgICAgPyByZXNwb25zZS5vdXRwdXRTcGVlY2guc3NtbC5yZXBsYWNlKCc8c3NtbD4nLCAnJykucmVwbGFjZSgnPC9zc21sPicsICcnKVxuICAgICAgICAgICAgICAgIDogcmVzcG9uc2Uub3V0cHV0U3BlZWNoLnRleHQ7XG5cbiAgICAgICAgY29uc3QgcmVwcm9tcHQgPSByZXNwb25zZS5yZXByb21wdCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgICA/ICcnXG4gICAgICAgICAgICA6IChyZXNwb25zZS5yZXByb21wdC5vdXRwdXRTcGVlY2gudHlwZSA9PT0gJ1NTTUwnKVxuICAgICAgICAgICAgICAgID8gcmVzcG9uc2UucmVwcm9tcHQub3V0cHV0U3BlZWNoLnNzbWwucmVwbGFjZSgnPHNzbWw+JywgJycpLnJlcGxhY2UoJzwvc3NtbD4nLCAnJylcbiAgICAgICAgICAgICAgICA6IHJlc3BvbnNlLnJlcHJvbXB0Lm91dHB1dFNwZWVjaC50ZXh0O1xuICAgICAgICByZXR1cm4gW3Byb21wdCwgcmVwcm9tcHRdO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBhc3luYyBidWlsZFJlc3BvbnNlQ29yZShyZXN1bHQ6IElDb250cm9sUmVzdWx0LCBjb250cm9sUmVzcG9uc2VCdWlsZGVyOiBDb250cm9sUmVzcG9uc2VCdWlsZGVyLCBpbnB1dDogSUNvbnRyb2xJbnB1dCk6IFByb21pc2U8SUNvbnRyb2xSZXNwb25zZT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmNvbnRyb2xNYW5hZ2VyLnJlbmRlcihyZXN1bHQsIGlucHV0LCBjb250cm9sUmVzcG9uc2VCdWlsZGVyKTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBjb250cm9sUmVzcG9uc2VCdWlsZGVyLmdldFJlc3BvbnNlKCk7XG4gICAgICAgIHN3aXRjaCAocmVzdWx0LnNlc3Npb25CZWhhdmlvcikge1xuICAgICAgICAgICAgY2FzZSBTZXNzaW9uQmVoYXZpb3IuT1BFTjogcmVzcG9uc2Uuc2hvdWxkRW5kU2Vzc2lvbiA9IGZhbHNlOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgU2Vzc2lvbkJlaGF2aW9yLkVORDogcmVzcG9uc2Uuc2hvdWxkRW5kU2Vzc2lvbiA9IHRydWU7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBTZXNzaW9uQmVoYXZpb3IuSURMRTogcmVzcG9uc2Uuc2hvdWxkRW5kU2Vzc2lvbiA9IHVuZGVmaW5lZDsgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoYHVua25vd24gU2Vzc2lvbkJlaGF2aW9yIHZhbHVlOiAke0pTT04uc3RyaW5naWZ5KHJlc3VsdCl9YCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyAuLi5yZXNwb25zZSwgaXNUdXJuRW5kaW5nOiByZXN1bHQuaGFzSW5pdGlhdGl2ZUFjdCgpIH07XG4gICAgfVxuXG5cbiAgICAvLyBwdWJsaWMgZm9yIHRlc3RpbmdcbiAgICBwdWJsaWMgZ2V0U2VyaWFsaXphYmxlQ29udHJvbFN0YXRlcygpOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHtcbiAgICAgICAgcmV0dXJuIGV4dHJhY3RTdGF0ZUZyb21Db250cm9sVHJlZSh0aGlzLnJvb3RDb250cm9sISk7XG4gICAgfVxufVxuXG4vKipcbiAqIFZpc2l0cyBlYWNoIGNvbnRyb2wgaW4gdGhlIHRyZWUgYW5kIGF0dGFjaGVzIHRoZSBjb3JyZXNwb25kaW5nIHN0YXRlIG9iamVjdC5cbiAqXG4gKiBAcGFyYW0gY29udHJvbCAtIENvbnRyb2xcbiAqIEBwYXJhbSBzdGF0ZSAtIE1hcCBvZiBzdGF0ZSBkYXRhIHRvIGF0dGFjaCB0byB0aGUgY29udHJvbHNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaFN0YXRlVG9Db250cm9sVHJlZShjb250cm9sOiBJQ29udHJvbCwgc3RhdGU6IHsgW2tleTogc3RyaW5nXTogYW55IH0pIHtcbiAgICBpZiAoc3RhdGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG15U3RhdGUgPSBzdGF0ZVtjb250cm9sLmlkXTtcbiAgICBpZiAobXlTdGF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNvbnRyb2wuc2V0U2VyaWFsaXphYmxlU3RhdGUobXlTdGF0ZSk7XG4gICAgfVxuXG4gICAgaWYgKGlzQ29udGFpbmVyQ29udHJvbChjb250cm9sKSkge1xuICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIGNvbnRyb2wuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGF0dGFjaFN0YXRlVG9Db250cm9sVHJlZShjaGlsZCwgc3RhdGUpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIFZpc2l0cyBlYWNoIGNvbnRyb2xzIGFuZCBjb2xsYXRlcyB0aGUgc3RhdGUgb2JqZWN0cy5cbiAqXG4gKiBAcGFyYW0gcm9vdENvbnRyb2wgLSBSb290IGNvbnRyb2xcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3RTdGF0ZUZyb21Db250cm9sVHJlZShyb290Q29udHJvbDogSUNvbnRyb2wpOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHtcbiAgICBjb25zdCBzdGF0ZU9iajogYW55ID0ge307XG4gICAgZXh0cmFjdFN0YXRlQ29yZShyb290Q29udHJvbCwgc3RhdGVPYmopO1xuICAgIHJldHVybiBzdGF0ZU9iajtcbn1cblxuXG5mdW5jdGlvbiBleHRyYWN0U3RhdGVDb3JlKGNvbnRyb2w6IElDb250cm9sLCBzdGF0ZTogYW55KSB7XG4gICAgaWYgKF8uaGFzKHN0YXRlLCBjb250cm9sLmlkKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBjb250cm9sIGlkOiAke2NvbnRyb2wuaWR9YCk7XG4gICAgfVxuICAgIHN0YXRlW2NvbnRyb2wuaWRdID0gY29udHJvbC5nZXRTZXJpYWxpemFibGVTdGF0ZSgpO1xuXG4gICAgaWYgKGlzQ29udGFpbmVyQ29udHJvbChjb250cm9sKSkge1xuICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIGNvbnRyb2wuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGV4dHJhY3RTdGF0ZUNvcmUoY2hpbGQsIHN0YXRlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==