"use strict";
/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConjunctionControlIntent = exports.generateActionTaskPairs = exports.areConjunctionIntentSlotsValid = exports.hasOneOrMoreActions = exports.hasOneOrMoreTargets = exports.unpackConjunctionControlIntent = void 0;
const IntentUtils_1 = require("../utils/IntentUtils");
const ModelTypes_1 = require("../interactionModelGeneration/ModelTypes");
const BaseControlIntent_1 = require("./BaseControlIntent");
/**
 * Unpacks the complete intent object into a simpler representation.
 *
 * Note re "empty slots":
 * - Slots in the intent with no value appear in the intent object as "".
 *   However, these are unpacked as **`undefined`** to be more explicit and ease
 *   the implementation of predicates.
 * @param intent - Intent
 */
function unpackConjunctionControlIntent(intent) {
    if (!intent.name.startsWith('ConjunctionControlIntent')) {
        throw new Error(`Not a compatible intent : ${intent.name}`);
    }
    let feedback;
    let action;
    let target;
    let actionA;
    let targetA;
    let actionB;
    let targetB;
    for (const [name, slot] of Object.entries(intent.slots)) {
        const slotObject = IntentUtils_1.getSlotResolutions(slot);
        const slotValue = slotObject ? slotObject.slotValue : undefined;
        switch (name) {
            case 'feedback':
                feedback = slotValue;
                break;
            case 'action':
                action = slotValue;
                break;
            case 'target':
                target = slotValue;
                break;
            case 'action.a':
                actionA = slotValue;
                break;
            case 'target.a':
                targetA = slotValue;
                break;
            case 'action.b':
                actionB = slotValue;
                break;
            case 'target.b':
                targetB = slotValue;
                break;
            case 'head': break;
            case 'tail': break;
            case 'preposition': break;
            case 'conjunction': break;
            default: throw new Error('not handled');
        }
    }
    return {
        feedback,
        action,
        target,
        'action.a': actionA,
        'target.a': targetA,
        'action.b': actionB,
        'target.b': targetB,
    };
}
exports.unpackConjunctionControlIntent = unpackConjunctionControlIntent;
// TODO: refactor: move these to be members of the ConjunctionControlIntentSlots type
function hasOneOrMoreTargets(input) {
    if (!input) {
        return false;
    }
    if (input.target !== undefined || input['target.a'] !== undefined || input['target.b'] !== undefined) {
        return true;
    }
    return false;
}
exports.hasOneOrMoreTargets = hasOneOrMoreTargets;
function hasOneOrMoreActions(input) {
    if (!input) {
        return false;
    }
    if (input['action.a'] !== undefined || input['action.b'] !== undefined || input.action !== undefined) {
        return true;
    }
    return false;
}
exports.hasOneOrMoreActions = hasOneOrMoreActions;
function areConjunctionIntentSlotsValid(input) {
    if (!input) {
        return false;
    }
    // priorityRule, when action / target , no actionA, actionB, no targetA, targetB
    if (input.action !== undefined) {
        if (input["action.a"] !== undefined || input["action.b"] !== undefined) {
            return false;
        }
    }
    if (input.target !== undefined) {
        if (input['target.a'] !== undefined || input['target.b'] !== undefined) {
            return false;
        }
    }
    // pairRule, if .a exist, then .b must exist. Vice versa
    if ((input['action.a'] !== undefined && input['action.b'] === undefined) || (input['action.b'] !== undefined && input['action.a'] === undefined)) {
        return false;
    }
    if ((input['target.a'] !== undefined && input['target.b'] === undefined) || (input['target.b'] !== undefined && input['target.a'] === undefined)) {
        return false;
    }
    // when only one target, don't allow two action
    if (input.target !== undefined && input["action.a"] !== undefined && input["action.b"] !== undefined) {
        return false;
    }
    // only target is not allowed
    if (input.action === undefined && input["action.a"] === undefined) {
        return false;
    }
    return true;
}
exports.areConjunctionIntentSlotsValid = areConjunctionIntentSlotsValid;
function generateActionTaskPairs(input) {
    const inputs = [];
    const inputA = {
        action: '',
        target: '',
    };
    const inputB = {
        action: '',
        target: '',
    };
    if (hasOneOrMoreActions(input)) {
        // 1. Action exist
        if (input.action !== undefined) {
            inputA.action = input.action;
            inputB.action = input.action;
        }
        else { // two action
            inputA.action = input['action.a'];
            inputB.action = input['action.b'];
        }
        if (hasOneOrMoreTargets(input)) {
            // 1.1 Target exist
            if (input.target !== undefined) {
                inputA.target = input.target;
                inputB.target = input.target;
            }
            else {
                inputA.target = input['target.a'];
                inputB.target = input['target.b'];
            }
        }
    }
    // remove duplicate
    if (inputA.action === inputB.action && inputA.target === inputB.target) {
        inputs.push(inputA);
    }
    else {
        inputs.push(inputA);
        inputs.push(inputB);
    }
    return inputs;
}
exports.generateActionTaskPairs = generateActionTaskPairs;
/**
 * Intent that conveys feedback, up to two actions, and up two targets.
 *
 * This intent is a generalization of GeneralControlIntent that can convey more
 * information. It is used to convey the intent of utterances such as
 * "Change both the start and end date"
 */
class ConjunctionControlIntent extends BaseControlIntent_1.BaseControlIntent {
    /**
     * Create Intent from specification of the slots
     */
    static of(slots) {
        return IntentUtils_1.IntentBuilder.of(this.prototype.constructor.name, slots);
    }
    // tsDoc: see BaseControlIntent
    generateIntent() {
        return {
            name: this.name,
            slots: this.generateSlots(),
            samples: []
        };
    }
    generateSlots() {
        const slots = [
            {
                name: 'feedback',
                type: ModelTypes_1.SharedSlotType.FEEDBACK
            },
            {
                name: 'action',
                type: ModelTypes_1.SharedSlotType.ACTION
            },
            {
                name: 'conjunction',
                type: ModelTypes_1.SharedSlotType.CONJUNCTION
            },
            {
                name: 'target.a',
                type: ModelTypes_1.SharedSlotType.TARGET
            },
            {
                name: 'target.b',
                type: ModelTypes_1.SharedSlotType.TARGET
            },
            {
                name: 'head',
                type: ModelTypes_1.SharedSlotType.HEAD
            },
            {
                name: 'tail',
                type: ModelTypes_1.SharedSlotType.TAIL
            }
        ];
        return slots;
    }
}
exports.ConjunctionControlIntent = ConjunctionControlIntent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29uanVuY3Rpb25Db250cm9sSW50ZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ludGVudHMvQ29uanVuY3Rpb25Db250cm9sSW50ZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7O0FBS0gsc0RBQXlFO0FBQ3pFLHlFQUEwRTtBQUMxRSwyREFBd0Q7QUFleEQ7Ozs7Ozs7O0dBUUc7QUFDSCxTQUFnQiw4QkFBOEIsQ0FBQyxNQUFjO0lBQ3pELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQywwQkFBMEIsQ0FBQyxFQUFFO1FBQ3JELE1BQU0sSUFBSSxLQUFLLENBQUMsNkJBQTZCLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0tBQy9EO0lBRUQsSUFBSSxRQUE0QixDQUFDO0lBQ2pDLElBQUksTUFBMEIsQ0FBQztJQUMvQixJQUFJLE1BQTBCLENBQUM7SUFDL0IsSUFBSSxPQUEyQixDQUFDO0lBQ2hDLElBQUksT0FBMkIsQ0FBQztJQUNoQyxJQUFJLE9BQTJCLENBQUM7SUFDaEMsSUFBSSxPQUEyQixDQUFDO0lBRWhDLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFNLENBQUMsRUFBRTtRQUN0RCxNQUFNLFVBQVUsR0FBRyxnQ0FBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNoRSxRQUFRLElBQUksRUFBRTtZQUNWLEtBQUssVUFBVTtnQkFBRSxRQUFRLEdBQUcsU0FBUyxDQUFDO2dCQUFDLE1BQU07WUFDN0MsS0FBSyxRQUFRO2dCQUFFLE1BQU0sR0FBRyxTQUFTLENBQUM7Z0JBQUMsTUFBTTtZQUN6QyxLQUFL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QUUsSUFBSSxDQUFDLElBQUk7WUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUMzQixPQUFPLEVBQUUsRUFBRTtTQUNkLENBQUM7SUFDTixDQUFDO0lBRU8sYUFBYTtRQUNqQixNQUFNLEtBQUssR0FBK0M7WUFDdEQ7Z0JBQ0ksSUFBSSxFQUFFLFVBQVU7Z0JBQ2hCLElBQUksRUFBRSwyQkFBYyxDQUFDLFFBQVE7YUFDaEM7WUFDRDtnQkFDSSxJQUFJLEVBQUUsUUFBUTtnQkFDZCxJQUFJLEVBQUUsMkJBQWMsQ0FBQyxNQUFNO2FBQzlCO1lBQ0Q7Z0JBQ0ksSUFBSSxFQUFFLGFBQWE7Z0JBQ25CLElBQUksRUFBRSwyQkFBYyxDQUFDLFdBQVc7YUFDbkM7WUFDRDtnQkFDSSxJQUFJLEVBQUUsVUFBVTtnQkFDaEIsSUFBSSxFQUFFLDJCQUFjLENBQUMsTUFBTTthQUM5QjtZQUNEO2dCQUNJLElBQUksRUFBRSxVQUFVO2dCQUNoQixJQUFJLEVBQUUsMkJBQWMsQ0FBQyxNQUFNO2FBQzlCO1lBQ0Q7Z0JBQ0ksSUFBSSxFQUFFLE1BQU07Z0JBQ1osSUFBSSxFQUFFLDJCQUFjLENBQUMsSUFBSTthQUM1QjtZQUNEO2dCQUNJLElBQUksRUFBRSxNQUFNO2dCQUNaLElBQUksRUFBRSwyQkFBYyxDQUFDLElBQUk7YUFDNUI7U0FDSixDQUFDO1FBRUYsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUNKO0FBcERELDREQW9EQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS5cbiAqIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIG9yIGluIHRoZSBcImxpY2Vuc2VcIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZFxuICogb24gYW4gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyXG4gKiBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZ1xuICogcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEludGVudCB9IGZyb20gXCJhc2stc2RrLW1vZGVsXCI7XG5pbXBvcnQgeyB2MSB9IGZyb20gJ2Fzay1zbWFwaS1tb2RlbCc7XG5cbmltcG9ydCB7IGdldFNsb3RSZXNvbHV0aW9ucywgSW50ZW50QnVpbGRlciB9IGZyb20gJy4uL3V0aWxzL0ludGVudFV0aWxzJztcbmltcG9ydCB7IFNoYXJlZFNsb3RUeXBlIH0gZnJvbSAnLi4vaW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRpb24vTW9kZWxUeXBlcyc7XG5pbXBvcnQgeyBCYXNlQ29udHJvbEludGVudCB9IGZyb20gJy4vQmFzZUNvbnRyb2xJbnRlbnQnO1xuXG4vKipcbiAqIFNsb3QgdmFsdWVzIGNvbnZleWVkIGJ5IGEgQ29uanVuY3Rpb25Db250cm9sSW50ZW50XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29uanVuY3Rpb25Db250cm9sSW50ZW50U2xvdHMge1xuICAgIGZlZWRiYWNrPzogc3RyaW5nLFxuICAgIGFjdGlvbj86IHN0cmluZyxcbiAgICB0YXJnZXQ/OiBzdHJpbmcsXG4gICAgJ2FjdGlvbi5hJz86IHN0cmluZyxcbiAgICAndGFyZ2V0LmEnPzogc3RyaW5nLFxuICAgICdhY3Rpb24uYic/OiBzdHJpbmcsXG4gICAgJ3RhcmdldC5iJz86IHN0cmluZyxcbn1cblxuLyoqXG4gKiBVbnBhY2tzIHRoZSBjb21wbGV0ZSBpbnRlbnQgb2JqZWN0IGludG8gYSBzaW1wbGVyIHJlcHJlc2VudGF0aW9uLlxuICpcbiAqIE5vdGUgcmUgXCJlbXB0eSBzbG90c1wiOlxuICogLSBTbG90cyBpbiB0aGUgaW50ZW50IHdpdGggbm8gdmFsdWUgYXBwZWFyIGluIHRoZSBpbnRlbnQgb2JqZWN0IGFzIFwiXCIuXG4gKiAgIEhvd2V2ZXIsIHRoZXNlIGFyZSB1bnBhY2tlZCBhcyAqKmB1bmRlZmluZWRgKiogdG8gYmUgbW9yZSBleHBsaWNpdCBhbmQgZWFzZVxuICogICB0aGUgaW1wbGVtZW50YXRpb24gb2YgcHJlZGljYXRlcy5cbiAqIEBwYXJhbSBpbnRlbnQgLSBJbnRlbnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVucGFja0Nvbmp1bmN0aW9uQ29udHJvbEludGVudChpbnRlbnQ6IEludGVudCk6IENvbmp1bmN0aW9uQ29udHJvbEludGVudFNsb3RzIHtcbiAgICBpZiAoIWludGVudC5uYW1lLnN0YXJ0c1dpdGgoJ0Nvbmp1bmN0aW9uQ29udHJvbEludGVudCcpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IGEgY29tcGF0aWJsZSBpbnRlbnQgOiAke2ludGVudC5uYW1lfWApO1xuICAgIH1cblxuICAgIGxldCBmZWVkYmFjazogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGxldCBhY3Rpb246IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgdGFyZ2V0OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IGFjdGlvbkE6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgdGFyZ2V0QTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGxldCBhY3Rpb25COiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHRhcmdldEI6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIGZvciAoY29uc3QgW25hbWUsIHNsb3RdIG9mIE9iamVjdC5lbnRyaWVzKGludGVudC5zbG90cyEpKSB7XG4gICAgICAgIGNvbnN0IHNsb3RPYmplY3QgPSBnZXRTbG90UmVzb2x1dGlvbnMoc2xvdCk7XG4gICAgICAgIGNvbnN0IHNsb3RWYWx1ZSA9IHNsb3RPYmplY3QgPyBzbG90T2JqZWN0LnNsb3RWYWx1ZSA6IHVuZGVmaW5lZDtcbiAgICAgICAgc3dpdGNoIChuYW1lKSB7XG4gICAgICAgICAgICBjYXNlICdmZWVkYmFjayc6IGZlZWRiYWNrID0gc2xvdFZhbHVlOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2FjdGlvbic6IGFjdGlvbiA9IHNsb3RWYWx1ZTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICd0YXJnZXQnOiB0YXJnZXQgPSBzbG90VmFsdWU7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnYWN0aW9uLmEnOiBhY3Rpb25BID0gc2xvdFZhbHVlOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3RhcmdldC5hJzogdGFyZ2V0QSA9IHNsb3RWYWx1ZTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdhY3Rpb24uYic6IGFjdGlvbkIgPSBzbG90VmFsdWU7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAndGFyZ2V0LmInOiB0YXJnZXRCID0gc2xvdFZhbHVlOyBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnaGVhZCc6IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAndGFpbCc6IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAncHJlcG9zaXRpb24nOiBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2Nvbmp1bmN0aW9uJzogYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoJ25vdCBoYW5kbGVkJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBmZWVkYmFjayxcbiAgICAgICAgYWN0aW9uLFxuICAgICAgICB0YXJnZXQsXG4gICAgICAgICdhY3Rpb24uYSc6IGFjdGlvbkEsXG4gICAgICAgICd0YXJnZXQuYSc6IHRhcmdldEEsXG4gICAgICAgICdhY3Rpb24uYic6IGFjdGlvbkIsXG4gICAgICAgICd0YXJnZXQuYic6IHRhcmdldEIsXG4gICAgfTtcbn1cblxuLy8gVE9ETzogcmVmYWN0b3I6IG1vdmUgdGhlc2UgdG8gYmUgbWVtYmVycyBvZiB0aGUgQ29uanVuY3Rpb25Db250cm9sSW50ZW50U2xvdHMgdHlwZVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzT25lT3JNb3JlVGFyZ2V0cyhpbnB1dDogQ29uanVuY3Rpb25Db250cm9sSW50ZW50U2xvdHMgfCBudWxsKTogYm9vbGVhbiB7XG4gICAgaWYgKCFpbnB1dCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChpbnB1dC50YXJnZXQgIT09IHVuZGVmaW5lZCB8fCBpbnB1dFsndGFyZ2V0LmEnXSAhPT0gdW5kZWZpbmVkIHx8IGlucHV0Wyd0YXJnZXQuYiddICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gaGFzT25lT3JNb3JlQWN0aW9ucyhpbnB1dDogQ29uanVuY3Rpb25Db250cm9sSW50ZW50U2xvdHMgfCBudWxsKTogYm9vbGVhbiB7XG4gICAgaWYgKCFpbnB1dCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChpbnB1dFsnYWN0aW9uLmEnXSAhPT0gdW5kZWZpbmVkIHx8IGlucHV0WydhY3Rpb24uYiddICE9PSB1bmRlZmluZWQgfHwgaW5wdXQuYWN0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFyZUNvbmp1bmN0aW9uSW50ZW50U2xvdHNWYWxpZChpbnB1dDogQ29uanVuY3Rpb25Db250cm9sSW50ZW50U2xvdHMgfCBudWxsKTogYm9vbGVhbiB7XG4gICAgaWYgKCFpbnB1dCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIC8vIHByaW9yaXR5UnVsZSwgd2hlbiBhY3Rpb24gLyB0YXJnZXQgLCBubyBhY3Rpb25BLCBhY3Rpb25CLCBubyB0YXJnZXRBLCB0YXJnZXRCXG4gICAgaWYgKGlucHV0LmFjdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmIChpbnB1dFtcImFjdGlvbi5hXCJdICE9PSB1bmRlZmluZWQgfHwgaW5wdXRbXCJhY3Rpb24uYlwiXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlucHV0LnRhcmdldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmIChpbnB1dFsndGFyZ2V0LmEnXSAhPT0gdW5kZWZpbmVkIHx8IGlucHV0Wyd0YXJnZXQuYiddICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIHBhaXJSdWxlLCBpZiAuYSBleGlzdCwgdGhlbiAuYiBtdXN0IGV4aXN0LiBWaWNlIHZlcnNhXG4gICAgaWYgKChpbnB1dFsnYWN0aW9uLmEnXSAhPT0gdW5kZWZpbmVkICYmIGlucHV0WydhY3Rpb24uYiddID09PSB1bmRlZmluZWQpIHx8IChpbnB1dFsnYWN0aW9uLmInXSAhPT0gdW5kZWZpbmVkICYmIGlucHV0WydhY3Rpb24uYSddID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKChpbnB1dFsndGFyZ2V0LmEnXSAhPT0gdW5kZWZpbmVkICYmIGlucHV0Wyd0YXJnZXQuYiddID09PSB1bmRlZmluZWQpIHx8IChpbnB1dFsndGFyZ2V0LmInXSAhPT0gdW5kZWZpbmVkICYmIGlucHV0Wyd0YXJnZXQuYSddID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyB3aGVuIG9ubHkgb25lIHRhcmdldCwgZG9uJ3QgYWxsb3cgdHdvIGFjdGlvblxuICAgIGlmIChpbnB1dC50YXJnZXQgIT09IHVuZGVmaW5lZCAmJiBpbnB1dFtcImFjdGlvbi5hXCJdICE9PSB1bmRlZmluZWQgJiYgaW5wdXRbXCJhY3Rpb24uYlwiXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBvbmx5IHRhcmdldCBpcyBub3QgYWxsb3dlZFxuICAgIGlmIChpbnB1dC5hY3Rpb24gPT09IHVuZGVmaW5lZCAmJiBpbnB1dFtcImFjdGlvbi5hXCJdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFjdGlvbkFuZFRhc2sge1xuICAgIGFjdGlvbjogc3RyaW5nLFxuICAgIHRhcmdldDogc3RyaW5nLFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVBY3Rpb25UYXNrUGFpcnMoaW5wdXQ6IENvbmp1bmN0aW9uQ29udHJvbEludGVudFNsb3RzKTogQWN0aW9uQW5kVGFza1tdIHtcbiAgICBjb25zdCBpbnB1dHM6IEFjdGlvbkFuZFRhc2tbXSA9IFtdO1xuICAgIGNvbnN0IGlucHV0QTogQWN0aW9uQW5kVGFzayA9IHtcbiAgICAgICAgYWN0aW9uOiAnJyxcbiAgICAgICAgdGFyZ2V0OiAnJyxcbiAgICB9O1xuXG4gICAgY29uc3QgaW5wdXRCOiBBY3Rpb25BbmRUYXNrID0ge1xuICAgICAgICBhY3Rpb246ICcnLFxuICAgICAgICB0YXJnZXQ6ICcnLFxuICAgIH07XG5cbiAgICBpZiAoaGFzT25lT3JNb3JlQWN0aW9ucyhpbnB1dCkpIHtcbiAgICAgICAgLy8gMS4gQWN0aW9uIGV4aXN0XG4gICAgICAgIGlmIChpbnB1dC5hY3Rpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaW5wdXRBLmFjdGlvbiA9IGlucHV0LmFjdGlvbjtcbiAgICAgICAgICAgIGlucHV0Qi5hY3Rpb24gPSBpbnB1dC5hY3Rpb247XG4gICAgICAgIH0gZWxzZSB7IC8vIHR3byBhY3Rpb25cbiAgICAgICAgICAgIGlucHV0QS5hY3Rpb24gPSBpbnB1dFsnYWN0aW9uLmEnXSE7XG4gICAgICAgICAgICBpbnB1dEIuYWN0aW9uID0gaW5wdXRbJ2FjdGlvbi5iJ10hO1xuICAgICAgICB9XG4gICAgICAgIGlmIChoYXNPbmVPck1vcmVUYXJnZXRzKGlucHV0KSkge1xuICAgICAgICAgICAgLy8gMS4xIFRhcmdldCBleGlzdFxuICAgICAgICAgICAgaWYgKGlucHV0LnRhcmdldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgaW5wdXRBLnRhcmdldCA9IGlucHV0LnRhcmdldDtcbiAgICAgICAgICAgICAgICBpbnB1dEIudGFyZ2V0ID0gaW5wdXQudGFyZ2V0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpbnB1dEEudGFyZ2V0ID0gaW5wdXRbJ3RhcmdldC5hJ10hO1xuICAgICAgICAgICAgICAgIGlucHV0Qi50YXJnZXQgPSBpbnB1dFsndGFyZ2V0LmInXSE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgIH1cbiAgICAvLyByZW1vdmUgZHVwbGljYXRlXG4gICAgaWYgKGlucHV0QS5hY3Rpb24gPT09IGlucHV0Qi5hY3Rpb24gJiYgaW5wdXRBLnRhcmdldCA9PT0gaW5wdXRCLnRhcmdldCkge1xuICAgICAgICBpbnB1dHMucHVzaChpbnB1dEEpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlucHV0cy5wdXNoKGlucHV0QSk7XG4gICAgICAgIGlucHV0cy5wdXNoKGlucHV0Qik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGlucHV0cztcbn1cblxuLyoqXG4gKiBJbnRlbnQgdGhhdCBjb252ZXlzIGZlZWRiYWNrLCB1cCB0byB0d28gYWN0aW9ucywgYW5kIHVwIHR3byB0YXJnZXRzLlxuICpcbiAqIFRoaXMgaW50ZW50IGlzIGEgZ2VuZXJhbGl6YXRpb24gb2YgR2VuZXJhbENvbnRyb2xJbnRlbnQgdGhhdCBjYW4gY29udmV5IG1vcmVcbiAqIGluZm9ybWF0aW9uLiBJdCBpcyB1c2VkIHRvIGNvbnZleSB0aGUgaW50ZW50IG9mIHV0dGVyYW5jZXMgc3VjaCBhc1xuICogXCJDaGFuZ2UgYm90aCB0aGUgc3RhcnQgYW5kIGVuZCBkYXRlXCJcbiAqL1xuZXhwb3J0IGNsYXNzIENvbmp1bmN0aW9uQ29udHJvbEludGVudCBleHRlbmRzIEJhc2VDb250cm9sSW50ZW50IHtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBJbnRlbnQgZnJvbSBzcGVjaWZpY2F0aW9uIG9mIHRoZSBzbG90c1xuICAgICAqL1xuICAgIHN0YXRpYyBvZihzbG90czogQ29uanVuY3Rpb25Db250cm9sSW50ZW50U2xvdHMpOiBJbnRlbnQge1xuICAgICAgICByZXR1cm4gSW50ZW50QnVpbGRlci5vZih0aGlzLnByb3RvdHlwZS5jb25zdHJ1Y3Rvci5uYW1lLCBzbG90cyk7XG4gICAgfVxuXG4gICAgLy8gdHNEb2M6IHNlZSBCYXNlQ29udHJvbEludGVudFxuICAgIGdlbmVyYXRlSW50ZW50KCk6IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuSW50ZW50IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICAgIHNsb3RzOiB0aGlzLmdlbmVyYXRlU2xvdHMoKSxcbiAgICAgICAgICAgIHNhbXBsZXM6IFtdXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZVNsb3RzKCk6IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuU2xvdERlZmluaXRpb25bXSB7XG4gICAgICAgIGNvbnN0IHNsb3RzOiB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLlNsb3REZWZpbml0aW9uW10gPSBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ2ZlZWRiYWNrJyxcbiAgICAgICAgICAgICAgICB0eXBlOiBTaGFyZWRTbG90VHlwZS5GRUVEQkFDS1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnYWN0aW9uJyxcbiAgICAgICAgICAgICAgICB0eXBlOiBTaGFyZWRTbG90VHlwZS5BQ1RJT05cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ2Nvbmp1bmN0aW9uJyxcbiAgICAgICAgICAgICAgICB0eXBlOiBTaGFyZWRTbG90VHlwZS5DT05KVU5DVElPTlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiAndGFyZ2V0LmEnLFxuICAgICAgICAgICAgICAgIHR5cGU6IFNoYXJlZFNsb3RUeXBlLlRBUkdFVFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiAndGFyZ2V0LmInLFxuICAgICAgICAgICAgICAgIHR5cGU6IFNoYXJlZFNsb3RUeXBlLlRBUkdFVFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnaGVhZCcsXG4gICAgICAgICAgICAgICAgdHlwZTogU2hhcmVkU2xvdFR5cGUuSEVBRFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiAndGFpbCcsXG4gICAgICAgICAgICAgICAgdHlwZTogU2hhcmVkU2xvdFR5cGUuVEFJTFxuICAgICAgICAgICAgfVxuICAgICAgICBdO1xuXG4gICAgICAgIHJldHVybiBzbG90cztcbiAgICB9XG59Il19