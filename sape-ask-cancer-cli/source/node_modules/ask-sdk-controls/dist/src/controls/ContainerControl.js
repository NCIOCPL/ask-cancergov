"use strict";
/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.tryGetForId = exports.ContainerControl = exports.ContainerControlCompleteProps = exports.ContainerControlProps = exports.ContainerControlState = void 0;
const tslib_1 = require("tslib");
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const __1 = require("..");
const Logger_1 = require("../logging/Logger");
const Control_1 = require("./Control");
const log = new Logger_1.Logger('AskSdkControls:ContainerControl');
/**
 * Container state for use in arbitration
 */
class ContainerControlState {
}
exports.ContainerControlState = ContainerControlState;
class ContainerControlProps {
}
exports.ContainerControlProps = ContainerControlProps;
class ContainerControlCompleteProps {
}
exports.ContainerControlCompleteProps = ContainerControlCompleteProps;
/**
 *  A control that uses and manages child controls.
 *
 *  Default logic of `decideHandlingChild()` & `decideInitiativeChild()`:
 *   1. Choose the most-recent initiative control if is a candidate.
 *   2. Otherwise, choose the first candidate in the positional order of the
 *      `this.children` array.
 *   3. In the special case of `input = FallbackIntent`, only the most-recent
 *      initiative control is considered. If it is not a candidate, then no
 *      child is selected.
 *
 *  Usage:
 *  - Container controls can and should add high-level behaviors and respond to
 *    high-level requests such as multi-valued intents.
 *
 *  - Container controls should forward simple inputs to the child controls
 *    whenever possible in order to share the load and achieve scalable logic.
 *
 *  - Container controls should explicitly decide which child will handle an
 *    input or take the initiative in situations where there are multiple
 *    children that respond `canHandle = true` or `canTakeInitiative = true`.
 *
 */
class ContainerControl extends Control_1.Control {
    // jsDoc: see `Control`
    constructor(props) {
        super(props.id);
        this.children = [];
        this.rawProps = props;
        this.props = ContainerControl.mergeWithDefaultProps(props);
        this.state = new ContainerControlState();
    }
    static mergeWithDefaultProps(props) {
        const defaults = {
            id: 'dummy',
        };
        return lodash_1.default.merge(defaults, props);
    }
    /**
     * Add a control as a child.
     *
     * @param control - Control
     * @returns the container
     */
    addChild(control) {
        this.children.push(control);
        return this;
    }
    // jsDoc: see `Control`
    async canHandle(input) {
        return this.canHandleByChild(input);
    }
    // jsDoc: see `Control`
    async handle(input, resultBuilder) {
        return this.handleByChild(input, resultBuilder);
    }
    // jsDoc: see `Control`
    async canTakeInitiative(input) {
        return this.canTakeInitiativeByChild(input);
    }
    // jsDoc: see `Control`
    async takeInitiative(input, resultBuilder) {
        return this.takeInitiativeByChild(input, resultBuilder);
    }
    // jsDoc: see `ControlStateDiagramming`
    stringifyStateForDiagram() {
        return ''; // nothing special to report.
    }
    /**
     * Determines if a child control can handle the request.
     *
     * From the candidates that report `canHandle = true`, a winner is selected
     * by `this.decideHandlingChild(candidates)`.
     *
     * The selected "winner" is recorded in `this.selectedHandlingChild`.
     *
     * @param input - Input
     */
    async canHandleByChild(input) {
        const candidates = await this.gatherHandlingCandidates(input);
        this.selectedHandlingChild = await this.decideHandlingChild(candidates, input);
        if (this.selectedHandlingChild !== undefined) {
            log.debug(`${this.id} canHandleByChild=true. selectedHandlingChild = ${this.selectedHandlingChild.id}`);
            return true;
        }
        log.debug(`${this.id} canHandleByChild=false.`);
        return false;
    }
    /**
     * Delegates handling of the request to the child control selected during
     * canHandleByChild.
     *
     * @param input - Input
     * @param resultBuilder - Response builder.
     */
    async handleByChild(input, resultBuilder) {
        if (!this.selectedHandlingChild) {
            throw new Error('this.selectedHandlingChild is undefined. Did you call canHandle() first? Did it update this.selectedHandlingChild?');
        }
        await this.selectedHandlingChild.handle(input, resultBuilder);
        this.state.lastHandlingControl = { controlId: this.selectedHandlingChild.id, turnNumber: input.turnNumber };
        if (resultBuilder.hasInitiativeAct()) {
            this.state.lastInitiativeChild = { controlId: this.selectedHandlingChild.id, turnNumber: input.turnNumber };
        }
        return;
    }
    /**
     * Calls canHandle on each child control to determine the candidates for
     * delegation.
     * @param input - Input
     */
    async gatherHandlingCandidates(input) {
        const candidates = [];
        for (const child of this.children) {
            const response = await child.canHandle(input);
            if (response) {
                candidates.push(child);
            }
        }
        return candidates;
    }
    /**
     * Decides a winner from the canHandle candidates.
     *
     * The candidates should be all the child controls for which
     * `canHandle(input) = true`
     *
     * Default logic:
     *  1. Choose the  most-recent initiative control if is a candidate.
     *  2. Otherwise, choose the first candidate in the positional order of the
     *     `this.children` array.
     *  3. In the special case of input===FallbackIntent, only the most-recent
     *     initiative control is considered. If it is not a candidate, then no
     *     child is selected and this method returns undefined.
     *
     * Remarks:
     *  * The special case for FallbackIntent exists because that intent is not
     *    user-initiative -- rather it indicates a failure to understanding the
     *    user.  In cases of misunderstanding, only active controls should be
     *    considered.
     *
     * @param candidates - The child controls that reported `canHandle = true`
     * @param input - Input
     */
    async decideHandlingChild(candidates, input) {
        var _a, _b;
        if (candidates.length === 0) {
            return undefined;
        }
        if (__1.InputUtil.isFallbackIntent(input)) {
            const last = tryGetForId(candidates, (_a = this.state.lastInitiativeChild) === null || _a === void 0 ? void 0 : _a.controlId);
            return last ? last : undefined;
        }
        const mruMatch = tryGetForId(candidates, (_b = this.state.lastInitiativeChild) === null || _b === void 0 ? void 0 : _b.controlId);
        return mruMatch !== null && mruMatch !== void 0 ? mruMatch : candidates[0];
    }
    /**
     * Determines if a child control can take the initiative.
     *
     * From the candidates that report `canTakeInitiative = true`, a winner is selected
     * by `this.decideInitiativeChild(candidates)`.
     *
     * The selected "winner" is recorded in `this.selectedInitiativeChild`.
     *
     * @param input - Input
     */
    async canTakeInitiativeByChild(input) {
        const candidates = await this.gatherInitiativeCandidates(input);
        this.selectedInitiativeChild = await this.decideInitiativeChild(candidates, input);
        if (this.selectedInitiativeChild !== undefined) {
            log.debug(`${this.id} canTakeInitiative=true. this.selectedInitiativeChild = ${this.selectedInitiativeChild.id}`);
            return true;
        }
        else {
            log.debug(`${this.id} canTakeInitiative=false. No child wants it`);
            return false;
        }
    }
    /**
     * Delegates initiative generation to the child control selected during
     * canHandleByChild.
     *
     * @param input - Input
     * @param resultBuilder - Response builder.
     */
    async takeInitiativeByChild(input, resultBuilder) {
        if (!this.selectedInitiativeChild) {
            throw new Error('this.selectedInitiativeChild is undefined. Did you call canTakeInitiative() first? Did it update this.selectedInitiativeChild?');
        }
        await this.selectedInitiativeChild.takeInitiative(input, resultBuilder);
        this.state.lastInitiativeChild = { controlId: this.selectedInitiativeChild.id, turnNumber: input.turnNumber };
        return;
    }
    /**
     * Calls canTakeInitiative on each child control to determine the candidates
     * for delegation.
     * @param input - Input
     */
    async gatherInitiativeCandidates(input) {
        const candidates = [];
        for (const child of this.children) {
            const response = await child.canTakeInitiative(input);
            if (response) {
                candidates.push(child);
            }
        }
        return candidates;
    }
    /**
     * Decide a winner from the canTakeInitiative candidates.
     *
     * The eligible candidates are child controls for which
     * `canTakeInitiative(input) = true`.
     *
     * Default logic:
     *  1. choose the most-recent initiative control if is a candidate.
     *  2. otherwise choose the first candidate in the positional order of the
     *     `this.children` array.
     *
     * @param candidates - The child controls that reported `canTakeInitiative = true`
     * @param input - Input
     */
    async decideInitiativeChild(candidates, input) {
        var _a;
        if (candidates.length === 0) {
            return undefined;
        }
        const mruMatch = tryGetForId(candidates, (_a = this.state.lastInitiativeChild) === null || _a === void 0 ? void 0 : _a.controlId);
        return mruMatch !== null && mruMatch !== void 0 ? mruMatch : candidates[0];
    }
}
exports.ContainerControl = ContainerControl;
/**
 * Returns the control with `id = childID` if it exists
 *
 * @param controls - Controls
 * @param childId - The id to match
 */
function tryGetForId(controls, childId) {
    if (childId === undefined) {
        return undefined;
    }
    return controls.find(c => c.id === childId);
}
exports.tryGetForId = tryGetForId;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGFpbmVyQ29udHJvbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb250cm9scy9Db250YWluZXJDb250cm9sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7OztBQUdILDREQUF1QjtBQUN2QiwwQkFBK0I7QUFDL0IsOENBQTJDO0FBQzNDLHVDQUFnRTtBQU1oRSxNQUFNLEdBQUcsR0FBRyxJQUFJLGVBQU0sQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBWTFEOztHQUVHO0FBQ0gsTUFBYSxxQkFBcUI7Q0FJakM7QUFKRCxzREFJQztBQUVELE1BQWEscUJBQXFCO0NBRWpDO0FBRkQsc0RBRUM7QUFFRCxNQUFhLDZCQUE2QjtDQUV6QztBQUZELHNFQUVDO0FBR0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FzQkc7QUFDSCxNQUFhLGdCQUFpQixTQUFRLGlCQUFPO0lBU3pDLHVCQUF1QjtJQUN2QixZQUFZLEtBQTRCO1FBQ3BDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7UUFUcEIsYUFBUSxHQUFjLEVBQUUsQ0FBQztRQVVyQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLGdCQUFnQixDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxxQkFBcUIsRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFRCxNQUFNLENBQUMscUJBQXFCLENBQUMsS0FBNEI7UUFDckQsTUFBTSxRQUFRLEdBQ2Q7WUFDSSxFQUFFLEVBQUUsT0FBTztTQUNkLENBQUM7UUFDRixPQUFPLGdCQUFDLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxRQUFRLENBQUMsT0FBZ0I7UUFDckIsSUFBSSxDQUFDLFFB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RCxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsVUFBVSxRQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsbUJBQW1CLDBDQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3BGLE9BQU8sUUFBUSxhQUFSLFFBQVEsY0FBUixRQUFRLEdBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7Q0FDSjtBQTVPRCw0Q0E0T0M7QUFFRDs7Ozs7R0FLRztBQUNILFNBQWdCLFdBQVcsQ0FBQyxRQUFtQixFQUFFLE9BQWdCO0lBQzdELElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtRQUN2QixPQUFPLFNBQVMsQ0FBQztLQUNwQjtJQUNELE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssT0FBTyxDQUFDLENBQUM7QUFDaEQsQ0FBQztBQUxELGtDQUtDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDIwIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICogWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogb3IgaW4gdGhlIFwibGljZW5zZVwiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkXG4gKiBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nXG4gKiBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuXG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgeyBJbnB1dFV0aWwgfSBmcm9tICcuLic7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnaW5nL0xvZ2dlcic7XG5pbXBvcnQgeyBDb250cm9sLCBDb250cm9sUHJvcHMsIENvbnRyb2xTdGF0ZSB9IGZyb20gJy4vQ29udHJvbCc7XG5pbXBvcnQgeyBDb250cm9sSW5wdXQgfSBmcm9tICcuL0NvbnRyb2xJbnB1dCc7XG5pbXBvcnQgeyBDb250cm9sUmVzdWx0QnVpbGRlciB9IGZyb20gJy4vQ29udHJvbFJlc3VsdCc7XG5pbXBvcnQgeyBJQ29udGFpbmVyQ29udHJvbCB9IGZyb20gJy4vaW50ZXJmYWNlcy9JQ29udGFpbmVyQ29udHJvbCc7XG5pbXBvcnQgeyBDb250cm9sU3RhdGVEaWFncmFtbWluZyB9IGZyb20gJy4vbWl4aW5zL0NvbnRyb2xTdGF0ZURpYWdyYW1taW5nJztcblxuY29uc3QgbG9nID0gbmV3IExvZ2dlcignQXNrU2RrQ29udHJvbHM6Q29udGFpbmVyQ29udHJvbCcpO1xuXG5cblxuLyoqXG4gKiBSZWNvcmRzIHRoZSB0dXJuIHRoYXQgYSBjaGlsZCBjb250cm9sIGRpZCBzb21ldGhpbmcgb2YgaW50ZXJlc3QuXG4gKi9cbmludGVyZmFjZSBDaGlsZEFjdGl2aXR5UmVjb3JkIHtcbiAgICBjb250cm9sSWQ6IHN0cmluZztcbiAgICB0dXJuTnVtYmVyOiBudW1iZXI7XG59XG5cbi8qKlxuICogQ29udGFpbmVyIHN0YXRlIGZvciB1c2UgaW4gYXJiaXRyYXRpb25cbiAqL1xuZXhwb3J0IGNsYXNzIENvbnRhaW5lckNvbnRyb2xTdGF0ZSBpbXBsZW1lbnRzIENvbnRyb2xTdGF0ZSB7XG4gICAgdmFsdWU/OiBhbnk7XG4gICAgbGFzdEhhbmRsaW5nQ29udHJvbD86IENoaWxkQWN0aXZpdHlSZWNvcmQ7ICAvLyBUT0RPOiBuYW1pbmc6IGNoYW5nZSB0byBsYXN0SGFuZGxpbmdDb250cm9sSW5mbyB8IGxhc3RIYW5kbGluZ0NvbnRyb2xSZWNvcmRcbiAgICBsYXN0SW5pdGlhdGl2ZUNoaWxkPzogQ2hpbGRBY3Rpdml0eVJlY29yZDsgIC8vIGRpdHRvLlxufVxuXG5leHBvcnQgY2xhc3MgQ29udGFpbmVyQ29udHJvbFByb3BzIGltcGxlbWVudHMgQ29udHJvbFByb3BzIHtcbiAgICBpZDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgQ29udGFpbmVyQ29udHJvbENvbXBsZXRlUHJvcHMgaW1wbGVtZW50cyBDb250cm9sUHJvcHMge1xuICAgIGlkOiBzdHJpbmc7XG59XG5cblxuLyoqXG4gKiAgQSBjb250cm9sIHRoYXQgdXNlcyBhbmQgbWFuYWdlcyBjaGlsZCBjb250cm9scy5cbiAqXG4gKiAgRGVmYXVsdCBsb2dpYyBvZiBgZGVjaWRlSGFuZGxpbmdDaGlsZCgpYCAmIGBkZWNpZGVJbml0aWF0aXZlQ2hpbGQoKWA6XG4gKiAgIDEuIENob29zZSB0aGUgbW9zdC1yZWNlbnQgaW5pdGlhdGl2ZSBjb250cm9sIGlmIGlzIGEgY2FuZGlkYXRlLlxuICogICAyLiBPdGhlcndpc2UsIGNob29zZSB0aGUgZmlyc3QgY2FuZGlkYXRlIGluIHRoZSBwb3NpdGlvbmFsIG9yZGVyIG9mIHRoZVxuICogICAgICBgdGhpcy5jaGlsZHJlbmAgYXJyYXkuXG4gKiAgIDMuIEluIHRoZSBzcGVjaWFsIGNhc2Ugb2YgYGlucHV0ID0gRmFsbGJhY2tJbnRlbnRgLCBvbmx5IHRoZSBtb3N0LXJlY2VudFxuICogICAgICBpbml0aWF0aXZlIGNvbnRyb2wgaXMgY29uc2lkZXJlZC4gSWYgaXQgaXMgbm90IGEgY2FuZGlkYXRlLCB0aGVuIG5vXG4gKiAgICAgIGNoaWxkIGlzIHNlbGVjdGVkLlxuICpcbiAqICBVc2FnZTpcbiAqICAtIENvbnRhaW5lciBjb250cm9scyBjYW4gYW5kIHNob3VsZCBhZGQgaGlnaC1sZXZlbCBiZWhhdmlvcnMgYW5kIHJlc3BvbmQgdG9cbiAqICAgIGhpZ2gtbGV2ZWwgcmVxdWVzdHMgc3VjaCBhcyBtdWx0aS12YWx1ZWQgaW50ZW50cy5cbiAqXG4gKiAgLSBDb250YWluZXIgY29udHJvbHMgc2hvdWxkIGZvcndhcmQgc2ltcGxlIGlucHV0cyB0byB0aGUgY2hpbGQgY29udHJvbHNcbiAqICAgIHdoZW5ldmVyIHBvc3NpYmxlIGluIG9yZGVyIHRvIHNoYXJlIHRoZSBsb2FkIGFuZCBhY2hpZXZlIHNjYWxhYmxlIGxvZ2ljLlxuICpcbiAqICAtIENvbnRhaW5lciBjb250cm9scyBzaG91bGQgZXhwbGljaXRseSBkZWNpZGUgd2hpY2ggY2hpbGQgd2lsbCBoYW5kbGUgYW5cbiAqICAgIGlucHV0IG9yIHRha2UgdGhlIGluaXRpYXRpdmUgaW4gc2l0dWF0aW9ucyB3aGVyZSB0aGVyZSBhcmUgbXVsdGlwbGVcbiAqICAgIGNoaWxkcmVuIHRoYXQgcmVzcG9uZCBgY2FuSGFuZGxlID0gdHJ1ZWAgb3IgYGNhblRha2VJbml0aWF0aXZlID0gdHJ1ZWAuXG4gKlxuICovXG5leHBvcnQgY2xhc3MgQ29udGFpbmVyQ29udHJvbCBleHRlbmRzIENvbnRyb2wgaW1wbGVtZW50cyBJQ29udGFpbmVyQ29udHJvbCwgQ29udHJvbFN0YXRlRGlhZ3JhbW1pbmcge1xuICAgIHN0YXRlOiBDb250YWluZXJDb250cm9sU3RhdGU7XG4gICAgY2hpbGRyZW46IENvbnRyb2xbXSA9IFtdO1xuXG4gICAgcmF3UHJvcHM6IENvbnRhaW5lckNvbnRyb2xQcm9wcztcbiAgICBwcm9wczogQ29udGFpbmVyQ29udHJvbENvbXBsZXRlUHJvcHM7XG4gICAgc2VsZWN0ZWRIYW5kbGluZ0NoaWxkOiBDb250cm9sIHwgdW5kZWZpbmVkO1xuICAgIHNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkOiBDb250cm9sIHwgdW5kZWZpbmVkO1xuXG4gICAgLy8ganNEb2M6IHNlZSBgQ29udHJvbGBcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogQ29udGFpbmVyQ29udHJvbFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzLmlkKTtcbiAgICAgICAgdGhpcy5yYXdQcm9wcyA9IHByb3BzO1xuICAgICAgICB0aGlzLnByb3BzID0gQ29udGFpbmVyQ29udHJvbC5tZXJnZVdpdGhEZWZhdWx0UHJvcHMocHJvcHMpO1xuICAgICAgICB0aGlzLnN0YXRlID0gbmV3IENvbnRhaW5lckNvbnRyb2xTdGF0ZSgpO1xuICAgIH1cblxuICAgIHN0YXRpYyBtZXJnZVdpdGhEZWZhdWx0UHJvcHMocHJvcHM6IENvbnRhaW5lckNvbnRyb2xQcm9wcyk6IGFueSB7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRzOiBDb250YWluZXJDb250cm9sQ29tcGxldGVQcm9wcyA9XG4gICAgICAgIHtcbiAgICAgICAgICAgIGlkOiAnZHVtbXknLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gXy5tZXJnZShkZWZhdWx0cywgcHJvcHMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGNvbnRyb2wgYXMgYSBjaGlsZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBjb250cm9sIC0gQ29udHJvbFxuICAgICAqIEByZXR1cm5zIHRoZSBjb250YWluZXJcbiAgICAgKi9cbiAgICBhZGRDaGlsZChjb250cm9sOiBDb250cm9sKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjb250cm9sKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLy8ganNEb2M6IHNlZSBgQ29udHJvbGBcbiAgICBhc3luYyBjYW5IYW5kbGUoaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jYW5IYW5kbGVCeUNoaWxkKGlucHV0KTtcbiAgICB9XG5cbiAgICAvLyBqc0RvYzogc2VlIGBDb250cm9sYFxuICAgIGFzeW5jIGhhbmRsZShpbnB1dDogQ29udHJvbElucHV0LCByZXN1bHRCdWlsZGVyOiBDb250cm9sUmVzdWx0QnVpbGRlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVCeUNoaWxkKGlucHV0LCByZXN1bHRCdWlsZGVyKTtcbiAgICB9XG5cbiAgICAvLyBqc0RvYzogc2VlIGBDb250cm9sYFxuICAgIGFzeW5jIGNhblRha2VJbml0aWF0aXZlKGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuVGFrZUluaXRpYXRpdmVCeUNoaWxkKGlucHV0KTtcbiAgICB9XG5cbiAgICAvLyBqc0RvYzogc2VlIGBDb250cm9sYFxuICAgIGFzeW5jIHRha2VJbml0aWF0aXZlKGlucHV0OiBDb250cm9sSW5wdXQsIHJlc3VsdEJ1aWxkZXI6IENvbnRyb2xSZXN1bHRCdWlsZGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRha2VJbml0aWF0aXZlQnlDaGlsZChpbnB1dCwgcmVzdWx0QnVpbGRlcik7XG4gICAgfVxuXG4gICAgLy8ganNEb2M6IHNlZSBgQ29udHJvbFN0YXRlRGlhZ3JhbW1pbmdgXG4gICAgc3RyaW5naWZ5U3RhdGVGb3JEaWFncmFtKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAnJzsgLy8gbm90aGluZyBzcGVjaWFsIHRvIHJlcG9ydC5cbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgaWYgYSBjaGlsZCBjb250cm9sIGNhbiBoYW5kbGUgdGhlIHJlcXVlc3QuXG4gICAgICpcbiAgICAgKiBGcm9tIHRoZSBjYW5kaWRhdGVzIHRoYXQgcmVwb3J0IGBjYW5IYW5kbGUgPSB0cnVlYCwgYSB3aW5uZXIgaXMgc2VsZWN0ZWRcbiAgICAgKiBieSBgdGhpcy5kZWNpZGVIYW5kbGluZ0NoaWxkKGNhbmRpZGF0ZXMpYC5cbiAgICAgKlxuICAgICAqIFRoZSBzZWxlY3RlZCBcIndpbm5lclwiIGlzIHJlY29yZGVkIGluIGB0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZGAuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaW5wdXQgLSBJbnB1dFxuICAgICAqL1xuICAgIGFzeW5jIGNhbkhhbmRsZUJ5Q2hpbGQoaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gYXdhaXQgdGhpcy5nYXRoZXJIYW5kbGluZ0NhbmRpZGF0ZXMoaW5wdXQpO1xuICAgICAgICB0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZCA9IGF3YWl0IHRoaXMuZGVjaWRlSGFuZGxpbmdDaGlsZChjYW5kaWRhdGVzLCBpbnB1dCk7XG4gICAgICAgIGlmICh0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5pZH0gY2FuSGFuZGxlQnlDaGlsZD10cnVlLiBzZWxlY3RlZEhhbmRsaW5nQ2hpbGQgPSAke3RoaXMuc2VsZWN0ZWRIYW5kbGluZ0NoaWxkLmlkfWApO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5pZH0gY2FuSGFuZGxlQnlDaGlsZD1mYWxzZS5gKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVsZWdhdGVzIGhhbmRsaW5nIG9mIHRoZSByZXF1ZXN0IHRvIHRoZSBjaGlsZCBjb250cm9sIHNlbGVjdGVkIGR1cmluZ1xuICAgICAqIGNhbkhhbmRsZUJ5Q2hpbGQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaW5wdXQgLSBJbnB1dFxuICAgICAqIEBwYXJhbSByZXN1bHRCdWlsZGVyIC0gUmVzcG9uc2UgYnVpbGRlci5cbiAgICAgKi9cbiAgICBhc3luYyBoYW5kbGVCeUNoaWxkKGlucHV0OiBDb250cm9sSW5wdXQsIHJlc3VsdEJ1aWxkZXI6IENvbnRyb2xSZXN1bHRCdWlsZGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghdGhpcy5zZWxlY3RlZEhhbmRsaW5nQ2hpbGQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndGhpcy5zZWxlY3RlZEhhbmRsaW5nQ2hpbGQgaXMgdW5kZWZpbmVkLiBEaWQgeW91IGNhbGwgY2FuSGFuZGxlKCkgZmlyc3Q/IERpZCBpdCB1cGRhdGUgdGhpcy5zZWxlY3RlZEhhbmRsaW5nQ2hpbGQ/Jyk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZC5oYW5kbGUoaW5wdXQsIHJlc3VsdEJ1aWxkZXIpO1xuICAgICAgICB0aGlzLnN0YXRlLmxhc3RIYW5kbGluZ0NvbnRyb2wgPSB7IGNvbnRyb2xJZDogdGhpcy5zZWxlY3RlZEhhbmRsaW5nQ2hpbGQuaWQsIHR1cm5OdW1iZXI6IGlucHV0LnR1cm5OdW1iZXIgfTtcblxuICAgICAgICBpZiAocmVzdWx0QnVpbGRlci5oYXNJbml0aWF0aXZlQWN0KCkpe1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5sYXN0SW5pdGlhdGl2ZUNoaWxkID0geyBjb250cm9sSWQ6IHRoaXMuc2VsZWN0ZWRIYW5kbGluZ0NoaWxkLmlkLCB0dXJuTnVtYmVyOiBpbnB1dC50dXJuTnVtYmVyIH07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgY2FuSGFuZGxlIG9uIGVhY2ggY2hpbGQgY29udHJvbCB0byBkZXRlcm1pbmUgdGhlIGNhbmRpZGF0ZXMgZm9yXG4gICAgICogZGVsZWdhdGlvbi5cbiAgICAgKiBAcGFyYW0gaW5wdXQgLSBJbnB1dFxuICAgICAqL1xuICAgIGFzeW5jIGdhdGhlckhhbmRsaW5nQ2FuZGlkYXRlcyhpbnB1dDogQ29udHJvbElucHV0KTogUHJvbWlzZTxDb250cm9sW10+IHtcbiAgICAgICAgY29uc3QgY2FuZGlkYXRlczogQ29udHJvbFtdID0gW107XG4gICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjaGlsZC5jYW5IYW5kbGUoaW5wdXQpO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgY2FuZGlkYXRlcy5wdXNoKGNoaWxkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2FuZGlkYXRlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWNpZGVzIGEgd2lubmVyIGZyb20gdGhlIGNhbkhhbmRsZSBjYW5kaWRhdGVzLlxuICAgICAqXG4gICAgICogVGhlIGNhbmRpZGF0ZXMgc2hvdWxkIGJlIGFsbCB0aGUgY2hpbGQgY29udHJvbHMgZm9yIHdoaWNoXG4gICAgICogYGNhbkhhbmRsZShpbnB1dCkgPSB0cnVlYFxuICAgICAqXG4gICAgICogRGVmYXVsdCBsb2dpYzpcbiAgICAgKiAgMS4gQ2hvb3NlIHRoZSAgbW9zdC1yZWNlbnQgaW5pdGlhdGl2ZSBjb250cm9sIGlmIGlzIGEgY2FuZGlkYXRlLlxuICAgICAqICAyLiBPdGhlcndpc2UsIGNob29zZSB0aGUgZmlyc3QgY2FuZGlkYXRlIGluIHRoZSBwb3NpdGlvbmFsIG9yZGVyIG9mIHRoZVxuICAgICAqICAgICBgdGhpcy5jaGlsZHJlbmAgYXJyYXkuXG4gICAgICogIDMuIEluIHRoZSBzcGVjaWFsIGNhc2Ugb2YgaW5wdXQ9PT1GYWxsYmFja0ludGVudCwgb25seSB0aGUgbW9zdC1yZWNlbnRcbiAgICAgKiAgICAgaW5pdGlhdGl2ZSBjb250cm9sIGlzIGNvbnNpZGVyZWQuIElmIGl0IGlzIG5vdCBhIGNhbmRpZGF0ZSwgdGhlbiBub1xuICAgICAqICAgICBjaGlsZCBpcyBzZWxlY3RlZCBhbmQgdGhpcyBtZXRob2QgcmV0dXJucyB1bmRlZmluZWQuXG4gICAgICpcbiAgICAgKiBSZW1hcmtzOlxuICAgICAqICAqIFRoZSBzcGVjaWFsIGNhc2UgZm9yIEZhbGxiYWNrSW50ZW50IGV4aXN0cyBiZWNhdXNlIHRoYXQgaW50ZW50IGlzIG5vdFxuICAgICAqICAgIHVzZXItaW5pdGlhdGl2ZSAtLSByYXRoZXIgaXQgaW5kaWNhdGVzIGEgZmFpbHVyZSB0byB1bmRlcnN0YW5kaW5nIHRoZVxuICAgICAqICAgIHVzZXIuICBJbiBjYXNlcyBvZiBtaXN1bmRlcnN0YW5kaW5nLCBvbmx5IGFjdGl2ZSBjb250cm9scyBzaG91bGQgYmVcbiAgICAgKiAgICBjb25zaWRlcmVkLlxuICAgICAqXG4gICAgICogQHBhcmFtIGNhbmRpZGF0ZXMgLSBUaGUgY2hpbGQgY29udHJvbHMgdGhhdCByZXBvcnRlZCBgY2FuSGFuZGxlID0gdHJ1ZWBcbiAgICAgKiBAcGFyYW0gaW5wdXQgLSBJbnB1dFxuICAgICAqL1xuICAgIGFzeW5jIGRlY2lkZUhhbmRsaW5nQ2hpbGQoY2FuZGlkYXRlczogQ29udHJvbFtdLCBpbnB1dDogQ29udHJvbElucHV0KTogUHJvbWlzZTxDb250cm9sIHwgdW5kZWZpbmVkPiB7XG4gICAgICAgIGlmIChjYW5kaWRhdGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoSW5wdXRVdGlsLmlzRmFsbGJhY2tJbnRlbnQoaW5wdXQpKSB7XG4gICAgICAgICAgICBjb25zdCBsYXN0ID0gdHJ5R2V0Rm9ySWQoY2FuZGlkYXRlcywgdGhpcy5zdGF0ZS5sYXN0SW5pdGlhdGl2ZUNoaWxkPy5jb250cm9sSWQpO1xuICAgICAgICAgICAgcmV0dXJuIGxhc3QgPyBsYXN0IDogdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1ydU1hdGNoID0gdHJ5R2V0Rm9ySWQoY2FuZGlkYXRlcywgdGhpcy5zdGF0ZS5sYXN0SW5pdGlhdGl2ZUNoaWxkPy5jb250cm9sSWQpO1xuICAgICAgICByZXR1cm4gbXJ1TWF0Y2ggPz8gY2FuZGlkYXRlc1swXTtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgaWYgYSBjaGlsZCBjb250cm9sIGNhbiB0YWtlIHRoZSBpbml0aWF0aXZlLlxuICAgICAqXG4gICAgICogRnJvbSB0aGUgY2FuZGlkYXRlcyB0aGF0IHJlcG9ydCBgY2FuVGFrZUluaXRpYXRpdmUgPSB0cnVlYCwgYSB3aW5uZXIgaXMgc2VsZWN0ZWRcbiAgICAgKiBieSBgdGhpcy5kZWNpZGVJbml0aWF0aXZlQ2hpbGQoY2FuZGlkYXRlcylgLlxuICAgICAqXG4gICAgICogVGhlIHNlbGVjdGVkIFwid2lubmVyXCIgaXMgcmVjb3JkZWQgaW4gYHRoaXMuc2VsZWN0ZWRJbml0aWF0aXZlQ2hpbGRgLlxuICAgICAqXG4gICAgICogQHBhcmFtIGlucHV0IC0gSW5wdXRcbiAgICAgKi9cbiAgICBhc3luYyBjYW5UYWtlSW5pdGlhdGl2ZUJ5Q2hpbGQoaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gYXdhaXQgdGhpcy5nYXRoZXJJbml0aWF0aXZlQ2FuZGlkYXRlcyhpbnB1dCk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRJbml0aWF0aXZlQ2hpbGQgPSBhd2FpdCB0aGlzLmRlY2lkZUluaXRpYXRpdmVDaGlsZChjYW5kaWRhdGVzLCBpbnB1dCk7XG4gICAgICAgIGlmICh0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgJHt0aGlzLmlkfSBjYW5UYWtlSW5pdGlhdGl2ZT10cnVlLiB0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkID0gJHt0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkLmlkfWApO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5pZH0gY2FuVGFrZUluaXRpYXRpdmU9ZmFsc2UuIE5vIGNoaWxkIHdhbnRzIGl0YCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWxlZ2F0ZXMgaW5pdGlhdGl2ZSBnZW5lcmF0aW9uIHRvIHRoZSBjaGlsZCBjb250cm9sIHNlbGVjdGVkIGR1cmluZ1xuICAgICAqIGNhbkhhbmRsZUJ5Q2hpbGQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaW5wdXQgLSBJbnB1dFxuICAgICAqIEBwYXJhbSByZXN1bHRCdWlsZGVyIC0gUmVzcG9uc2UgYnVpbGRlci5cbiAgICAgKi9cbiAgICBhc3luYyB0YWtlSW5pdGlhdGl2ZUJ5Q2hpbGQoaW5wdXQ6IENvbnRyb2xJbnB1dCwgcmVzdWx0QnVpbGRlcjogQ29udHJvbFJlc3VsdEJ1aWxkZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKCF0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RoaXMuc2VsZWN0ZWRJbml0aWF0aXZlQ2hpbGQgaXMgdW5kZWZpbmVkLiBEaWQgeW91IGNhbGwgY2FuVGFrZUluaXRpYXRpdmUoKSBmaXJzdD8gRGlkIGl0IHVwZGF0ZSB0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkPycpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHRoaXMuc2VsZWN0ZWRJbml0aWF0aXZlQ2hpbGQudGFrZUluaXRpYXRpdmUoaW5wdXQsIHJlc3VsdEJ1aWxkZXIpO1xuICAgICAgICB0aGlzLnN0YXRlLmxhc3RJbml0aWF0aXZlQ2hpbGQgPSB7IGNvbnRyb2xJZDogdGhpcy5zZWxlY3RlZEluaXRpYXRpdmVDaGlsZC5pZCwgdHVybk51bWJlcjogaW5wdXQudHVybk51bWJlciB9O1xuXG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyBjYW5UYWtlSW5pdGlhdGl2ZSBvbiBlYWNoIGNoaWxkIGNvbnRyb2wgdG8gZGV0ZXJtaW5lIHRoZSBjYW5kaWRhdGVzXG4gICAgICogZm9yIGRlbGVnYXRpb24uXG4gICAgICogQHBhcmFtIGlucHV0IC0gSW5wdXRcbiAgICAgKi9cbiAgICBhc3luYyBnYXRoZXJJbml0aWF0aXZlQ2FuZGlkYXRlcyhpbnB1dDogQ29udHJvbElucHV0KTogUHJvbWlzZTxDb250cm9sW10+IHtcbiAgICAgICAgY29uc3QgY2FuZGlkYXRlczogQ29udHJvbFtdID0gW107XG4gICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjaGlsZC5jYW5UYWtlSW5pdGlhdGl2ZShpbnB1dCk7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBjYW5kaWRhdGVzLnB1c2goY2hpbGQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjYW5kaWRhdGVzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlY2lkZSBhIHdpbm5lciBmcm9tIHRoZSBjYW5UYWtlSW5pdGlhdGl2ZSBjYW5kaWRhdGVzLlxuICAgICAqXG4gICAgICogVGhlIGVsaWdpYmxlIGNhbmRpZGF0ZXMgYXJlIGNoaWxkIGNvbnRyb2xzIGZvciB3aGljaFxuICAgICAqIGBjYW5UYWtlSW5pdGlhdGl2ZShpbnB1dCkgPSB0cnVlYC5cbiAgICAgKlxuICAgICAqIERlZmF1bHQgbG9naWM6XG4gICAgICogIDEuIGNob29zZSB0aGUgbW9zdC1yZWNlbnQgaW5pdGlhdGl2ZSBjb250cm9sIGlmIGlzIGEgY2FuZGlkYXRlLlxuICAgICAqICAyLiBvdGhlcndpc2UgY2hvb3NlIHRoZSBmaXJzdCBjYW5kaWRhdGUgaW4gdGhlIHBvc2l0aW9uYWwgb3JkZXIgb2YgdGhlXG4gICAgICogICAgIGB0aGlzLmNoaWxkcmVuYCBhcnJheS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBjYW5kaWRhdGVzIC0gVGhlIGNoaWxkIGNvbnRyb2xzIHRoYXQgcmVwb3J0ZWQgYGNhblRha2VJbml0aWF0aXZlID0gdHJ1ZWBcbiAgICAgKiBAcGFyYW0gaW5wdXQgLSBJbnB1dFxuICAgICAqL1xuICAgIGFzeW5jIGRlY2lkZUluaXRpYXRpdmVDaGlsZChjYW5kaWRhdGVzOiBDb250cm9sW10sIGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPENvbnRyb2wgfCB1bmRlZmluZWQ+IHtcbiAgICAgICAgaWYgKGNhbmRpZGF0ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1ydU1hdGNoID0gdHJ5R2V0Rm9ySWQoY2FuZGlkYXRlcywgdGhpcy5zdGF0ZS5sYXN0SW5pdGlhdGl2ZUNoaWxkPy5jb250cm9sSWQpO1xuICAgICAgICByZXR1cm4gbXJ1TWF0Y2ggPz8gY2FuZGlkYXRlc1swXTtcbiAgICB9XG59XG5cbi8qKlxuICogUmV0dXJucyB0aGUgY29udHJvbCB3aXRoIGBpZCA9IGNoaWxkSURgIGlmIGl0IGV4aXN0c1xuICpcbiAqIEBwYXJhbSBjb250cm9scyAtIENvbnRyb2xzXG4gKiBAcGFyYW0gY2hpbGRJZCAtIFRoZSBpZCB0byBtYXRjaFxuICovXG5leHBvcnQgZnVuY3Rpb24gdHJ5R2V0Rm9ySWQoY29udHJvbHM6IENvbnRyb2xbXSwgY2hpbGRJZD86IHN0cmluZykge1xuICAgIGlmIChjaGlsZElkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnRyb2xzLmZpbmQoYyA9PiBjLmlkID09PSBjaGlsZElkKTtcbn1cbiJdfQ==