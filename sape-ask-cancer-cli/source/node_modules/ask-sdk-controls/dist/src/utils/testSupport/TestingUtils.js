"use strict";
/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.SkillTester = exports.TestInput = exports.testTurn = exports.testE2E = exports.simpleInvoke = exports.findControlByProperty = exports.findControlById = exports.waitForDebugger = void 0;
const tslib_1 = require("tslib");
const ask_sdk_core_1 = require("ask-sdk-core");
const chai_1 = require("chai");
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const Logger_1 = require("../../logging/Logger");
const ControlHandler_1 = require("../../runtime/ControlHandler");
const IntentUtils_1 = require("../IntentUtils");
const SkillInvoker_1 = require("./SkillInvoker");
const SkillWrapper_1 = require("./SkillWrapper");
const ControlResult_1 = require("../../controls/ControlResult");
const log = new Logger_1.Logger('AskSdkControls:TestingUtils');
/**
 * Utility to sleep a short duration to give the debugger some time to get
 * ready. (otherwise a test will often run without hitting breakpoints)
 *
 * This is not necessary for vscode version 1.41.1 and above.
 */
let waitHasBeenDone = false;
function waitForDebugger() {
    if (!waitHasBeenDone) {
        Atomics.wait(new Int32Array(new SharedArrayBuffer(4)), 0, 0, 500);
        waitHasBeenDone = true;
    }
}
exports.waitForDebugger = waitForDebugger;
/**
 * Find the control with the specified id in the control tree
 * @param rootControl - Root control
 * @param id - Control id to search for
 */
function findControlById(rootControl, id) {
    return find(rootControl, 'id', id);
}
exports.findControlById = findControlById;
/**
 * Find the control with the specified property name and value in the control tree
 * @param rootControl - Root control
 * @param property - Property name
 * @param value - Property value
 */
function findControlByProperty(rootControl, property, value) {
    return find(rootControl, property, value);
}
exports.findControlByProperty = findControlByProperty;
/**
 * find the first sub-object in an object that has key = value.
 * e.g. to locating something by id:  find(myobj, "key", "theKey")
 * `{a:[{b:{key: "theKey", "value": "1"}}]}` returns `{key: "theKey", "value": "1"}`
 * @param object - Object
 * @param key - Key
 * @param value - Value
 */
function find(object, key, value) {
    if (typeof (object) !== "object") {
        return undefined;
    }
    if (object === null) {
        return undefined;
    }
    const theValue = object[key];
    if (theValue !== undefined && lodash_1.default.isEqual(theValue, value)) {
        return object;
    }
    // eslint-disable-next-line no-prototype-builtins
    const kidKeys = Object.keys(object).filter(key => object.hasOwnProperty(key));
    for (const kidKey of kidKeys) {
        const childObj = object[kidKey];
        if (typeof (childObj) === "object") {
            const result = find(childObj, key, value);
            if (result !== undefined) {
                return result;
            }
        }
    }
    return undefined;
}
/**
 * Invokes the core handling method of ControlHandler
 *
 * Purpose:
 * - for unit-testing the handling functionality (without rendering).
 *
 * @param rootControl - Root control
 * @param input - Input
 */
async function simpleInvoke(rootControl, input) {
    const resultBuilder = new ControlResult_1.ControlResultBuilder();
    await ControlHandler_1.ControlHandler.handleCore(rootControl, input, resultBuilder);
    return resultBuilder.build();
}
exports.simpleInvoke = simpleInvoke;
/**
 * Tests a multi-turn script, verifying that the correct prompts are produced on
 * each turn.
 *
 * For finer-grained control, for assertions and breakpoints, use a sequence
 * of calls to `testTurn`.
 *
 * Each user turn comprises three entries:
 * 1. The user utterance. This is not a functional parameter is for
 *    documentation / readability.
 * 2. The input object for the turn. This should be synchronized with the user-utterance.
 * 3. The expected response for the turn: prompt, set of allowed prompts or
 *    TestResponse object.
 *
 * The user utterance and expected prompt can start with 'U: ' and 'A: ' to aid readability.
 * @param turns - Array of 3 entries per logical turn.  [utterance, Intent]
 */
async function testE2E(handler, turns) {
    const invoker = new SkillInvoker_1.SkillInvoker(SkillWrapper_1.wrapRequestHandlerAsSkill(handler));
    for (let counter = 0; counter < turns.length; counter += 3) {
        const userUtterance = turns[counter];
        const input = turns[counter + 1];
        const expectedResponse = turns[counter + 2];
        if (typeof userUtterance !== 'string') {
            throw new Error('user utterance not found');
        }
        if (typeof input !== 'object') {
            throw new Error('nlu object not found');
        }
        if (userUtterance.toLowerCase().startsWith('a:')) {
            throw new Error(`user utterance starts with A: -->${userUtterance}`);
        }
        await testTurn(invoker, userUtterance, input, expectedResponse);
    }
}
exports.testE2E = testE2E;
/**
 * Test a single turn through the complete runtime flow
 *
 * @param invoker - SkillInvoker
 * @param utterance - Utterance. This is only for documentation / readability.
 * @param input - Input object
 * @param expectedResponse - The expected response: prompt, set of allowed
 *    prompts or TestResponse object.
 */
async function testTurn(invoker, utterance, input, expectedResponse) {
    const testResponse = await invoker.invoke(input);
    if (Array.isArray(expectedResponse)) {
        chai_1.expect(lodash_1.default.includes(expectedResponse, testResponse.prompt)).equals(true);
    }
    else {
        const expectedPrompt = typeof expectedResponse === 'string' ? expectedResponse : expectedResponse.prompt;
        if (!expectedPrompt.toLowerCase().startsWith('a:')) {
            throw new Error(`test configuration error: Alexa prompt should start with A: -->${expectedResponse}`);
        }
        if (testResponse.prompt !== expectedPrompt &&
            testResponse.prompt !== expectedPrompt.substr(2).trimLeft()) {
            chai_1.expect(testResponse.prompt).equals(expectedPrompt);
        }
        if (expectedResponse.directive) {
            if (!lodash_1.default.isEqual(testResponse.directive, expectedResponse.directive)) {
                chai_1.expect(testResponse.directive).deep.equals(expectedResponse.directive);
            }
        }
    }
    return testResponse;
}
exports.testTurn = testTurn;
/**
 * Utility to create Input objects for use in tests.
 */
class TestInput {
    /**
     * Reset the turn counter.
     */
    static reset() {
        this.turnNumber = 1;
    }
    /**
     * Creates a ControlInput for a given Intent-name or complete Intent object.
     */
    static of(nameOrIntent) {
        const input = TestInput.intent(nameOrIntent);
        this.turnNumber++;
        return input;
    }
    /**
     * Creates a ControlInput for a given Intent-name and slots, or complete Intent object.
     */
    static intent(nameOrIntent, slotValues) {
        const request = wrapIntentAsIntentRequest(nameOrIntent, slotValues);
        return dummyControlInput(request);
    }
    // public static intentWithMultiValueSlots(nameOrIntent: string | Intent, slotValues?: { [k: string]: any }): ControlInput {
    //     const request = wrapIntentAsIntentRequest(nameOrIntent, slotValues);
    //     return dummyControlInput(request);
    // }
    /**
     * Creates a ControlInput representing a LaunchRequest.
     */
    static launchRequest() {
        const launchRequest = {
            type: 'LaunchRequest',
            requestId: 'amzn1.echo-api.request.69ba9cb0-bdac-476c-9e35-b7c4382ef039',
            timestamp: '2019-09-04T00:08:32Z',
            locale: 'en-US',
        };
        return dummyControlInput(launchRequest);
    }
    /**
     * Creates a ControlInput for an APL User Event.
     */
    static userEvent(userEvent) {
        return dummyControlInput(userEvent);
    }
}
exports.TestInput = TestInput;
TestInput.turnNumber = 1;
// TODO: API: unify with SkillInvoker
/**
 * Utility to run tests on a Skill or RequestHandler.
 */
class SkillTester {
    constructor(skillOrRequestHandler) {
        this.invoker = new SkillInvoker_1.SkillInvoker(skillOrRequestHandler);
    }
    async testTurn(utterance, input, expectedPrompt) {
        return testTurn(this.invoker, utterance, input, expectedPrompt);
    }
}
exports.SkillTester = SkillTester;
function makeRequestId() {
    // example from live skill:'amzn1.echo-api.request.69ba9cb0-bdac-476c-9e35-b7c4382ef039'
    const id = `amzn1.echo-api.request.${Math.round(Math.random() * 1000000000).toString()}`;
    return id;
}
function wrapIntentAsIntentRequest(nameOrIntent, slotValues) {
    const intent = typeof nameOrIntent === 'string' ? IntentUtils_1.IntentBuilder.of(nameOrIntent, slotValues) : nameOrIntent;
    const intentRequest = {
        type: 'IntentRequest',
        requestId: makeRequestId(),
        timestamp: '2019-09-04T00:08:32Z',
        locale: 'en-US',
        dialogState: 'STARTED',
        intent
    };
    return intentRequest;
}
function dummyRequestEnvelope(request) {
    if (request === undefined) {
        request = {
            type: 'IntentRequest',
            requestId: makeRequestId(),
            timestamp: '',
            dialogState: 'IN_PROGRESS',
            intent: {
                name: '',
                confirmationStatus: 'NONE'
            }
        };
    }
    return {
        version: '',
        session: {
            new: true,
            application: {
                applicationId: '',
            },
            sessionId: '',
            user: {
                userId: ''
            },
        },
        context: {
            System: {
                application: {
                    applicationId: ''
                },
                user: {
                    userId: '',
                },
                apiEndpoint: '',
                device: {
                    deviceId: '',
                    supportedInterfaces: {
                        'Display': {
                            templateVersion: "1.0",
                            markupVersion: "1.0"
                        },
                        "Alexa.Presentation.APL": {
                            runtime: {
                                maxVersion: "1.3"
                            }
                        }
                    }
                }
            },
        },
        request
    };
}
function dummyControlInput(request) {
    const handlerInput = {
        requestEnvelope: dummyRequestEnvelope(request),
        context: {},
        attributesManager: dummyAttributesManager,
        responseBuilder: dummyResponseBuilder,
        serviceClientFactory: undefined
    };
    return {
        handlerInput,
        request: handlerInput.requestEnvelope.request,
        turnNumber: TestInput.turnNumber,
        controls: {}
    };
}
const dummyAttributesManager = ask_sdk_core_1.AttributesManagerFactory.init({ requestEnvelope: dummyRequestEnvelope() });
const dummyResponseBuilder = ask_sdk_core_1.ResponseFactory.init();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGVzdGluZ1V0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3V0aWxzL3Rlc3RTdXBwb3J0L1Rlc3RpbmdVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7Ozs7QUFHSCwrQ0FBb0k7QUFFcEksK0JBQThCO0FBQzlCLDREQUFtQztBQUtuQyxpREFBOEM7QUFDOUMsaUVBQThEO0FBQzlELGdEQUErQztBQUMvQyxpREFBa0U7QUFDbEUsaURBQTJEO0FBRzNELGdFQUFvRTtBQUVwRSxNQUFNLEdBQUcsR0FBRyxJQUFJLGVBQU0sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBRXREOzs7OztHQUtHO0FBQ0gsSUFBSSxlQUFlLEdBQUcsS0FBSyxDQUFDO0FBQzVCLFNBQWdCLGVBQWU7SUFDM0IsSUFBSSxDQUFDLGVBQWUsRUFBRTtRQUNsQixPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksVUFBVSxDQUFDLElBQUksaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2xFLGVBQWUsR0FBRyxJQUFJLENBQUM7S0FDMUI7QUFDTCxDQUFDO0FBTEQsMENBS0M7QUFFRDs7OztHQUlHO0FBQ0gsU0FBZ0IsZUFBZSxDQUFDLFdBQXFCLEVBQUUsRUFBVTtJQUM3RCxPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFGRCwwQ0FFQztBQUVEOzs7OztHQUtHO0FBQ0gsU0FBZ0IscUJBQXFCLENBQUMsV0FBcUIsRUFBRSxRQUFnQixFQUFFLEtBQVU7SUFDckYsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM5QyxDQUFDO0FBRkQsc0RBRUM7QUFFRDs7Ozs7OztHQU9HO0FBQ0gsU0FBUyxJQUFJLENBQUMsTUFBVyxF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RUFBRSxFQUFFO0tBQ2YsQ0FBQztBQUNOLENBQUM7QUFDRCxNQUFNLHNCQUFzQixHQUFzQix1Q0FBd0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxlQUFlLEVBQUUsb0JBQW9CLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDN0gsTUFBTSxvQkFBb0IsR0FBb0IsOEJBQWUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS5cbiAqIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIG9yIGluIHRoZSBcImxpY2Vuc2VcIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZFxuICogb24gYW4gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyXG4gKiBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZ1xuICogcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cblxuaW1wb3J0IHsgQXR0cmlidXRlc01hbmFnZXIsIEF0dHJpYnV0ZXNNYW5hZ2VyRmFjdG9yeSwgUmVxdWVzdEhhbmRsZXIsIFJlc3BvbnNlQnVpbGRlciwgUmVzcG9uc2VGYWN0b3J5LCBTa2lsbCB9IGZyb20gJ2Fzay1zZGstY29yZSc7XG5pbXBvcnQgeyBJbnRlbnQsIEludGVudFJlcXVlc3QsIGludGVyZmFjZXMsIExhdW5jaFJlcXVlc3QsIFJlcXVlc3QsIFJlcXVlc3RFbnZlbG9wZSB9IGZyb20gXCJhc2stc2RrLW1vZGVsXCI7XG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tIFwiY2hhaVwiO1xuaW1wb3J0IF8sIHsgaW52b2tlIH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgQ29udHJvbElucHV0IH0gZnJvbSAnLi4vLi4vY29udHJvbHMvQ29udHJvbElucHV0JztcbmltcG9ydCB7IElDb250cm9sIH0gZnJvbSAnLi4vLi4vY29udHJvbHMvaW50ZXJmYWNlcy9JQ29udHJvbCc7XG5pbXBvcnQgeyBJQ29udHJvbElucHV0IH0gZnJvbSAnLi4vLi4vY29udHJvbHMvaW50ZXJmYWNlcy9JQ29udHJvbElucHV0JztcbmltcG9ydCB7IElDb250cm9sUmVzdWx0IH0gZnJvbSAnLi4vLi4vY29udHJvbHMvaW50ZXJmYWNlcy9JQ29udHJvbFJlc3VsdCc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi8uLi9sb2dnaW5nL0xvZ2dlcic7XG5pbXBvcnQgeyBDb250cm9sSGFuZGxlciB9IGZyb20gJy4uLy4uL3J1bnRpbWUvQ29udHJvbEhhbmRsZXInO1xuaW1wb3J0IHsgSW50ZW50QnVpbGRlciB9IGZyb20gJy4uL0ludGVudFV0aWxzJztcbmltcG9ydCB7IFNraWxsSW52b2tlciwgVGVzdFJlc3BvbnNlT2JqZWN0IH0gZnJvbSAnLi9Ta2lsbEludm9rZXInO1xuaW1wb3J0IHsgd3JhcFJlcXVlc3RIYW5kbGVyQXNTa2lsbCB9IGZyb20gJy4vU2tpbGxXcmFwcGVyJztcbmltcG9ydCBVc2VyRXZlbnQgPSBpbnRlcmZhY2VzLmFsZXhhLnByZXNlbnRhdGlvbi5hcGwuVXNlckV2ZW50O1xuaW1wb3J0IHsgQ29udHJvbCB9IGZyb20gJy4uLy4uL2NvbnRyb2xzL0NvbnRyb2wnO1xuaW1wb3J0IHsgQ29udHJvbFJlc3VsdEJ1aWxkZXIgfSBmcm9tICcuLi8uLi9jb250cm9scy9Db250cm9sUmVzdWx0JztcblxuY29uc3QgbG9nID0gbmV3IExvZ2dlcignQXNrU2RrQ29udHJvbHM6VGVzdGluZ1V0aWxzJyk7XG5cbi8qKlxuICogVXRpbGl0eSB0byBzbGVlcCBhIHNob3J0IGR1cmF0aW9uIHRvIGdpdmUgdGhlIGRlYnVnZ2VyIHNvbWUgdGltZSB0byBnZXRcbiAqIHJlYWR5LiAob3RoZXJ3aXNlIGEgdGVzdCB3aWxsIG9mdGVuIHJ1biB3aXRob3V0IGhpdHRpbmcgYnJlYWtwb2ludHMpXG4gKlxuICogVGhpcyBpcyBub3QgbmVjZXNzYXJ5IGZvciB2c2NvZGUgdmVyc2lvbiAxLjQxLjEgYW5kIGFib3ZlLlxuICovXG5sZXQgd2FpdEhhc0JlZW5Eb25lID0gZmFsc2U7XG5leHBvcnQgZnVuY3Rpb24gd2FpdEZvckRlYnVnZ2VyKCkge1xuICAgIGlmICghd2FpdEhhc0JlZW5Eb25lKSB7XG4gICAgICAgIEF0b21pY3Mud2FpdChuZXcgSW50MzJBcnJheShuZXcgU2hhcmVkQXJyYXlCdWZmZXIoNCkpLCAwLCAwLCA1MDApO1xuICAgICAgICB3YWl0SGFzQmVlbkRvbmUgPSB0cnVlO1xuICAgIH1cbn1cblxuLyoqXG4gKiBGaW5kIHRoZSBjb250cm9sIHdpdGggdGhlIHNwZWNpZmllZCBpZCBpbiB0aGUgY29udHJvbCB0cmVlXG4gKiBAcGFyYW0gcm9vdENvbnRyb2wgLSBSb290IGNvbnRyb2xcbiAqIEBwYXJhbSBpZCAtIENvbnRyb2wgaWQgdG8gc2VhcmNoIGZvclxuICovXG5leHBvcnQgZnVuY3Rpb24gZmluZENvbnRyb2xCeUlkKHJvb3RDb250cm9sOiBJQ29udHJvbCwgaWQ6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIGZpbmQocm9vdENvbnRyb2wsICdpZCcsIGlkKTtcbn1cblxuLyoqXG4gKiBGaW5kIHRoZSBjb250cm9sIHdpdGggdGhlIHNwZWNpZmllZCBwcm9wZXJ0eSBuYW1lIGFuZCB2YWx1ZSBpbiB0aGUgY29udHJvbCB0cmVlXG4gKiBAcGFyYW0gcm9vdENvbnRyb2wgLSBSb290IGNvbnRyb2xcbiAqIEBwYXJhbSBwcm9wZXJ0eSAtIFByb3BlcnR5IG5hbWVcbiAqIEBwYXJhbSB2YWx1ZSAtIFByb3BlcnR5IHZhbHVlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQ29udHJvbEJ5UHJvcGVydHkocm9vdENvbnRyb2w6IElDb250cm9sLCBwcm9wZXJ0eTogc3RyaW5nLCB2YWx1ZTogYW55KTogYW55IHtcbiAgICByZXR1cm4gZmluZChyb290Q29udHJvbCwgcHJvcGVydHksIHZhbHVlKTtcbn1cblxuLyoqXG4gKiBmaW5kIHRoZSBmaXJzdCBzdWItb2JqZWN0IGluIGFuIG9iamVjdCB0aGF0IGhhcyBrZXkgPSB2YWx1ZS5cbiAqIGUuZy4gdG8gbG9jYXRpbmcgc29tZXRoaW5nIGJ5IGlkOiAgZmluZChteW9iaiwgXCJrZXlcIiwgXCJ0aGVLZXlcIilcbiAqIGB7YTpbe2I6e2tleTogXCJ0aGVLZXlcIiwgXCJ2YWx1ZVwiOiBcIjFcIn19XX1gIHJldHVybnMgYHtrZXk6IFwidGhlS2V5XCIsIFwidmFsdWVcIjogXCIxXCJ9YFxuICogQHBhcmFtIG9iamVjdCAtIE9iamVjdFxuICogQHBhcmFtIGtleSAtIEtleVxuICogQHBhcmFtIHZhbHVlIC0gVmFsdWVcbiAqL1xuZnVuY3Rpb24gZmluZChvYmplY3Q6IGFueSwga2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIGlmICh0eXBlb2YgKG9iamVjdCkgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKG9iamVjdCA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCB0aGVWYWx1ZSA9IG9iamVjdFtrZXldO1xuICAgIGlmICh0aGVWYWx1ZSAhPT0gdW5kZWZpbmVkICYmIF8uaXNFcXVhbCh0aGVWYWx1ZSwgdmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBvYmplY3Q7XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgIGNvbnN0IGtpZEtleXMgPSBPYmplY3Qua2V5cyhvYmplY3QpLmZpbHRlcihrZXkgPT4gb2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpO1xuICAgIGZvciAoY29uc3Qga2lkS2V5IG9mIGtpZEtleXMpIHtcbiAgICAgICAgY29uc3QgY2hpbGRPYmogPSBvYmplY3Rba2lkS2V5XTtcbiAgICAgICAgaWYgKHR5cGVvZiAoY2hpbGRPYmopID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBmaW5kKGNoaWxkT2JqLCBrZXksIHZhbHVlKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuLyoqXG4gKiBJbnZva2VzIHRoZSBjb3JlIGhhbmRsaW5nIG1ldGhvZCBvZiBDb250cm9sSGFuZGxlclxuICpcbiAqIFB1cnBvc2U6XG4gKiAtIGZvciB1bml0LXRlc3RpbmcgdGhlIGhhbmRsaW5nIGZ1bmN0aW9uYWxpdHkgKHdpdGhvdXQgcmVuZGVyaW5nKS5cbiAqXG4gKiBAcGFyYW0gcm9vdENvbnRyb2wgLSBSb290IGNvbnRyb2xcbiAqIEBwYXJhbSBpbnB1dCAtIElucHV0XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzaW1wbGVJbnZva2Uocm9vdENvbnRyb2w6IENvbnRyb2wsIGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPElDb250cm9sUmVzdWx0PiB7XG4gICAgY29uc3QgcmVzdWx0QnVpbGRlciA9IG5ldyBDb250cm9sUmVzdWx0QnVpbGRlcigpO1xuICAgIGF3YWl0IENvbnRyb2xIYW5kbGVyLmhhbmRsZUNvcmUocm9vdENvbnRyb2wsIGlucHV0LCByZXN1bHRCdWlsZGVyKTtcbiAgICByZXR1cm4gcmVzdWx0QnVpbGRlci5idWlsZCgpO1xufVxuXG4vKipcbiAqIFRlc3RzIGEgbXVsdGktdHVybiBzY3JpcHQsIHZlcmlmeWluZyB0aGF0IHRoZSBjb3JyZWN0IHByb21wdHMgYXJlIHByb2R1Y2VkIG9uXG4gKiBlYWNoIHR1cm4uXG4gKlxuICogRm9yIGZpbmVyLWdyYWluZWQgY29udHJvbCwgZm9yIGFzc2VydGlvbnMgYW5kIGJyZWFrcG9pbnRzLCB1c2UgYSBzZXF1ZW5jZVxuICogb2YgY2FsbHMgdG8gYHRlc3RUdXJuYC5cbiAqXG4gKiBFYWNoIHVzZXIgdHVybiBjb21wcmlzZXMgdGhyZWUgZW50cmllczpcbiAqIDEuIFRoZSB1c2VyIHV0dGVyYW5jZS4gVGhpcyBpcyBub3QgYSBmdW5jdGlvbmFsIHBhcmFtZXRlciBpcyBmb3JcbiAqICAgIGRvY3VtZW50YXRpb24gLyByZWFkYWJpbGl0eS5cbiAqIDIuIFRoZSBpbnB1dCBvYmplY3QgZm9yIHRoZSB0dXJuLiBUaGlzIHNob3VsZCBiZSBzeW5jaHJvbml6ZWQgd2l0aCB0aGUgdXNlci11dHRlcmFuY2UuXG4gKiAzLiBUaGUgZXhwZWN0ZWQgcmVzcG9uc2UgZm9yIHRoZSB0dXJuOiBwcm9tcHQsIHNldCBvZiBhbGxvd2VkIHByb21wdHMgb3JcbiAqICAgIFRlc3RSZXNwb25zZSBvYmplY3QuXG4gKlxuICogVGhlIHVzZXIgdXR0ZXJhbmNlIGFuZCBleHBlY3RlZCBwcm9tcHQgY2FuIHN0YXJ0IHdpdGggJ1U6ICcgYW5kICdBOiAnIHRvIGFpZCByZWFkYWJpbGl0eS5cbiAqIEBwYXJhbSB0dXJucyAtIEFycmF5IG9mIDMgZW50cmllcyBwZXIgbG9naWNhbCB0dXJuLiAgW3V0dGVyYW5jZSwgSW50ZW50XVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdGVzdEUyRShoYW5kbGVyOiBDb250cm9sSGFuZGxlciwgdHVybnM6IEFycmF5PHN0cmluZyB8IHN0cmluZ1tdIHwgSUNvbnRyb2xJbnB1dCB8IFRlc3RSZXNwb25zZU9iamVjdD4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBpbnZva2VyID0gbmV3IFNraWxsSW52b2tlcih3cmFwUmVxdWVzdEhhbmRsZXJBc1NraWxsKGhhbmRsZXIpKTtcbiAgICBmb3IgKGxldCBjb3VudGVyID0gMDsgY291bnRlciA8IHR1cm5zLmxlbmd0aDsgY291bnRlciArPSAzKSB7XG4gICAgICAgIGNvbnN0IHVzZXJVdHRlcmFuY2UgPSB0dXJuc1tjb3VudGVyXTtcbiAgICAgICAgY29uc3QgaW5wdXQgPSB0dXJuc1tjb3VudGVyICsgMV0gYXMgSUNvbnRyb2xJbnB1dDtcbiAgICAgICAgY29uc3QgZXhwZWN0ZWRSZXNwb25zZSA9IHR1cm5zW2NvdW50ZXIgKyAyXSBhcyBzdHJpbmcgfCBzdHJpbmdbXSB8IFRlc3RSZXNwb25zZU9iamVjdDtcblxuICAgICAgICBpZiAodHlwZW9mIHVzZXJVdHRlcmFuY2UgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3VzZXIgdXR0ZXJhbmNlIG5vdCBmb3VuZCcpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgaW5wdXQgIT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25sdSBvYmplY3Qgbm90IGZvdW5kJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVzZXJVdHRlcmFuY2UudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCdhOicpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVzZXIgdXR0ZXJhbmNlIHN0YXJ0cyB3aXRoIEE6IC0tPiR7IHVzZXJVdHRlcmFuY2V9YCk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGVzdFR1cm4oaW52b2tlciwgdXNlclV0dGVyYW5jZSwgaW5wdXQsIGV4cGVjdGVkUmVzcG9uc2UpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBUZXN0IGEgc2luZ2xlIHR1cm4gdGhyb3VnaCB0aGUgY29tcGxldGUgcnVudGltZSBmbG93XG4gKlxuICogQHBhcmFtIGludm9rZXIgLSBTa2lsbEludm9rZXJcbiAqIEBwYXJhbSB1dHRlcmFuY2UgLSBVdHRlcmFuY2UuIFRoaXMgaXMgb25seSBmb3IgZG9jdW1lbnRhdGlvbiAvIHJlYWRhYmlsaXR5LlxuICogQHBhcmFtIGlucHV0IC0gSW5wdXQgb2JqZWN0XG4gKiBAcGFyYW0gZXhwZWN0ZWRSZXNwb25zZSAtIFRoZSBleHBlY3RlZCByZXNwb25zZTogcHJvbXB0LCBzZXQgb2YgYWxsb3dlZFxuICogICAgcHJvbXB0cyBvciBUZXN0UmVzcG9uc2Ugb2JqZWN0LlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdGVzdFR1cm4oaW52b2tlcjogU2tpbGxJbnZva2VyLCB1dHRlcmFuY2U6IHN0cmluZywgaW5wdXQ6IElDb250cm9sSW5wdXQsIGV4cGVjdGVkUmVzcG9uc2U6IHN0cmluZyB8IHN0cmluZ1tdIHwgVGVzdFJlc3BvbnNlT2JqZWN0KTogUHJvbWlzZTxUZXN0UmVzcG9uc2VPYmplY3Q+IHtcbiAgICBjb25zdCB0ZXN0UmVzcG9uc2UgPSBhd2FpdCBpbnZva2VyLmludm9rZShpbnB1dCk7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZXhwZWN0ZWRSZXNwb25zZSkpIHtcbiAgICAgICAgZXhwZWN0KF8uaW5jbHVkZXMoZXhwZWN0ZWRSZXNwb25zZSwgdGVzdFJlc3BvbnNlLnByb21wdCkpLmVxdWFscyh0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBleHBlY3RlZFByb21wdDogc3RyaW5nID0gdHlwZW9mIGV4cGVjdGVkUmVzcG9uc2UgPT09ICdzdHJpbmcnID8gZXhwZWN0ZWRSZXNwb25zZSA6IGV4cGVjdGVkUmVzcG9uc2UucHJvbXB0O1xuICAgICAgICBpZiAoIWV4cGVjdGVkUHJvbXB0LnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnYTonKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0ZXN0IGNvbmZpZ3VyYXRpb24gZXJyb3I6IEFsZXhhIHByb21wdCBzaG91bGQgc3RhcnQgd2l0aCBBOiAtLT4keyBleHBlY3RlZFJlc3BvbnNlfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRlc3RSZXNwb25zZS5wcm9tcHQgIT09IGV4cGVjdGVkUHJvbXB0ICYmXG4gICAgICAgICAgICB0ZXN0UmVzcG9uc2UucHJvbXB0ICE9PSBleHBlY3RlZFByb21wdC5zdWJzdHIoMikudHJpbUxlZnQoKSkge1xuICAgICAgICAgICAgZXhwZWN0KHRlc3RSZXNwb25zZS5wcm9tcHQpLmVxdWFscyhleHBlY3RlZFByb21wdCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoKGV4cGVjdGVkUmVzcG9uc2UgYXMgVGVzdFJlc3BvbnNlT2JqZWN0KS5kaXJlY3RpdmUpIHtcbiAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKHRlc3RSZXNwb25zZS5kaXJlY3RpdmUsIChleHBlY3RlZFJlc3BvbnNlIGFzIGFueSkuZGlyZWN0aXZlKSkge1xuICAgICAgICAgICAgICAgIGV4cGVjdCh0ZXN0UmVzcG9uc2UuZGlyZWN0aXZlKS5kZWVwLmVxdWFscygoZXhwZWN0ZWRSZXNwb25zZSBhcyBUZXN0UmVzcG9uc2VPYmplY3QpLmRpcmVjdGl2ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRlc3RSZXNwb25zZTtcbn1cblxuLyoqXG4gKiBVdGlsaXR5IHRvIGNyZWF0ZSBJbnB1dCBvYmplY3RzIGZvciB1c2UgaW4gdGVzdHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBUZXN0SW5wdXQge1xuICAgIHN0YXRpYyB0dXJuTnVtYmVyID0gMTtcblxuICAgIC8qKlxuICAgICAqIFJlc2V0IHRoZSB0dXJuIGNvdW50ZXIuXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyByZXNldCgpIHtcbiAgICAgICAgdGhpcy50dXJuTnVtYmVyID0gMTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgQ29udHJvbElucHV0IGZvciBhIGdpdmVuIEludGVudC1uYW1lIG9yIGNvbXBsZXRlIEludGVudCBvYmplY3QuXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBvZihuYW1lT3JJbnRlbnQ6IEludGVudCk6IENvbnRyb2xJbnB1dCB7XG4gICAgICAgIGNvbnN0IGlucHV0ID0gVGVzdElucHV0LmludGVudChuYW1lT3JJbnRlbnQpO1xuICAgICAgICB0aGlzLnR1cm5OdW1iZXIrKztcbiAgICAgICAgcmV0dXJuIGlucHV0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBDb250cm9sSW5wdXQgZm9yIGEgZ2l2ZW4gSW50ZW50LW5hbWUgYW5kIHNsb3RzLCBvciBjb21wbGV0ZSBJbnRlbnQgb2JqZWN0LlxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgaW50ZW50KG5hbWVPckludGVudDogc3RyaW5nIHwgSW50ZW50LCBzbG90VmFsdWVzPzogeyBbazogc3RyaW5nXTogYW55IH0pOiBDb250cm9sSW5wdXQge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gd3JhcEludGVudEFzSW50ZW50UmVxdWVzdChuYW1lT3JJbnRlbnQsIHNsb3RWYWx1ZXMpO1xuXG4gICAgICAgIHJldHVybiBkdW1teUNvbnRyb2xJbnB1dChyZXF1ZXN0KTtcbiAgICB9XG5cbiAgICAvLyBwdWJsaWMgc3RhdGljIGludGVudFdpdGhNdWx0aVZhbHVlU2xvdHMobmFtZU9ySW50ZW50OiBzdHJpbmcgfCBJbnRlbnQsIHNsb3RWYWx1ZXM/OiB7IFtrOiBzdHJpbmddOiBhbnkgfSk6IENvbnRyb2xJbnB1dCB7XG4gICAgLy8gICAgIGNvbnN0IHJlcXVlc3QgPSB3cmFwSW50ZW50QXNJbnRlbnRSZXF1ZXN0KG5hbWVPckludGVudCwgc2xvdFZhbHVlcyk7XG5cbiAgICAvLyAgICAgcmV0dXJuIGR1bW15Q29udHJvbElucHV0KHJlcXVlc3QpO1xuICAgIC8vIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBDb250cm9sSW5wdXQgcmVwcmVzZW50aW5nIGEgTGF1bmNoUmVxdWVzdC5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGxhdW5jaFJlcXVlc3QoKTogQ29udHJvbElucHV0IHtcblxuICAgICAgICBjb25zdCBsYXVuY2hSZXF1ZXN0OiBMYXVuY2hSZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdHlwZTogJ0xhdW5jaFJlcXVlc3QnLFxuICAgICAgICAgICAgcmVxdWVzdElkOiAnYW16bjEuZWNoby1hcGkucmVxdWVzdC42OWJhOWNiMC1iZGFjLTQ3NmMtOWUzNS1iN2M0MzgyZWYwMzknLFxuICAgICAgICAgICAgdGltZXN0YW1wOiAnMjAxOS0wOS0wNFQwMDowODozMlonLFxuICAgICAgICAgICAgbG9jYWxlOiAnZW4tVVMnLFxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBkdW1teUNvbnRyb2xJbnB1dChsYXVuY2hSZXF1ZXN0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgQ29udHJvbElucHV0IGZvciBhbiBBUEwgVXNlciBFdmVudC5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHVzZXJFdmVudCh1c2VyRXZlbnQ6IFVzZXJFdmVudCk6IENvbnRyb2xJbnB1dHtcblxuICAgICAgICByZXR1cm4gZHVtbXlDb250cm9sSW5wdXQodXNlckV2ZW50KTtcbiAgICB9XG59XG5cblxuLy8gVE9ETzogQVBJOiB1bmlmeSB3aXRoIFNraWxsSW52b2tlclxuLyoqXG4gKiBVdGlsaXR5IHRvIHJ1biB0ZXN0cyBvbiBhIFNraWxsIG9yIFJlcXVlc3RIYW5kbGVyLlxuICovXG5leHBvcnQgY2xhc3MgU2tpbGxUZXN0ZXIge1xuICAgIGludm9rZXI6IFNraWxsSW52b2tlcjtcblxuICAgIGNvbnN0cnVjdG9yKHNraWxsT3JSZXF1ZXN0SGFuZGxlcjogU2tpbGwgfCBSZXF1ZXN0SGFuZGxlcil7XG4gICAgICAgIHRoaXMuaW52b2tlciA9IG5ldyBTa2lsbEludm9rZXIoc2tpbGxPclJlcXVlc3RIYW5kbGVyKTtcbiAgICB9XG5cbiAgICBhc3luYyB0ZXN0VHVybih1dHRlcmFuY2U6IHN0cmluZywgaW5wdXQ6IENvbnRyb2xJbnB1dCwgZXhwZWN0ZWRQcm9tcHQ6IHN0cmluZyk6IFByb21pc2U8VGVzdFJlc3BvbnNlT2JqZWN0PiB7XG4gICAgICAgIHJldHVybiB0ZXN0VHVybih0aGlzLmludm9rZXIsIHV0dGVyYW5jZSwgaW5wdXQsIGV4cGVjdGVkUHJvbXB0KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VSZXF1ZXN0SWQoKXtcbiAgICAvLyBleGFtcGxlIGZyb20gbGl2ZSBza2lsbDonYW16bjEuZWNoby1hcGkucmVxdWVzdC42OWJhOWNiMC1iZGFjLTQ3NmMtOWUzNS1iN2M0MzgyZWYwMzknXG4gICAgY29uc3QgaWQgPSBgYW16bjEuZWNoby1hcGkucmVxdWVzdC4keyBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiAxMDAwMDAwMDAwKS50b1N0cmluZygpfWA7XG4gICAgcmV0dXJuIGlkO1xufVxuXG5cblxuZnVuY3Rpb24gd3JhcEludGVudEFzSW50ZW50UmVxdWVzdChuYW1lT3JJbnRlbnQ6IHN0cmluZyB8IEludGVudCwgc2xvdFZhbHVlcz86IHsgW2s6IHN0cmluZ106IGFueSB9KTogSW50ZW50UmVxdWVzdCB7XG4gICAgY29uc3QgaW50ZW50ID0gdHlwZW9mIG5hbWVPckludGVudCA9PT0gJ3N0cmluZycgPyBJbnRlbnRCdWlsZGVyLm9mKG5hbWVPckludGVudCwgc2xvdFZhbHVlcykgOiBuYW1lT3JJbnRlbnQ7XG5cbiAgICBjb25zdCBpbnRlbnRSZXF1ZXN0OiBJbnRlbnRSZXF1ZXN0ID0ge1xuICAgICAgICB0eXBlOiAnSW50ZW50UmVxdWVzdCcsXG4gICAgICAgIHJlcXVlc3RJZDogbWFrZVJlcXVlc3RJZCgpLFxuICAgICAgICB0aW1lc3RhbXA6ICcyMDE5LTA5LTA0VDAwOjA4OjMyWicsXG4gICAgICAgIGxvY2FsZTogJ2VuLVVTJyxcbiAgICAgICAgZGlhbG9nU3RhdGU6ICdTVEFSVEVEJyxcbiAgICAgICAgaW50ZW50XG4gICAgfTtcblxuICAgIHJldHVybiBpbnRlbnRSZXF1ZXN0O1xufVxuXG5mdW5jdGlvbiBkdW1teVJlcXVlc3RFbnZlbG9wZShyZXF1ZXN0PzogUmVxdWVzdCk6IFJlcXVlc3RFbnZlbG9wZSB7XG4gICAgaWYgKHJlcXVlc3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdHlwZTogJ0ludGVudFJlcXVlc3QnLFxuICAgICAgICAgICAgcmVxdWVzdElkOiBtYWtlUmVxdWVzdElkKCksXG4gICAgICAgICAgICB0aW1lc3RhbXA6ICcnLFxuICAgICAgICAgICAgZGlhbG9nU3RhdGU6ICdJTl9QUk9HUkVTUycsXG4gICAgICAgICAgICBpbnRlbnQ6IHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnJyxcbiAgICAgICAgICAgICAgICBjb25maXJtYXRpb25TdGF0dXM6ICdOT05FJ1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIHZlcnNpb246ICcnLFxuICAgICAgICBzZXNzaW9uOiB7XG4gICAgICAgICAgICBuZXc6IHRydWUsXG4gICAgICAgICAgICBhcHBsaWNhdGlvbjoge1xuICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uSWQ6ICcnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNlc3Npb25JZDogJycsXG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgdXNlcklkOiAnJ1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgICAgU3lzdGVtOiB7XG4gICAgICAgICAgICAgICAgYXBwbGljYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb25JZDogJydcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkOiAnJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGFwaUVuZHBvaW50OiAnJyxcbiAgICAgICAgICAgICAgICBkZXZpY2U6IHtcbiAgICAgICAgICAgICAgICAgICAgZGV2aWNlSWQ6ICcnLFxuICAgICAgICAgICAgICAgICAgICBzdXBwb3J0ZWRJbnRlcmZhY2VzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnRGlzcGxheSc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVZlcnNpb246IFwiMS4wXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya3VwVmVyc2lvbjogXCIxLjBcIlxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiQWxleGEuUHJlc2VudGF0aW9uLkFQTFwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVudGltZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhWZXJzaW9uOiBcIjEuM1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcmVxdWVzdFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIGR1bW15Q29udHJvbElucHV0KHJlcXVlc3Q/OiBSZXF1ZXN0KTogQ29udHJvbElucHV0IHtcblxuICAgIGNvbnN0IGhhbmRsZXJJbnB1dCA9IHtcbiAgICAgICAgcmVxdWVzdEVudmVsb3BlOiBkdW1teVJlcXVlc3RFbnZlbG9wZShyZXF1ZXN0KSxcbiAgICAgICAgY29udGV4dDoge30sXG4gICAgICAgIGF0dHJpYnV0ZXNNYW5hZ2VyOiBkdW1teUF0dHJpYnV0ZXNNYW5hZ2VyLFxuICAgICAgICByZXNwb25zZUJ1aWxkZXI6IGR1bW15UmVzcG9uc2VCdWlsZGVyLFxuICAgICAgICBzZXJ2aWNlQ2xpZW50RmFjdG9yeTogdW5kZWZpbmVkXG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIGhhbmRsZXJJbnB1dCxcbiAgICAgICAgcmVxdWVzdDogaGFuZGxlcklucHV0LnJlcXVlc3RFbnZlbG9wZS5yZXF1ZXN0LFxuICAgICAgICB0dXJuTnVtYmVyOiBUZXN0SW5wdXQudHVybk51bWJlcixcbiAgICAgICAgY29udHJvbHM6IHt9XG4gICAgfTtcbn1cbmNvbnN0IGR1bW15QXR0cmlidXRlc01hbmFnZXI6IEF0dHJpYnV0ZXNNYW5hZ2VyID0gQXR0cmlidXRlc01hbmFnZXJGYWN0b3J5LmluaXQoeyByZXF1ZXN0RW52ZWxvcGU6IGR1bW15UmVxdWVzdEVudmVsb3BlKCkgfSk7XG5jb25zdCBkdW1teVJlc3BvbnNlQnVpbGRlcjogUmVzcG9uc2VCdWlsZGVyID0gUmVzcG9uc2VGYWN0b3J5LmluaXQoKTtcbiJdfQ==