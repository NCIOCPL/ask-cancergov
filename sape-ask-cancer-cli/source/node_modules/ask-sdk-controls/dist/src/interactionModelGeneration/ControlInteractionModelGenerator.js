"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateModelData = exports.ControlInteractionModelGenerator = void 0;
const tslib_1 = require("tslib");
const i18next_1 = tslib_1.__importDefault(require("i18next"));
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const ConjunctionControlIntent_1 = require("../intents/ConjunctionControlIntent");
const DateRangeControlIntent_1 = require("../intents/DateRangeControlIntent");
const GeneralControlIntent_1 = require("../intents/GeneralControlIntent");
const OrdinalControlIntent_1 = require("../intents/OrdinalControlIntent");
const SingleValueControlIntent_1 = require("../intents/SingleValueControlIntent");
const Logger_1 = require("../logging/Logger");
const InteractionModelGenerator_1 = require("./InteractionModelGenerator");
const ModelTypes_1 = require("./ModelTypes");
const log = new Logger_1.Logger('AskSdkControls:ControlInteractionModelGenerator');
const dummyPrompts = [
    {
        id: "Slot.Validation.564246223579.1467418044248.678461230495",
        variations: [
            {
                type: "PlainText",
                value: "This prompt is included to ensure there is a dialog model present. It is not used by skills."
            }
        ]
    }
];
/**
 * Interaction model generator for skills that use the Controls Framework
 *
 * This class extends `InteractionModelGenerator` with Controls-specific functionality.
 */
class ControlInteractionModelGenerator extends InteractionModelGenerator_1.InteractionModelGenerator {
    constructor() {
        super(...arguments);
        this.targetSlotIds = new Set();
    }
    /**
     * Update the interaction model for a controlManager
     *
     * Behavior:
     * - Calls `controlManager.buildInteractionModel` to update the IM And add
     *   dummy dialogModel if SimpleControlIntent is used in control
     *
     * Usage: If the ControlManager is lacking data for the chosen locale, the
     * appropriate data should be add by user themselves User would need to
     * update the ModelDataMap instance and provide it to ControlManager's
     * constructor
     * @param controlManager - Control manager
     */
    buildCoreModelForControls(controlManager) {
        controlManager.buildInteractionModel(this);
        ensureDialogModel(this, this.intents);
        return this;
    }
    // tsDoc - see InteractionModelGenerator
    build() {
        const interactionModelData = super.build();
        validateTargetSlots(interactionModelData, this.targetSlotIds);
        return interactionModelData;
    }
    /**
     * Add AMAZON.YesIntent and AMAZON.NoIntent to the interaction model.
     */
    addYesAndNoIntents() {
        this.addIntent({ name: 'AMAZON.YesIntent' });
        this.addIntent({ name: 'AMAZON.NoIntent' });
        return this;
    }
    /**
     * Adds the information from a ControlIntent to the interaction model.
     *
     * @param controlIntent - ControlIntent that extends `BaseControlIntent`
     * @param controlIMData - Localization data for built-ins.
     */
    addControlIntent(controlIntent, controlIMData) {
        var _a;
        // used to record all present basic slotTypes
        const presentSlotTypesSet = new Set();
        const controlIntentUtterances = generateCompleteIntent(controlIntent, controlIMData);
        this.addIntents(controlIntentUtterances);
        (_a = controlIntentUtterances.slots) === null || _a === void 0 ? void 0 : _a.map((slot) => {
            presentSlotTypesSet.add(slot.name);
        });
        // Loop all SharedSlotTypes
        // if it present in the set, add slotTypes to IM
        for (const slotTypeName of Object.values(ModelTypes_1.SharedSlotType)) {
            // The slotType get from ControlIntent is just a skeleton without values
            // The complete definition should be found in controlIMData
            if (presentSlotTypesSet.has(slotTypeName)) {
                const slotTypes = controlIMData.slotTypes.find((slotType) => slotType.name === slotTypeName);
                if (!slotTypes) {
                    throw new Error(`SlotType ${slotTypeName} doesn't have values registered in the ModelData.`);
                }
                this.addOrMergeSlotTypes(slotTypes);
            }
        }
        return this;
    }
}
exports.ControlInteractionModelGenerator = ControlInteractionModelGenerator;
// Convert Intent to DialogIntent
function buildDialogIntent(intent) {
    const dialogIntent = lodash_1.default.cloneDeep(intent);
    delete dialogIntent.samples;
    dialogIntent.delegationStrategy = 'SKILL_RESPONSE';
    return dialogIntent;
}
/**
 * Generate complete intent with intent samples attached
 * @param controlIntent - ControlIntent
 * @param controlIMData - Localization data
 */
function generateCompleteIntent(controlIntent, controlIMData) {
    var _a;
    // Special logic for SingleValueControlIntent
    if (controlIntent.name.includes('ValueControlIntent')) {
        return handleValueControlIntent(controlIntent, controlIMData);
    }
    const intent = controlIntent.generateIntent();
    const samples = (_a = controlIMData.intentValues.find((intentValue) => intentValue.name === controlIntent.name)) === null || _a === void 0 ? void 0 : _a.samples;
    if (samples === undefined) {
        throw new Error(`${controlIntent.name} doesn't have samples registered in the ModelData.`);
    }
    intent.samples = samples;
    return intent;
}
// special handling for ValueControlIntent
function handleValueControlIntent(controlIntent, controlIMData) {
    var _a;
    const intent = controlIntent.generateIntent();
    const samples = (_a = controlIMData.intentValues.find((intentValue) => intentValue.name === SingleValueControlIntent_1.SingleValueControlIntent.name)) === null || _a === void 0 ? void 0 : _a.samples;
    if (samples === undefined) {
        throw new Error('Can not find SingleValueControlIntent samples in ModelData');
    }
    const slotType = controlIntent.valueSlotType;
    const replacement = `{${slotType}}`;
    intent.samples = intent.samples || [];
    samples.map((sample) => {
        intent.samples.push(sample.replace('[[valueSlotType]]', replacement));
    });
    return intent;
}
// This method adds a dummy dialogModel so that Dialog directives such as Dialog.ElicitSlotDirective can be used.
// 1. Add dummy validation rule to SimpleControlIntent' target slot
// 2. Add dummy prompt
function ensureDialogModel(generator, intents) {
    var _a;
    // Since one dummy validation is enough to meet slotElicitation requirement
    // And all the builtin controls integrate with the SimpleControlIntent
    // Thus add this dummy validation to the first target type slotType
    const simpleControlIntent = intents.find((intent) => intent.name === GeneralControlIntent_1.GeneralControlIntent.name);
    if (!simpleControlIntent) {
        return;
    }
    const dialogSimpleControlIntent = buildDialogIntent(simpleControlIntent);
    generator.addDialogIntents(dialogSimpleControlIntent);
    const targetSlot = (_a = dialogSimpleControlIntent.slots) === null || _a === void 0 ? void 0 : _a.find((slot) => slot.type === 'target');
    if (targetSlot === undefined) {
        throw new Error('target slot is not present in SimpleControlIntent');
    }
    addDummyValidationRule(targetSlot);
    generator.addPrompts(...dummyPrompts);
}
/**
 *  Add dummy dialog validation rule to the input slot.
 * @param targetSlot - Target slot
 */
function addDummyValidationRule(targetSlot) {
    targetSlot.elicitationRequired = false;
    targetSlot.confirmationRequired = false;
    // The particular dummy model comprises a single slot-validation that will always pass.
    targetSlot.validations = [{
            type: "isNotInSet",
            prompt: "Slot.Validation.564246223579.1467418044248.678461230495",
            values: [
                "This prompt is included to ensure there is a dialog model present. It is not used by skills."
            ]
        }];
}
/**
 * Validate the target slotIds in Controls are present in InteractionModel.
 * @param interactionModel - Interaction model
 * @param targetSlotIDs - Target slot IDs
 */
function validateTargetSlots(interactionModel, targetSlotIds) {
    var _a, _b;
    const presentSlotTypes = (_b = (_a = interactionModel.interactionModel) === null || _a === void 0 ? void 0 : _a.languageModel) === null || _b === void 0 ? void 0 : _b.types;
    for (const targetSlotId of targetSlotIds) {
        if (presentSlotTypes === undefined) {
            log.warn(`target slot with id ${targetSlotId} is not present in InteractionModel.`);
            continue;
        }
        const match = presentSlotTypes.find((slotType) => { var _a; return (_a = slotType.values) === null || _a === void 0 ? void 0 : _a.find((value) => value.id === targetSlotId); });
        if (match === undefined) {
            log.warn(`target slot with id ${targetSlotId} is not present in InteractionModel.`);
        }
    }
}
/**
 * Generate the modelData Object by reading the i18n instance.
 *
 * This is the consolidated localization information for the built-ins.  This
 * data is not included in the generated interaction model unless the components
 * are actually used. I.e. this is a map of data from which to extract bits
 * and pieces as needed.
 */
function generateModelData() {
    const slotTypes = [];
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_FEEDBACK', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_HEAD', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_TAIL', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_CONJUNCTION', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_PREPOSITION', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_ACTION', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_TARGET', { returnObjects: true }));
    const intentValues = [];
    intentValues.push({
        name: ConjunctionControlIntent_1.ConjunctionControlIntent.name,
        samples: i18next_1.default.t('CONJUNCTION_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: DateRangeControlIntent_1.DateRangeControlIntent.name,
        samples: i18next_1.default.t('DATE_RANGE_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: GeneralControlIntent_1.GeneralControlIntent.name,
        samples: i18next_1.default.t('GENERAL_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: OrdinalControlIntent_1.OrdinalControlIntent.name,
        samples: i18next_1.default.t('ORDINAL_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: SingleValueControlIntent_1.SingleValueControlIntent.name,
        samples: i18next_1.default.t('SINGLE_VALUE_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    return {
        slotTypes,
        intentValues
    };
}
exports.generateModelData = generateModelData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRpb24vQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQWFBLDhEQUE4QjtBQUM5Qiw0REFBdUI7QUFHdkIsa0ZBQStFO0FBQy9FLDhFQUEyRTtBQUMzRSwwRUFBdUU7QUFDdkUsMEVBQXVFO0FBQ3ZFLGtGQUErRTtBQUMvRSw4Q0FBMkM7QUFDM0MsMkVBQXdFO0FBQ3hFLDZDQUEyRTtBQVEzRSxNQUFNLEdBQUcsR0FBRyxJQUFJLGVBQU0sQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO0FBRTFFLE1BQU0sWUFBWSxHQUFhO0lBQzNCO1FBQ0ksRUFBRSxFQUFFLHlEQUF5RDtRQUM3RCxVQUFVLEVBQUU7WUFDUjtnQkFDSSxJQUFJLEVBQUUsV0FBVztnQkFDakIsS0FBSyxFQUFFLDhGQUE4RjthQUN4RztTQUNKO0tBQ0o7Q0FDSixDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQWEsZ0NBQWlDLFNBQVEscURBQXlCO0lBQS9FOztRQUNXLGtCQUFhLEdBQWdCLElBQUksR0FBRyxFQUFFLENBQUM7SUF1RWxELENBQUM7SUFyRUc7Ozs7Ozs7Ozs7OztPQVlHO0lBQ0gseUJBQXlCLENBQUMsY0FBOEI7UUFFcEQsY0FBYyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELHdDQUF3QztJQUN4QyxLQUFLO1FBQ0QsTUFBTSxvQkFBb0IsR0FBeUIsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2pFLG1CQUFtQixDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUU5RCxPQUFPLG9CQUFvQixDQUFDO0lBQ2hDLENBQUM7SUFFRDs7T0FFRztJQUNILGtCQUFrQjtRQUNkLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILGdCQUFnQixDQUFDLGFBQWdDLEVBQUUsYUFBd0I7O1FBQ3ZFLDZDQUE2QztRQUM3QyxNQUFNLG1CQUFtQixHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFFOUMsTUFBTSx1QkFBdUIsR0FBRyxzQkFBc0IsQ0FBQyxhQUFhLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDckYsSUFBSSxDQUFDLFVBQVUsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBRXpDLE1BQUEsdUJBQXVCLENBQUMsS0FBSywwQ0FBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUN4QyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUssQ0FBQyxDQUFDO1FBQ3hDLENBQUMsRUFBRTtRQUVILDJCQUEyQjtRQUMzQixnREFBZ0Q7UUFDaEQsS0FBSyxNQUFNLFlBQVksSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLDJCQUFjLENBQUMsRUFBRTtZQUN0RCx3RUFBd0U7WUFDeEUsMkRBQTJEO1lBQzNELElBQUksbUJBQW1CLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUN2QyxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsQ0FBQztnQkFDN0YsSUFBSSxDQUFDLFNBQVMsRUFBRTtvQkFDWixNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksWUFBWSxtREFBbUQsQ0FBQyxDQUFDO2lCQUNoRztnQkFDRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDdkM7U0FDSjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQXhFRCw0RUF3RUM7QUFFRCxpQ0FBaUM7QUFDakMsU0FBUyxpQkFBaUIsQ0FBQyxNQUFjO0lBQ3JDLE1BQU0sWUFBWSxHQUFHLGdCQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3pDLE9BQU8sWUFBWSxDQUFDLE9BQU8sQ0FBQztJQUMzQixZQUE2QixDQUFDLGtCQUFrQixHQUFHLGdCQUFnQixDQUFDO0lBRXJFLE9BQU8sWUFBWSxDQUFDO0FBQ3hCLENBQUM7QUFFRDs7OztHQUlHO0FBQ0gsU0FBUyxzQkFBc0IsQ0FBQyxhQUFnQyxFQUFFLGFBQXdCOztJQUV0Riw2Q0FBNkM7SUFDN0MsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFO1FBQ25ELE9BQU8sd0JBQXdCLENBQUMsYUFBeUMsRUFBRSxhQUFhLENBQUMsQ0FBQztLQUM3RjtJQUVELE1BQU0sTUFBTSxHQUFXLGFBQWEsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN0RCxNQUFNLE9BQU8sU0FBeUIsYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLElBQUksQ0FBQywwQ0FBRSxPQUFPLENBQUM7SUFFekksSUFBSSxPQUFPLEtBQUssU0FBUyxFQUFFO1FBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxhQUFhLENBQUMsSUFBSSxvREFBb0QsQ0FBQyxDQUFDO0tBQzlGO0lBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFFekIsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQUVELDBDQUEwQztBQUMxQyxTQUFTLHdCQUF3QixDQUFDLGFBQXVDLEVBQUUsYUFBd0I7O0lBQy9GLE1BQU0sTUFBTSxHQUFXLGFBQWEsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN0RCxNQUFNLE9BQU8sU0FBeUIsYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssbURBQXdCLENBQUMsSUFBSSxDQUFDLDBDQUFFLE9BQU8sQ0FBQztJQUNwSixJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7UUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyw0REFBNEQsQ0FBQyxDQUFDO0tBQ2pGO0lBQ0QsTUFBTSxRQUFRLEdBQVcsYUFBYSxDQUFDLGFBQWEsQ0FBQztJQUNyRCxNQUFNLFdBQVcsR0FBVyxJQUFJLFFBQVEsR0FBRyxDQUFDO0lBQzVDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQ25CLE1BQU0sQ0FBQyxPQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUMzRSxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFFRCxpSEFBaUg7QUFDakgsbUVBQW1FO0FBQ25FLHNCQUFzQjtBQUN0QixTQUFTLGlCQUFpQixDQUFDLFNBQTJDLEVBQUUsT0FBaUI7O0lBRXJGLDJFQUEyRTtJQUMzRSxzRUFBc0U7SUFDdEUsbUVBQW1FO0lBQ25FLE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSywyQ0FBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRyxJQUFJLENBQUMsbUJBQW1CLEVBQUU7UUFDdEIsT0FBTztLQUNWO0lBQ0QsTUFBTSx5QkFBeUIsR0FBRyxpQkFBaUIsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3pFLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBRXRELE1BQU0sVUFBVSxTQUFHLHlCQUF5QixDQUFDLEtBQUssMENBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDO0lBQzNGLElBQUksVUFBVSxLQUFLLFNBQVMsRUFBRTtRQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7S0FDeEU7SUFDRCxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsWUFBWSxDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUVEOzs7R0FHRztBQUNILFNBQVMsc0JBQXNCLENBQUMsVUFBcUQ7SUFDakYsVUFBVSxDQUFDLG1CQUFtQixHQUFHLEtBQUssQ0FBQztJQUN2QyxVQUFVLENBQUMsb0JBQW9CLEdBQUcsS0FBSyxDQUFDO0lBQ3hDLHVGQUF1RjtJQUN2RixVQUFVLENBQUMsV0FBVyxHQUFHLENBQUM7WUFDdEIsSUFBSSxFQUFFLFlBQVk7WUFDbEIsTUFBTSxFQUFFLHlEQUF5RDtZQUNqRSxNQUFNLEVBQUU7Z0JBQ0osOEZBQThGO2FBQ2pHO1NBQ0osQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFTLG1CQUFtQixDQUFDLGdCQUFzQyxFQUFFLGFBQTBCOztJQUMzRixNQUFNLGdCQUFnQixlQUEyQixnQkFBZ0IsQ0FBQyxnQkFBZ0IsMENBQUUsYUFBYSwwQ0FBRSxLQUFLLENBQUM7SUFDekcsS0FBSyxNQUFNLFlBQVksSUFBSSxhQUFhLEVBQUU7UUFDdEMsSUFBSSxnQkFBZ0IsS0FBSyxTQUFTLEVBQUU7WUFDaEMsR0FBRyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsWUFBWSxzQ0FBc0MsQ0FBQyxDQUFDO1lBQ3BGLFNBQVM7U0FDWjtRQUVELE1BQU0sS0FBSyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLHdCQUFDLFFBQVEsQ0FBQyxNQUFNLDBDQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxZQUFZLElBQUMsQ0FBQyxDQUFDO1FBRS9HLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUNyQixHQUFHLENBQUMsSUFBSSxDQUFDLHVCQUF1QixZQUFZLHNDQUFzQyxDQUFDLENBQUM7U0FDdkY7S0FDSjtBQUNMLENBQUM7QUFFRDs7Ozs7OztHQU9HO0FBQ0gsU0FBZ0IsaUJBQWlCO0lBQzdCLE1BQU0sU0FBUyxHQUFlLEVBQUUsQ0FBQztJQUNqQyxTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsQ0FBQyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNqRixTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsQ0FBQyxDQUFDLHdCQUF3QixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM3RSxTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsQ0FBQyxDQUFDLHdCQUF3QixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM3RSxTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsQ0FBQyxDQUFDLCtCQUErQixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwRixTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsQ0FBQyxDQUFDLCtCQUErQixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwRixTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsQ0FBQyxDQUFDLDBCQUEwQixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMvRSxTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsQ0FBQyxDQUFDLDBCQUEwQixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUUvRSxNQUFNLFlBQVksR0FBdUIsRUFBRSxDQUFDO0lBQzVDLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDZCxJQUFJLEVBQUUsbURBQXdCLENBQUMsSUFBSTtRQUNuQyxPQUFPLEVBQUUsaUJBQU8sQ0FBQyxDQUFDLENBQUMsb0NBQW9DLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUM7S0FDcEYsQ0FBQyxDQUFDO0lBQ0gsWUFBWSxDQUFDLElBQUksQ0FBQztRQUNkLElBQUksRUFBRSwrQ0FBc0IsQ0FBQyxJQUFJO1FBQ2pDLE9BQU8sRUFBRSxpQkFBTyxDQUFDLENBQUMsQ0FBQyxtQ0FBbUMsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztLQUNuRixDQUFDLENBQUM7SUFDSCxZQUFZLENBQUMsSUFBSSxDQUFDO1FBQ2QsSUFBSSxFQUFFLDJDQUFvQixDQUFDLElBQUk7UUFDL0IsT0FBTyxFQUFFLGlCQUFPLENBQUMsQ0FBQyxDQUFDLGdDQUFnQyxFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDO0tBQ2hGLENBQUMsQ0FBQztJQUNILFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDZCxJQUFJLEVBQUUsMkNBQW9CLENBQUMsSUFBSTtRQUMvQixPQUFPLEVBQUUsaUJBQU8sQ0FBQyxDQUFDLENBQUMsZ0NBQWdDLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUM7S0FDaEYsQ0FBQyxDQUFDO0lBQ0gsWUFBWSxDQUFDLElBQUksQ0FBQztRQUNkLElBQUksRUFBRSxtREFBd0IsQ0FBQyxJQUFJO1FBQ25DLE9BQU8sRUFBRSxpQkFBTyxDQUFDLENBQUMsQ0FBQyxxQ0FBcUMsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztLQUNyRixDQUFDLENBQUM7SUFFSCxPQUFPO1FBQ0gsU0FBUztRQUNULFlBQVk7S0FDZixDQUFDO0FBQ04sQ0FBQztBQXBDRCw4Q0FvQ0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMjAgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IHsgdjEgfSBmcm9tICdhc2stc21hcGktbW9kZWwnO1xuaW1wb3J0IGkxOG5leHQgZnJvbSAnaTE4bmV4dCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgQ29udHJvbE1hbmFnZXIgfSBmcm9tICcuLi9jb250cm9scy9Db250cm9sTWFuYWdlcic7XG5pbXBvcnQgeyBCYXNlQ29udHJvbEludGVudCB9IGZyb20gJy4uL2ludGVudHMvQmFzZUNvbnRyb2xJbnRlbnQnO1xuaW1wb3J0IHsgQ29uanVuY3Rpb25Db250cm9sSW50ZW50IH0gZnJvbSAnLi4vaW50ZW50cy9Db25qdW5jdGlvbkNvbnRyb2xJbnRlbnQnO1xuaW1wb3J0IHsgRGF0ZVJhbmdlQ29udHJvbEludGVudCB9IGZyb20gJy4uL2ludGVudHMvRGF0ZVJhbmdlQ29udHJvbEludGVudCc7XG5pbXBvcnQgeyBHZW5lcmFsQ29udHJvbEludGVudCB9IGZyb20gJy4uL2ludGVudHMvR2VuZXJhbENvbnRyb2xJbnRlbnQnO1xuaW1wb3J0IHsgT3JkaW5hbENvbnRyb2xJbnRlbnQgfSBmcm9tICcuLi9pbnRlbnRzL09yZGluYWxDb250cm9sSW50ZW50JztcbmltcG9ydCB7IFNpbmdsZVZhbHVlQ29udHJvbEludGVudCB9IGZyb20gJy4uL2ludGVudHMvU2luZ2xlVmFsdWVDb250cm9sSW50ZW50JztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2xvZ2dpbmcvTG9nZ2VyJztcbmltcG9ydCB7IEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IgfSBmcm9tICcuL0ludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3InO1xuaW1wb3J0IHsgSW50ZW50VXR0ZXJhbmNlcywgTW9kZWxEYXRhLCBTaGFyZWRTbG90VHlwZSB9IGZyb20gJy4vTW9kZWxUeXBlcyc7XG5cbmltcG9ydCBJbnRlbnQgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkludGVudDtcbmltcG9ydCBEaWFsb2dJbnRlbnQgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkRpYWxvZ0ludGVudHM7XG5pbXBvcnQgUHJvbXB0ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5Qcm9tcHQ7XG5pbXBvcnQgSW50ZXJhY3Rpb25Nb2RlbERhdGEgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkludGVyYWN0aW9uTW9kZWxEYXRhO1xuaW1wb3J0IFNsb3RUeXBlID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5TbG90VHlwZTtcblxuY29uc3QgbG9nID0gbmV3IExvZ2dlcignQXNrU2RrQ29udHJvbHM6Q29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3InKTtcblxuY29uc3QgZHVtbXlQcm9tcHRzOiBQcm9tcHRbXSA9IFtcbiAgICB7XG4gICAgICAgIGlkOiBcIlNsb3QuVmFsaWRhdGlvbi41NjQyNDYyMjM1NzkuMTQ2NzQxODA0NDI0OC42Nzg0NjEyMzA0OTVcIixcbiAgICAgICAgdmFyaWF0aW9uczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHR5cGU6IFwiUGxhaW5UZXh0XCIsXG4gICAgICAgICAgICAgICAgdmFsdWU6IFwiVGhpcyBwcm9tcHQgaXMgaW5jbHVkZWQgdG8gZW5zdXJlIHRoZXJlIGlzIGEgZGlhbG9nIG1vZGVsIHByZXNlbnQuIEl0IGlzIG5vdCB1c2VkIGJ5IHNraWxscy5cIlxuICAgICAgICAgICAgfVxuICAgICAgICBdXG4gICAgfVxuXTtcblxuLyoqXG4gKiBJbnRlcmFjdGlvbiBtb2RlbCBnZW5lcmF0b3IgZm9yIHNraWxscyB0aGF0IHVzZSB0aGUgQ29udHJvbHMgRnJhbWV3b3JrXG4gKlxuICogVGhpcyBjbGFzcyBleHRlbmRzIGBJbnRlcmFjdGlvbk1vZGVsR2VuZXJhdG9yYCB3aXRoIENvbnRyb2xzLXNwZWNpZmljIGZ1bmN0aW9uYWxpdHkuXG4gKi9cbmV4cG9ydCBjbGFzcyBDb250cm9sSW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRvciBleHRlbmRzIEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3Ige1xuICAgIHB1YmxpYyB0YXJnZXRTbG90SWRzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSB0aGUgaW50ZXJhY3Rpb24gbW9kZWwgZm9yIGEgY29udHJvbE1hbmFnZXJcbiAgICAgKlxuICAgICAqIEJlaGF2aW9yOlxuICAgICAqIC0gQ2FsbHMgYGNvbnRyb2xNYW5hZ2VyLmJ1aWxkSW50ZXJhY3Rpb25Nb2RlbGAgdG8gdXBkYXRlIHRoZSBJTSBBbmQgYWRkXG4gICAgICogICBkdW1teSBkaWFsb2dNb2RlbCBpZiBTaW1wbGVDb250cm9sSW50ZW50IGlzIHVzZWQgaW4gY29udHJvbFxuICAgICAqXG4gICAgICogVXNhZ2U6IElmIHRoZSBDb250cm9sTWFuYWdlciBpcyBsYWNraW5nIGRhdGEgZm9yIHRoZSBjaG9zZW4gbG9jYWxlLCB0aGVcbiAgICAgKiBhcHByb3ByaWF0ZSBkYXRhIHNob3VsZCBiZSBhZGQgYnkgdXNlciB0aGVtc2VsdmVzIFVzZXIgd291bGQgbmVlZCB0b1xuICAgICAqIHVwZGF0ZSB0aGUgTW9kZWxEYXRhTWFwIGluc3RhbmNlIGFuZCBwcm92aWRlIGl0IHRvIENvbnRyb2xNYW5hZ2VyJ3NcbiAgICAgKiBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSBjb250cm9sTWFuYWdlciAtIENvbnRyb2wgbWFuYWdlclxuICAgICAqL1xuICAgIGJ1aWxkQ29yZU1vZGVsRm9yQ29udHJvbHMoY29udHJvbE1hbmFnZXI6IENvbnRyb2xNYW5hZ2VyKTogQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3Ige1xuXG4gICAgICAgIGNvbnRyb2xNYW5hZ2VyLmJ1aWxkSW50ZXJhY3Rpb25Nb2RlbCh0aGlzKTtcbiAgICAgICAgZW5zdXJlRGlhbG9nTW9kZWwodGhpcywgdGhpcy5pbnRlbnRzKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLy8gdHNEb2MgLSBzZWUgSW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRvclxuICAgIGJ1aWxkKCk6IEludGVyYWN0aW9uTW9kZWxEYXRhIHtcbiAgICAgICAgY29uc3QgaW50ZXJhY3Rpb25Nb2RlbERhdGE6IEludGVyYWN0aW9uTW9kZWxEYXRhID0gc3VwZXIuYnVpbGQoKTtcbiAgICAgICAgdmFsaWRhdGVUYXJnZXRTbG90cyhpbnRlcmFjdGlvbk1vZGVsRGF0YSwgdGhpcy50YXJnZXRTbG90SWRzKTtcblxuICAgICAgICByZXR1cm4gaW50ZXJhY3Rpb25Nb2RlbERhdGE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIEFNQVpPTi5ZZXNJbnRlbnQgYW5kIEFNQVpPTi5Ob0ludGVudCB0byB0aGUgaW50ZXJhY3Rpb24gbW9kZWwuXG4gICAgICovXG4gICAgYWRkWWVzQW5kTm9JbnRlbnRzKCk6IENvbnRyb2xJbnRlcmFjdGlvbk1vZGVsR2VuZXJhdG9yIHtcbiAgICAgICAgdGhpcy5hZGRJbnRlbnQoeyBuYW1lOiAnQU1BWk9OLlllc0ludGVudCcgfSk7XG4gICAgICAgIHRoaXMuYWRkSW50ZW50KHsgbmFtZTogJ0FNQVpPTi5Ob0ludGVudCcgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgdGhlIGluZm9ybWF0aW9uIGZyb20gYSBDb250cm9sSW50ZW50IHRvIHRoZSBpbnRlcmFjdGlvbiBtb2RlbC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBjb250cm9sSW50ZW50IC0gQ29udHJvbEludGVudCB0aGF0IGV4dGVuZHMgYEJhc2VDb250cm9sSW50ZW50YFxuICAgICAqIEBwYXJhbSBjb250cm9sSU1EYXRhIC0gTG9jYWxpemF0aW9uIGRhdGEgZm9yIGJ1aWx0LWlucy5cbiAgICAgKi9cbiAgICBhZGRDb250cm9sSW50ZW50KGNvbnRyb2xJbnRlbnQ6IEJhc2VDb250cm9sSW50ZW50LCBjb250cm9sSU1EYXRhOiBNb2RlbERhdGEpOiB0aGlzIHtcbiAgICAgICAgLy8gdXNlZCB0byByZWNvcmQgYWxsIHByZXNlbnQgYmFzaWMgc2xvdFR5cGVzXG4gICAgICAgIGNvbnN0IHByZXNlbnRTbG90VHlwZXNTZXQgPSBuZXcgU2V0PHN0cmluZz4oKTtcblxuICAgICAgICBjb25zdCBjb250cm9sSW50ZW50VXR0ZXJhbmNlcyA9IGdlbmVyYXRlQ29tcGxldGVJbnRlbnQoY29udHJvbEludGVudCwgY29udHJvbElNRGF0YSk7XG4gICAgICAgIHRoaXMuYWRkSW50ZW50cyhjb250cm9sSW50ZW50VXR0ZXJhbmNlcyk7XG5cbiAgICAgICAgY29udHJvbEludGVudFV0dGVyYW5jZXMuc2xvdHM/Lm1hcCgoc2xvdCkgPT4ge1xuICAgICAgICAgICAgcHJlc2VudFNsb3RUeXBlc1NldC5hZGQoc2xvdC5uYW1lISk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIExvb3AgYWxsIFNoYXJlZFNsb3RUeXBlc1xuICAgICAgICAvLyBpZiBpdCBwcmVzZW50IGluIHRoZSBzZXQsIGFkZCBzbG90VHlwZXMgdG8gSU1cbiAgICAgICAgZm9yIChjb25zdCBzbG90VHlwZU5hbWUgb2YgT2JqZWN0LnZhbHVlcyhTaGFyZWRTbG90VHlwZSkpIHtcbiAgICAgICAgICAgIC8vIFRoZSBzbG90VHlwZSBnZXQgZnJvbSBDb250cm9sSW50ZW50IGlzIGp1c3QgYSBza2VsZXRvbiB3aXRob3V0IHZhbHVlc1xuICAgICAgICAgICAgLy8gVGhlIGNvbXBsZXRlIGRlZmluaXRpb24gc2hvdWxkIGJlIGZvdW5kIGluIGNvbnRyb2xJTURhdGFcbiAgICAgICAgICAgIGlmIChwcmVzZW50U2xvdFR5cGVzU2V0LmhhcyhzbG90VHlwZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2xvdFR5cGVzID0gY29udHJvbElNRGF0YS5zbG90VHlwZXMuZmluZCgoc2xvdFR5cGUpID0+IHNsb3RUeXBlLm5hbWUgPT09IHNsb3RUeXBlTmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFzbG90VHlwZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTbG90VHlwZSAke3Nsb3RUeXBlTmFtZX0gZG9lc24ndCBoYXZlIHZhbHVlcyByZWdpc3RlcmVkIGluIHRoZSBNb2RlbERhdGEuYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuYWRkT3JNZXJnZVNsb3RUeXBlcyhzbG90VHlwZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbn1cblxuLy8gQ29udmVydCBJbnRlbnQgdG8gRGlhbG9nSW50ZW50XG5mdW5jdGlvbiBidWlsZERpYWxvZ0ludGVudChpbnRlbnQ6IEludGVudCk6IERpYWxvZ0ludGVudCB7XG4gICAgY29uc3QgZGlhbG9nSW50ZW50ID0gXy5jbG9uZURlZXAoaW50ZW50KTtcbiAgICBkZWxldGUgZGlhbG9nSW50ZW50LnNhbXBsZXM7XG4gICAgKGRpYWxvZ0ludGVudCBhcyBEaWFsb2dJbnRlbnQpLmRlbGVnYXRpb25TdHJhdGVneSA9ICdTS0lMTF9SRVNQT05TRSc7XG5cbiAgICByZXR1cm4gZGlhbG9nSW50ZW50O1xufVxuXG4vKipcbiAqIEdlbmVyYXRlIGNvbXBsZXRlIGludGVudCB3aXRoIGludGVudCBzYW1wbGVzIGF0dGFjaGVkXG4gKiBAcGFyYW0gY29udHJvbEludGVudCAtIENvbnRyb2xJbnRlbnRcbiAqIEBwYXJhbSBjb250cm9sSU1EYXRhIC0gTG9jYWxpemF0aW9uIGRhdGFcbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVDb21wbGV0ZUludGVudChjb250cm9sSW50ZW50OiBCYXNlQ29udHJvbEludGVudCwgY29udHJvbElNRGF0YTogTW9kZWxEYXRhKTogSW50ZW50IHtcblxuICAgIC8vIFNwZWNpYWwgbG9naWMgZm9yIFNpbmdsZVZhbHVlQ29udHJvbEludGVudFxuICAgIGlmIChjb250cm9sSW50ZW50Lm5hbWUuaW5jbHVkZXMoJ1ZhbHVlQ29udHJvbEludGVudCcpKSB7XG4gICAgICAgIHJldHVybiBoYW5kbGVWYWx1ZUNvbnRyb2xJbnRlbnQoY29udHJvbEludGVudCBhcyBTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQsIGNvbnRyb2xJTURhdGEpO1xuICAgIH1cblxuICAgIGNvbnN0IGludGVudDogSW50ZW50ID0gY29udHJvbEludGVudC5nZW5lcmF0ZUludGVudCgpO1xuICAgIGNvbnN0IHNhbXBsZXM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkID0gY29udHJvbElNRGF0YS5pbnRlbnRWYWx1ZXMuZmluZCgoaW50ZW50VmFsdWUpID0+IGludGVudFZhbHVlLm5hbWUgPT09IGNvbnRyb2xJbnRlbnQubmFtZSk/LnNhbXBsZXM7XG5cbiAgICBpZiAoc2FtcGxlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtjb250cm9sSW50ZW50Lm5hbWV9IGRvZXNuJ3QgaGF2ZSBzYW1wbGVzIHJlZ2lzdGVyZWQgaW4gdGhlIE1vZGVsRGF0YS5gKTtcbiAgICB9XG5cbiAgICBpbnRlbnQuc2FtcGxlcyA9IHNhbXBsZXM7XG5cbiAgICByZXR1cm4gaW50ZW50O1xufVxuXG4vLyBzcGVjaWFsIGhhbmRsaW5nIGZvciBWYWx1ZUNvbnRyb2xJbnRlbnRcbmZ1bmN0aW9uIGhhbmRsZVZhbHVlQ29udHJvbEludGVudChjb250cm9sSW50ZW50OiBTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQsIGNvbnRyb2xJTURhdGE6IE1vZGVsRGF0YSk6IEludGVudCB7XG4gICAgY29uc3QgaW50ZW50OiBJbnRlbnQgPSBjb250cm9sSW50ZW50LmdlbmVyYXRlSW50ZW50KCk7XG4gICAgY29uc3Qgc2FtcGxlczogc3RyaW5nW10gfCB1bmRlZmluZWQgPSBjb250cm9sSU1EYXRhLmludGVudFZhbHVlcy5maW5kKChpbnRlbnRWYWx1ZSkgPT4gaW50ZW50VmFsdWUubmFtZSA9PT0gU2luZ2xlVmFsdWVDb250cm9sSW50ZW50Lm5hbWUpPy5zYW1wbGVzO1xuICAgIGlmIChzYW1wbGVzID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW4gbm90IGZpbmQgU2luZ2xlVmFsdWVDb250cm9sSW50ZW50IHNhbXBsZXMgaW4gTW9kZWxEYXRhJyk7XG4gICAgfVxuICAgIGNvbnN0IHNsb3RUeXBlOiBzdHJpbmcgPSBjb250cm9sSW50ZW50LnZhbHVlU2xvdFR5cGU7XG4gICAgY29uc3QgcmVwbGFjZW1lbnQ6IHN0cmluZyA9IGB7JHtzbG90VHlwZX19YDtcbiAgICBpbnRlbnQuc2FtcGxlcyA9IGludGVudC5zYW1wbGVzIHx8IFtdO1xuICAgIHNhbXBsZXMubWFwKChzYW1wbGUpID0+IHtcbiAgICAgICAgaW50ZW50LnNhbXBsZXMhLnB1c2goc2FtcGxlLnJlcGxhY2UoJ1tbdmFsdWVTbG90VHlwZV1dJywgcmVwbGFjZW1lbnQpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gaW50ZW50O1xufVxuXG4vLyBUaGlzIG1ldGhvZCBhZGRzIGEgZHVtbXkgZGlhbG9nTW9kZWwgc28gdGhhdCBEaWFsb2cgZGlyZWN0aXZlcyBzdWNoIGFzIERpYWxvZy5FbGljaXRTbG90RGlyZWN0aXZlIGNhbiBiZSB1c2VkLlxuLy8gMS4gQWRkIGR1bW15IHZhbGlkYXRpb24gcnVsZSB0byBTaW1wbGVDb250cm9sSW50ZW50JyB0YXJnZXQgc2xvdFxuLy8gMi4gQWRkIGR1bW15IHByb21wdFxuZnVuY3Rpb24gZW5zdXJlRGlhbG9nTW9kZWwoZ2VuZXJhdG9yOiBDb250cm9sSW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRvciwgaW50ZW50czogSW50ZW50W10pOiB2b2lkIHtcblxuICAgIC8vIFNpbmNlIG9uZSBkdW1teSB2YWxpZGF0aW9uIGlzIGVub3VnaCB0byBtZWV0IHNsb3RFbGljaXRhdGlvbiByZXF1aXJlbWVudFxuICAgIC8vIEFuZCBhbGwgdGhlIGJ1aWx0aW4gY29udHJvbHMgaW50ZWdyYXRlIHdpdGggdGhlIFNpbXBsZUNvbnRyb2xJbnRlbnRcbiAgICAvLyBUaHVzIGFkZCB0aGlzIGR1bW15IHZhbGlkYXRpb24gdG8gdGhlIGZpcnN0IHRhcmdldCB0eXBlIHNsb3RUeXBlXG4gICAgY29uc3Qgc2ltcGxlQ29udHJvbEludGVudCA9IGludGVudHMuZmluZCgoaW50ZW50KSA9PiBpbnRlbnQubmFtZSA9PT0gR2VuZXJhbENvbnRyb2xJbnRlbnQubmFtZSk7XG4gICAgaWYgKCFzaW1wbGVDb250cm9sSW50ZW50KSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZGlhbG9nU2ltcGxlQ29udHJvbEludGVudCA9IGJ1aWxkRGlhbG9nSW50ZW50KHNpbXBsZUNvbnRyb2xJbnRlbnQpO1xuICAgIGdlbmVyYXRvci5hZGREaWFsb2dJbnRlbnRzKGRpYWxvZ1NpbXBsZUNvbnRyb2xJbnRlbnQpO1xuXG4gICAgY29uc3QgdGFyZ2V0U2xvdCA9IGRpYWxvZ1NpbXBsZUNvbnRyb2xJbnRlbnQuc2xvdHM/LmZpbmQoKHNsb3QpID0+IHNsb3QudHlwZSA9PT0gJ3RhcmdldCcpO1xuICAgIGlmICh0YXJnZXRTbG90ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0YXJnZXQgc2xvdCBpcyBub3QgcHJlc2VudCBpbiBTaW1wbGVDb250cm9sSW50ZW50Jyk7XG4gICAgfVxuICAgIGFkZER1bW15VmFsaWRhdGlvblJ1bGUodGFyZ2V0U2xvdCk7XG4gICAgZ2VuZXJhdG9yLmFkZFByb21wdHMoLi4uZHVtbXlQcm9tcHRzKTtcbn1cblxuLyoqXG4gKiAgQWRkIGR1bW15IGRpYWxvZyB2YWxpZGF0aW9uIHJ1bGUgdG8gdGhlIGlucHV0IHNsb3QuXG4gKiBAcGFyYW0gdGFyZ2V0U2xvdCAtIFRhcmdldCBzbG90XG4gKi9cbmZ1bmN0aW9uIGFkZER1bW15VmFsaWRhdGlvblJ1bGUodGFyZ2V0U2xvdDogdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5EaWFsb2dTbG90SXRlbXMpOiB2b2lkIHtcbiAgICB0YXJnZXRTbG90LmVsaWNpdGF0aW9uUmVxdWlyZWQgPSBmYWxzZTtcbiAgICB0YXJnZXRTbG90LmNvbmZpcm1hdGlvblJlcXVpcmVkID0gZmFsc2U7XG4gICAgLy8gVGhlIHBhcnRpY3VsYXIgZHVtbXkgbW9kZWwgY29tcHJpc2VzIGEgc2luZ2xlIHNsb3QtdmFsaWRhdGlvbiB0aGF0IHdpbGwgYWx3YXlzIHBhc3MuXG4gICAgdGFyZ2V0U2xvdC52YWxpZGF0aW9ucyA9IFt7XG4gICAgICAgIHR5cGU6IFwiaXNOb3RJblNldFwiLFxuICAgICAgICBwcm9tcHQ6IFwiU2xvdC5WYWxpZGF0aW9uLjU2NDI0NjIyMzU3OS4xNDY3NDE4MDQ0MjQ4LjY3ODQ2MTIzMDQ5NVwiLFxuICAgICAgICB2YWx1ZXM6IFtcbiAgICAgICAgICAgIFwiVGhpcyBwcm9tcHQgaXMgaW5jbHVkZWQgdG8gZW5zdXJlIHRoZXJlIGlzIGEgZGlhbG9nIG1vZGVsIHByZXNlbnQuIEl0IGlzIG5vdCB1c2VkIGJ5IHNraWxscy5cIlxuICAgICAgICBdXG4gICAgfV07XG59XG5cbi8qKlxuICogVmFsaWRhdGUgdGhlIHRhcmdldCBzbG90SWRzIGluIENvbnRyb2xzIGFyZSBwcmVzZW50IGluIEludGVyYWN0aW9uTW9kZWwuXG4gKiBAcGFyYW0gaW50ZXJhY3Rpb25Nb2RlbCAtIEludGVyYWN0aW9uIG1vZGVsXG4gKiBAcGFyYW0gdGFyZ2V0U2xvdElEcyAtIFRhcmdldCBzbG90IElEc1xuICovXG5mdW5jdGlvbiB2YWxpZGF0ZVRhcmdldFNsb3RzKGludGVyYWN0aW9uTW9kZWw6IEludGVyYWN0aW9uTW9kZWxEYXRhLCB0YXJnZXRTbG90SWRzOiBTZXQ8c3RyaW5nPik6IHZvaWQge1xuICAgIGNvbnN0IHByZXNlbnRTbG90VHlwZXM6IFNsb3RUeXBlW10gfCB1bmRlZmluZWQgPSBpbnRlcmFjdGlvbk1vZGVsLmludGVyYWN0aW9uTW9kZWw/Lmxhbmd1YWdlTW9kZWw/LnR5cGVzO1xuICAgIGZvciAoY29uc3QgdGFyZ2V0U2xvdElkIG9mIHRhcmdldFNsb3RJZHMpIHtcbiAgICAgICAgaWYgKHByZXNlbnRTbG90VHlwZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbG9nLndhcm4oYHRhcmdldCBzbG90IHdpdGggaWQgJHt0YXJnZXRTbG90SWR9IGlzIG5vdCBwcmVzZW50IGluIEludGVyYWN0aW9uTW9kZWwuYCk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1hdGNoID0gcHJlc2VudFNsb3RUeXBlcy5maW5kKChzbG90VHlwZSkgPT4gc2xvdFR5cGUudmFsdWVzPy5maW5kKCh2YWx1ZSkgPT4gdmFsdWUuaWQgPT09IHRhcmdldFNsb3RJZCkpO1xuXG4gICAgICAgIGlmIChtYXRjaCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsb2cud2FybihgdGFyZ2V0IHNsb3Qgd2l0aCBpZCAke3RhcmdldFNsb3RJZH0gaXMgbm90IHByZXNlbnQgaW4gSW50ZXJhY3Rpb25Nb2RlbC5gKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSB0aGUgbW9kZWxEYXRhIE9iamVjdCBieSByZWFkaW5nIHRoZSBpMThuIGluc3RhbmNlLlxuICpcbiAqIFRoaXMgaXMgdGhlIGNvbnNvbGlkYXRlZCBsb2NhbGl6YXRpb24gaW5mb3JtYXRpb24gZm9yIHRoZSBidWlsdC1pbnMuICBUaGlzXG4gKiBkYXRhIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgZ2VuZXJhdGVkIGludGVyYWN0aW9uIG1vZGVsIHVubGVzcyB0aGUgY29tcG9uZW50c1xuICogYXJlIGFjdHVhbGx5IHVzZWQuIEkuZS4gdGhpcyBpcyBhIG1hcCBvZiBkYXRhIGZyb20gd2hpY2ggdG8gZXh0cmFjdCBiaXRzXG4gKiBhbmQgcGllY2VzIGFzIG5lZWRlZC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlTW9kZWxEYXRhKCk6IE1vZGVsRGF0YSB7XG4gICAgY29uc3Qgc2xvdFR5cGVzOiBTbG90VHlwZVtdID0gW107XG4gICAgc2xvdFR5cGVzLnB1c2goaTE4bmV4dC50KCdTSEFSRURfU0xPVF9UWVBFU19GRUVEQkFDSycsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KSk7XG4gICAgc2xvdFR5cGVzLnB1c2goaTE4bmV4dC50KCdTSEFSRURfU0xPVF9UWVBFU19IRUFEJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pKTtcbiAgICBzbG90VHlwZXMucHVzaChpMThuZXh0LnQoJ1NIQVJFRF9TTE9UX1RZUEVTX1RBSUwnLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSkpO1xuICAgIHNsb3RUeXBlcy5wdXNoKGkxOG5leHQudCgnU0hBUkVEX1NMT1RfVFlQRVNfQ09OSlVOQ1RJT04nLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSkpO1xuICAgIHNsb3RUeXBlcy5wdXNoKGkxOG5leHQudCgnU0hBUkVEX1NMT1RfVFlQRVNfUFJFUE9TSVRJT04nLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSkpO1xuICAgIHNsb3RUeXBlcy5wdXNoKGkxOG5leHQudCgnU0hBUkVEX1NMT1RfVFlQRVNfQUNUSU9OJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pKTtcbiAgICBzbG90VHlwZXMucHVzaChpMThuZXh0LnQoJ1NIQVJFRF9TTE9UX1RZUEVTX1RBUkdFVCcsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KSk7XG5cbiAgICBjb25zdCBpbnRlbnRWYWx1ZXM6IEludGVudFV0dGVyYW5jZXNbXSA9IFtdO1xuICAgIGludGVudFZhbHVlcy5wdXNoKHtcbiAgICAgICAgbmFtZTogQ29uanVuY3Rpb25Db250cm9sSW50ZW50Lm5hbWUsXG4gICAgICAgIHNhbXBsZXM6IGkxOG5leHQudCgnQ09OSlVOQ1RJT05fQ09OVFJPTF9JTlRFTlRfU0FNUExFUycsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KVxuICAgIH0pO1xuICAgIGludGVudFZhbHVlcy5wdXNoKHtcbiAgICAgICAgbmFtZTogRGF0ZVJhbmdlQ29udHJvbEludGVudC5uYW1lLFxuICAgICAgICBzYW1wbGVzOiBpMThuZXh0LnQoJ0RBVEVfUkFOR0VfQ09OVFJPTF9JTlRFTlRfU0FNUExFUycsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KVxuICAgIH0pO1xuICAgIGludGVudFZhbHVlcy5wdXNoKHtcbiAgICAgICAgbmFtZTogR2VuZXJhbENvbnRyb2xJbnRlbnQubmFtZSxcbiAgICAgICAgc2FtcGxlczogaTE4bmV4dC50KCdHRU5FUkFMX0NPTlRST0xfSU5URU5UX1NBTVBMRVMnLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSlcbiAgICB9KTtcbiAgICBpbnRlbnRWYWx1ZXMucHVzaCh7XG4gICAgICAgIG5hbWU6IE9yZGluYWxDb250cm9sSW50ZW50Lm5hbWUsXG4gICAgICAgIHNhbXBsZXM6IGkxOG5leHQudCgnT1JESU5BTF9DT05UUk9MX0lOVEVOVF9TQU1QTEVTJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pXG4gICAgfSk7XG4gICAgaW50ZW50VmFsdWVzLnB1c2goe1xuICAgICAgICBuYW1lOiBTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQubmFtZSxcbiAgICAgICAgc2FtcGxlczogaTE4bmV4dC50KCdTSU5HTEVfVkFMVUVfQ09OVFJPTF9JTlRFTlRfU0FNUExFUycsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgc2xvdFR5cGVzLFxuICAgICAgICBpbnRlbnRWYWx1ZXNcbiAgICB9O1xufVxuXG4iXX0=