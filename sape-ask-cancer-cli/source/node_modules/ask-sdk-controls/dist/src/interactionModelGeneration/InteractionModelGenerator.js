"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.InteractionModelGenerator = void 0;
const tslib_1 = require("tslib");
const fs_1 = tslib_1.__importDefault(require("fs"));
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const path_1 = require("path");
const Logger_1 = require("../logging/Logger");
const log = new Logger_1.Logger('AskSdkControls:InteractionModelGenerator');
/**
 * Interaction model generator
 *
 * - For skills that use Controls Framework, use `ControlInteractionModelGenerator`
 */
class InteractionModelGenerator {
    constructor() {
        this.intents = [];
        this.slotTypes = [];
        this.dialogIntents = [];
        this.prompts = [];
    }
    /**
     * Add intent to interaction model
     *
     * @param intent - Intent
     */
    addIntent(intent) {
        // First Check whether the new intent has the same name as any existing intents
        // If intent has the same name already exist in the array,
        // then check whether these two intents are deeply equal to each other
        // skip adding new intent if they are exactly same, otherwise throw error
        const matchingIntent = this.intents.find(existIntent => existIntent.name === intent.name);
        if (matchingIntent === undefined) {
            this.intents.push(intent);
            return this;
        }
        if (lodash_1.default.isEqual(matchingIntent, intent)) {
            return this;
        }
        throw new Error(`Intent ${intent.name} is defined more than once and the definitions are not identical.`);
    }
    /**
     * Add one or more intents
     */
    addIntents(...intents) {
        for (const intent of intents) {
            this.addIntent(intent);
        }
        return this;
    }
    /**
     * Add or merge slot type
     *
     * If the slot and/or slot-values already exist, the new data is added.
     */
    addOrMergeSlotType(slotType) {
        var _a;
        const matchingSlotType = this.slotTypes.find(s => s.name === slotType.name);
        if (matchingSlotType === undefined) {
            // slot not yet present so just push it
            this.slotTypes.push(slotType);
            return this;
        }
        // slot present so add the values
        for (const value of (_a = slotType.values) !== null && _a !== void 0 ? _a : []) {
            mergeSlotTypeValues(matchingSlotType.values, value, matchingSlotType.name);
        }
        return this;
    }
    /**
     * Add or merge slot types
     *
     * If the slot and/or slot-values already exist, the new data is added.
     */
    addOrMergeSlotTypes(...slotTypes) {
        for (const slotType of slotTypes) {
            this.addOrMergeSlotType(slotType);
        }
        return this;
    }
    /**
     * Add a new slot value to an existing slot type
     *
     * If the slot-value already exists, the new data is added.
     */
    addValuesToSlotType(slotName, ...values) {
        const slotType = this.slotTypes.find(s => s.name === slotName);
        if (!slotType) {
            throw new Error(`SlotType ${slotName} is not defined.`);
        }
        for (const value of values) {
            mergeSlotTypeValues(slotType.values, value, slotType.name);
        }
        return this;
    }
    /**
     * Add a DialogIntent to the dialog model.
     */
    addDialogIntent(dialogIntent) {
        const matchingIntent = this.dialogIntents.find(existIntent => existIntent.name === dialogIntent.name);
        if (matchingIntent === undefined) {
            this.dialogIntents.push(dialogIntent);
            return this;
        }
        if (lodash_1.default.isEqual(matchingIntent, dialogIntent)) {
            return this;
        }
        throw new Error(`DialogIntent ${dialogIntent.name} is defined more than once and the definitions are not identical.`);
    }
    /**
     * Add DialogIntents to the dialog model.
     */
    addDialogIntents(...dialogIntents) {
        for (const dialogIntent of dialogIntents) {
            this.addDialogIntent(dialogIntent);
        }
        return this;
    }
    /**
     * Add DelegationStrategy to the dialog model.
     */
    addDelegationStrategy(delegationStrategy) {
        this.delegationStrategy = delegationStrategy;
        return this;
    }
    /**
     * Add a Prompt to the dialog model.
     */
    addPrompt(prompt) {
        const matchingPrompt = this.prompts.find(existPrompt => existPrompt.id === prompt.id);
        if (matchingPrompt === undefined) {
            this.prompts.push(prompt);
            return this;
        }
        if (lodash_1.default.isEqual(matchingPrompt, prompt)) {
            return this;
        }
        throw new Error(`Prompt with id ${prompt.id} is defined more than once and the definitions are not identical.`);
    }
    /**
     * Add Prompts to the dialog model.
     */
    addPrompts(...prompts) {
        for (const prompt of prompts) {
            this.addPrompt(prompt);
        }
        return this;
    }
    /**
     * Set the invocation name.
     */
    withInvocationName(name) {
        if (this.invocationName) {
            log.warn(`Skill invocation name ${this.invocationName} has been overwritten to ${name}.`);
        }
        this.invocationName = name;
        return this;
    }
    /**
     * Load an interaction model file (JSON format).
     *
     * Usage:
     * - This method does not perform merging for all components. Call this
     *   method before any other methods.
     */
    loadFromFile(inputPath) {
        if (!inputPath || !fs_1.default.existsSync(inputPath)) {
            throw new Error('Input path is not valid.');
        }
        // fetch all info from json
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        const interactionModel = require(inputPath).interactionModel;
        const intents = interactionModel.languageModel.intents ? interactionModel.languageModel.intents : [];
        const slotTypes = interactionModel.languageModel.types ? interactionModel.languageModel.types : [];
        const invocationName = interactionModel.languageModel.invocationName;
        const prompts = interactionModel.prompts ? interactionModel.prompts : [];
        const dialog = interactionModel.dialog ? interactionModel.dialog : {};
        const dialogIntents = dialog.intents ? dialog.intents : [];
        const delegationStrategy = dialog.delegationStrategy;
        this.addIntents(...intents);
        this.addOrMergeSlotTypes(...slotTypes);
        this.addDialogIntents(...dialogIntents);
        if (delegationStrategy !== undefined) {
            this.addDelegationStrategy(delegationStrategy);
        }
        this.addPrompts(...prompts);
        this.withInvocationName(invocationName);
        return this;
    }
    /**
     * Build the interaction model.
     *
     * @returns An `InteractionModelData` object.
     */
    build() {
        if (!this.invocationName) {
            console.warn('Invocation name is not defined');
        }
        const interactionModel = {
            languageModel: {},
            prompts: []
        };
        interactionModel.languageModel.types = this.slotTypes;
        interactionModel.languageModel.intents = this.intents;
        if (this.dialogIntents.length > 0 || this.delegationStrategy) {
            interactionModel.dialog = {};
        }
        if (this.dialogIntents.length > 0) {
            interactionModel.dialog.intents = this.dialogIntents;
        }
        if (this.delegationStrategy) {
            interactionModel.dialog.delegationStrategy = this.delegationStrategy;
        }
        interactionModel.prompts = this.prompts;
        interactionModel.languageModel.invocationName = this.invocationName;
        return {
            interactionModel,
        };
    }
    /**
     * Build the interaction model and write to disk.
     *
     * @param filename - Filename
     */
    buildAndWrite(filename) {
        const interactionModelJson = JSON.stringify(this.build(), null, 2);
        const path = path_1.join(process.cwd(), filename);
        fs_1.default.writeFileSync(path, interactionModelJson);
    }
}
exports.InteractionModelGenerator = InteractionModelGenerator;
function mergeSlotTypeValues(slotTypeValues, newSlotValue, slotName) {
    var _a, _b, _c, _d, _e, _f, _g, _h;
    if (!slotTypeValues) {
        slotTypeValues = [newSlotValue];
        return;
    }
    const matchingValue = slotTypeValues.find(v => { var _a, _b; return ((_a = v.name) === null || _a === void 0 ? void 0 : _a.value) === ((_b = newSlotValue.name) === null || _b === void 0 ? void 0 : _b.value) || v.id === newSlotValue.id; });
    if (!matchingValue) {
        // value not yet present so just push it
        slotTypeValues.push(newSlotValue);
    }
    else {
        // value present, so add synonyms
        if (((_a = matchingValue.name) === null || _a === void 0 ? void 0 : _a.value) !== ((_b = newSlotValue.name) === null || _b === void 0 ? void 0 : _b.value)) {
            throw new Error(`Cannot merge slot type ${slotName}, as the value ${JSON.stringify(newSlotValue)} and ${JSON.stringify(matchingValue)} has the same id but different name.value.`);
        }
        if (matchingValue.id !== newSlotValue.id) {
            throw new Error(`Cannot merge slot type ${slotName}, as the value ${JSON.stringify(newSlotValue)} and ${JSON.stringify(matchingValue)} has the same name.value but different id.`);
        }
        for (const synonym of (_d = (_c = newSlotValue.name) === null || _c === void 0 ? void 0 : _c.synonyms) !== null && _d !== void 0 ? _d : []) {
            const matchingSynonym = (_f = (_e = matchingValue.name) === null || _e === void 0 ? void 0 : _e.synonyms) === null || _f === void 0 ? void 0 : _f.find(s => s === synonym);
            if (matchingSynonym === undefined) {
                // synonym not yet preset so just push it
                (_h = (_g = matchingValue.name) === null || _g === void 0 ? void 0 : _g.synonyms) === null || _h === void 0 ? void 0 : _h.push(synonym);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbnRlcmFjdGlvbk1vZGVsR2VuZXJhdGlvbi9JbnRlcmFjdGlvbk1vZGVsR2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFhQSxvREFBb0I7QUFDcEIsNERBQXVCO0FBQ3ZCLCtCQUE0QjtBQUM1Qiw4Q0FBMkM7QUFZM0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxlQUFNLENBQUMsMENBQTBDLENBQUMsQ0FBQztBQUVuRTs7OztHQUlHO0FBQ0gsTUFBYSx5QkFBeUI7SUFBdEM7UUFFYyxZQUFPLEdBQWEsRUFBRSxDQUFDO1FBQ3ZCLGNBQVMsR0FBZSxFQUFFLENBQUM7UUFDM0Isa0JBQWEsR0FBbUIsRUFBRSxDQUFDO1FBRW5DLFlBQU8sR0FBYSxFQUFFLENBQUM7SUFnUHJDLENBQUM7SUE1T0c7Ozs7T0FJRztJQUNILFNBQVMsQ0FBQyxNQUFjO1FBQ3BCLCtFQUErRTtRQUMvRSwwREFBMEQ7UUFDMUQsc0VBQXNFO1FBQ3RFLHlFQUF5RTtRQUN6RSxNQUFNLGNBQWMsR0FBdUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5RyxJQUFJLGNBQWMsS0FBSyxTQUFTLEVBQUU7WUFDOUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUIsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELElBQUksZ0JBQUMsQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25DLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLFVBQVUsTUFBTSxDQUFDLElBQUksbUVBQW1FLENBQUMsQ0FBQztJQUM5RyxDQUFD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USxrQkFBa0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsUUFBUSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1NBQ3RMO1FBQ0QsSUFBSSxhQUFhLENBQUMsRUFBRSxLQUFLLFlBQVksQ0FBQyxFQUFFLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsUUFBUSxrQkFBa0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsUUFBUSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1NBQ3RMO1FBRUQsS0FBSyxNQUFNLE9BQU8sZ0JBQUksWUFBWSxDQUFDLElBQUksMENBQUUsUUFBUSxtQ0FBSSxFQUFFLEVBQUU7WUFDckQsTUFBTSxlQUFlLGVBQUcsYUFBYSxDQUFDLElBQUksMENBQUUsUUFBUSwwQ0FBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssT0FBTyxDQUFDLENBQUM7WUFDL0UsSUFBSSxlQUFlLEtBQUssU0FBUyxFQUFFO2dCQUMvQix5Q0FBeUM7Z0JBQ3pDLFlBQUEsYUFBYSxDQUFDLElBQUksMENBQUUsUUFBUSwwQ0FBRSxJQUFJLENBQUMsT0FBTyxFQUFFO2FBQy9DO1NBQ0o7S0FDSjtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMjAgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IHsgdjEgfSBmcm9tICdhc2stc21hcGktbW9kZWwnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnaW5nL0xvZ2dlcic7XG5cbmltcG9ydCBJbnRlcmFjdGlvbk1vZGVsRGF0YSA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuSW50ZXJhY3Rpb25Nb2RlbERhdGE7XG5pbXBvcnQgSW50ZXJhY3Rpb25Nb2RlbFNjaGVtYSA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuSW50ZXJhY3Rpb25Nb2RlbFNjaGVtYTtcbmltcG9ydCBTbG90VHlwZSA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuU2xvdFR5cGU7XG5pbXBvcnQgVHlwZVZhbHVlID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5UeXBlVmFsdWU7XG5pbXBvcnQgSW50ZW50ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5JbnRlbnQ7XG5pbXBvcnQgRGlhbG9nSW50ZW50ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5EaWFsb2dJbnRlbnRzO1xuaW1wb3J0IERpYWxvZyA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuRGlhbG9nO1xuaW1wb3J0IERlbGVnYXRpb25TdHJhdGVneVR5cGUgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkRlbGVnYXRpb25TdHJhdGVneVR5cGU7XG5pbXBvcnQgUHJvbXB0ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5Qcm9tcHQ7XG5cbmNvbnN0IGxvZyA9IG5ldyBMb2dnZXIoJ0Fza1Nka0NvbnRyb2xzOkludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3InKTtcblxuLyoqXG4gKiBJbnRlcmFjdGlvbiBtb2RlbCBnZW5lcmF0b3JcbiAqXG4gKiAtIEZvciBza2lsbHMgdGhhdCB1c2UgQ29udHJvbHMgRnJhbWV3b3JrLCB1c2UgYENvbnRyb2xJbnRlcmFjdGlvbk1vZGVsR2VuZXJhdG9yYFxuICovXG5leHBvcnQgY2xhc3MgSW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRvciB7XG5cbiAgICBwcm90ZWN0ZWQgaW50ZW50czogSW50ZW50W10gPSBbXTtcbiAgICBwcm90ZWN0ZWQgc2xvdFR5cGVzOiBTbG90VHlwZVtdID0gW107XG4gICAgcHJvdGVjdGVkIGRpYWxvZ0ludGVudHM6IERpYWxvZ0ludGVudFtdID0gW107XG4gICAgcHJvdGVjdGVkIGRlbGVnYXRpb25TdHJhdGVneTogRGVsZWdhdGlvblN0cmF0ZWd5VHlwZTtcbiAgICBwcm90ZWN0ZWQgcHJvbXB0czogUHJvbXB0W10gPSBbXTtcbiAgICBwcm90ZWN0ZWQgaW52b2NhdGlvbk5hbWU6IHN0cmluZztcblxuXG4gICAgLyoqXG4gICAgICogQWRkIGludGVudCB0byBpbnRlcmFjdGlvbiBtb2RlbFxuICAgICAqXG4gICAgICogQHBhcmFtIGludGVudCAtIEludGVudFxuICAgICAqL1xuICAgIGFkZEludGVudChpbnRlbnQ6IEludGVudCk6IEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3Ige1xuICAgICAgICAvLyBGaXJzdCBDaGVjayB3aGV0aGVyIHRoZSBuZXcgaW50ZW50IGhhcyB0aGUgc2FtZSBuYW1lIGFzIGFueSBleGlzdGluZyBpbnRlbnRzXG4gICAgICAgIC8vIElmIGludGVudCBoYXMgdGhlIHNhbWUgbmFtZSBhbHJlYWR5IGV4aXN0IGluIHRoZSBhcnJheSxcbiAgICAgICAgLy8gdGhlbiBjaGVjayB3aGV0aGVyIHRoZXNlIHR3byBpbnRlbnRzIGFyZSBkZWVwbHkgZXF1YWwgdG8gZWFjaCBvdGhlclxuICAgICAgICAvLyBza2lwIGFkZGluZyBuZXcgaW50ZW50IGlmIHRoZXkgYXJlIGV4YWN0bHkgc2FtZSwgb3RoZXJ3aXNlIHRocm93IGVycm9yXG4gICAgICAgIGNvbnN0IG1hdGNoaW5nSW50ZW50OiBJbnRlbnQgfCB1bmRlZmluZWQgPSB0aGlzLmludGVudHMuZmluZChleGlzdEludGVudCA9PiBleGlzdEludGVudC5uYW1lID09PSBpbnRlbnQubmFtZSk7XG4gICAgICAgIGlmIChtYXRjaGluZ0ludGVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmludGVudHMucHVzaChpbnRlbnQpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF8uaXNFcXVhbChtYXRjaGluZ0ludGVudCwgaW50ZW50KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnRlbnQgJHtpbnRlbnQubmFtZX0gaXMgZGVmaW5lZCBtb3JlIHRoYW4gb25jZSBhbmQgdGhlIGRlZmluaXRpb25zIGFyZSBub3QgaWRlbnRpY2FsLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBvbmUgb3IgbW9yZSBpbnRlbnRzXG4gICAgICovXG4gICAgYWRkSW50ZW50cyguLi5pbnRlbnRzOiBJbnRlbnRbXSk6IHRoaXMge1xuICAgICAgICBmb3IgKGNvbnN0IGludGVudCBvZiBpbnRlbnRzKSB7XG4gICAgICAgICAgICB0aGlzLmFkZEludGVudChpbnRlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIG9yIG1lcmdlIHNsb3QgdHlwZVxuICAgICAqXG4gICAgICogSWYgdGhlIHNsb3QgYW5kL29yIHNsb3QtdmFsdWVzIGFscmVhZHkgZXhpc3QsIHRoZSBuZXcgZGF0YSBpcyBhZGRlZC5cbiAgICAgKi9cbiAgICBhZGRPck1lcmdlU2xvdFR5cGUoc2xvdFR5cGU6IFNsb3RUeXBlKTogdGhpcyB7XG5cbiAgICAgICAgY29uc3QgbWF0Y2hpbmdTbG90VHlwZSA9IHRoaXMuc2xvdFR5cGVzLmZpbmQocyA9PiBzLm5hbWUgPT09IHNsb3RUeXBlLm5hbWUpO1xuICAgICAgICBpZiAobWF0Y2hpbmdTbG90VHlwZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyBzbG90IG5vdCB5ZXQgcHJlc2VudCBzbyBqdXN0IHB1c2ggaXRcbiAgICAgICAgICAgIHRoaXMuc2xvdFR5cGVzLnB1c2goc2xvdFR5cGUpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgLy8gc2xvdCBwcmVzZW50IHNvIGFkZCB0aGUgdmFsdWVzXG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2Ygc2xvdFR5cGUudmFsdWVzID8/IFtdKSB7XG4gICAgICAgICAgICBtZXJnZVNsb3RUeXBlVmFsdWVzKG1hdGNoaW5nU2xvdFR5cGUudmFsdWVzLCB2YWx1ZSwgbWF0Y2hpbmdTbG90VHlwZS5uYW1lISk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIG9yIG1lcmdlIHNsb3QgdHlwZXNcbiAgICAgKlxuICAgICAqIElmIHRoZSBzbG90IGFuZC9vciBzbG90LXZhbHVlcyBhbHJlYWR5IGV4aXN0LCB0aGUgbmV3IGRhdGEgaXMgYWRkZWQuXG4gICAgICovXG4gICAgYWRkT3JNZXJnZVNsb3RUeXBlcyguLi5zbG90VHlwZXM6IFNsb3RUeXBlW10pOiB0aGlzIHtcbiAgICAgICAgZm9yIChjb25zdCBzbG90VHlwZSBvZiBzbG90VHlwZXMpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkT3JNZXJnZVNsb3RUeXBlKHNsb3RUeXBlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIG5ldyBzbG90IHZhbHVlIHRvIGFuIGV4aXN0aW5nIHNsb3QgdHlwZVxuICAgICAqXG4gICAgICogSWYgdGhlIHNsb3QtdmFsdWUgYWxyZWFkeSBleGlzdHMsIHRoZSBuZXcgZGF0YSBpcyBhZGRlZC5cbiAgICAgKi9cbiAgICBhZGRWYWx1ZXNUb1Nsb3RUeXBlKHNsb3ROYW1lOiBzdHJpbmcsIC4uLnZhbHVlczogVHlwZVZhbHVlW10pOiB0aGlzIHtcbiAgICAgICAgY29uc3Qgc2xvdFR5cGUgPSB0aGlzLnNsb3RUeXBlcy5maW5kKHMgPT4gcy5uYW1lID09PSBzbG90TmFtZSk7XG4gICAgICAgIGlmICghc2xvdFR5cGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU2xvdFR5cGUgJHtzbG90TmFtZX0gaXMgbm90IGRlZmluZWQuYCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHtcbiAgICAgICAgICAgIG1lcmdlU2xvdFR5cGVWYWx1ZXMoc2xvdFR5cGUudmFsdWVzLCB2YWx1ZSwgc2xvdFR5cGUubmFtZSEpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgRGlhbG9nSW50ZW50IHRvIHRoZSBkaWFsb2cgbW9kZWwuXG4gICAgICovXG4gICAgYWRkRGlhbG9nSW50ZW50KGRpYWxvZ0ludGVudDogRGlhbG9nSW50ZW50KTogdGhpcyB7XG4gICAgICAgIGNvbnN0IG1hdGNoaW5nSW50ZW50OiBJbnRlbnQgfCB1bmRlZmluZWQgPSB0aGlzLmRpYWxvZ0ludGVudHMuZmluZChleGlzdEludGVudCA9PiBleGlzdEludGVudC5uYW1lID09PSBkaWFsb2dJbnRlbnQubmFtZSk7XG4gICAgICAgIGlmIChtYXRjaGluZ0ludGVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmRpYWxvZ0ludGVudHMucHVzaChkaWFsb2dJbnRlbnQpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF8uaXNFcXVhbChtYXRjaGluZ0ludGVudCwgZGlhbG9nSW50ZW50KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEaWFsb2dJbnRlbnQgJHtkaWFsb2dJbnRlbnQubmFtZX0gaXMgZGVmaW5lZCBtb3JlIHRoYW4gb25jZSBhbmQgdGhlIGRlZmluaXRpb25zIGFyZSBub3QgaWRlbnRpY2FsLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBEaWFsb2dJbnRlbnRzIHRvIHRoZSBkaWFsb2cgbW9kZWwuXG4gICAgICovXG4gICAgYWRkRGlhbG9nSW50ZW50cyguLi5kaWFsb2dJbnRlbnRzOiBEaWFsb2dJbnRlbnRbXSk6IHRoaXMge1xuICAgICAgICBmb3IgKGNvbnN0IGRpYWxvZ0ludGVudCBvZiBkaWFsb2dJbnRlbnRzKSB7XG4gICAgICAgICAgICB0aGlzLmFkZERpYWxvZ0ludGVudChkaWFsb2dJbnRlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIERlbGVnYXRpb25TdHJhdGVneSB0byB0aGUgZGlhbG9nIG1vZGVsLlxuICAgICAqL1xuICAgIGFkZERlbGVnYXRpb25TdHJhdGVneShkZWxlZ2F0aW9uU3RyYXRlZ3k6IERlbGVnYXRpb25TdHJhdGVneVR5cGUpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5kZWxlZ2F0aW9uU3RyYXRlZ3kgPSBkZWxlZ2F0aW9uU3RyYXRlZ3k7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgUHJvbXB0IHRvIHRoZSBkaWFsb2cgbW9kZWwuXG4gICAgICovXG4gICAgYWRkUHJvbXB0KHByb21wdDogUHJvbXB0KTogdGhpcyB7XG4gICAgICAgIGNvbnN0IG1hdGNoaW5nUHJvbXB0ID0gdGhpcy5wcm9tcHRzLmZpbmQoZXhpc3RQcm9tcHQgPT4gZXhpc3RQcm9tcHQuaWQgPT09IHByb21wdC5pZCk7XG4gICAgICAgIGlmIChtYXRjaGluZ1Byb21wdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnByb21wdHMucHVzaChwcm9tcHQpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF8uaXNFcXVhbChtYXRjaGluZ1Byb21wdCwgcHJvbXB0KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQcm9tcHQgd2l0aCBpZCAke3Byb21wdC5pZH0gaXMgZGVmaW5lZCBtb3JlIHRoYW4gb25jZSBhbmQgdGhlIGRlZmluaXRpb25zIGFyZSBub3QgaWRlbnRpY2FsLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBQcm9tcHRzIHRvIHRoZSBkaWFsb2cgbW9kZWwuXG4gICAgICovXG4gICAgYWRkUHJvbXB0cyguLi5wcm9tcHRzOiBQcm9tcHRbXSk6IHRoaXMge1xuICAgICAgICBmb3IgKGNvbnN0IHByb21wdCBvZiBwcm9tcHRzKSB7XG4gICAgICAgICAgICB0aGlzLmFkZFByb21wdChwcm9tcHQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0IHRoZSBpbnZvY2F0aW9uIG5hbWUuXG4gICAgICovXG4gICAgd2l0aEludm9jYXRpb25OYW1lKG5hbWU6IHN0cmluZyk6IHRoaXMge1xuICAgICAgICBpZiAodGhpcy5pbnZvY2F0aW9uTmFtZSkge1xuICAgICAgICAgICAgbG9nLndhcm4oYFNraWxsIGludm9jYXRpb24gbmFtZSAke3RoaXMuaW52b2NhdGlvbk5hbWV9IGhhcyBiZWVuIG92ZXJ3cml0dGVuIHRvICR7bmFtZX0uYCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pbnZvY2F0aW9uTmFtZSA9IG5hbWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGFuIGludGVyYWN0aW9uIG1vZGVsIGZpbGUgKEpTT04gZm9ybWF0KS5cbiAgICAgKlxuICAgICAqIFVzYWdlOlxuICAgICAqIC0gVGhpcyBtZXRob2QgZG9lcyBub3QgcGVyZm9ybSBtZXJnaW5nIGZvciBhbGwgY29tcG9uZW50cy4gQ2FsbCB0aGlzXG4gICAgICogICBtZXRob2QgYmVmb3JlIGFueSBvdGhlciBtZXRob2RzLlxuICAgICAqL1xuICAgIGxvYWRGcm9tRmlsZShpbnB1dFBhdGg6IHN0cmluZyk6IHRoaXMge1xuICAgICAgICBpZiAoIWlucHV0UGF0aCB8fCAhZnMuZXhpc3RzU3luYyhpbnB1dFBhdGgpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0lucHV0IHBhdGggaXMgbm90IHZhbGlkLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZmV0Y2ggYWxsIGluZm8gZnJvbSBqc29uXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG4gICAgICAgIGNvbnN0IGludGVyYWN0aW9uTW9kZWw6IEludGVyYWN0aW9uTW9kZWxTY2hlbWEgPSByZXF1aXJlKGlucHV0UGF0aCkuaW50ZXJhY3Rpb25Nb2RlbDtcbiAgICAgICAgY29uc3QgaW50ZW50czogSW50ZW50W10gPSBpbnRlcmFjdGlvbk1vZGVsLmxhbmd1YWdlTW9kZWwhLmludGVudHMgPyBpbnRlcmFjdGlvbk1vZGVsLmxhbmd1YWdlTW9kZWwhLmludGVudHMgOiBbXTtcbiAgICAgICAgY29uc3Qgc2xvdFR5cGVzOiBTbG90VHlwZVtdID0gaW50ZXJhY3Rpb25Nb2RlbC5sYW5ndWFnZU1vZGVsIS50eXBlcyA/IGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEudHlwZXMgOiBbXTtcbiAgICAgICAgY29uc3QgaW52b2NhdGlvbk5hbWU6IHN0cmluZyA9IGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEuaW52b2NhdGlvbk5hbWUhO1xuICAgICAgICBjb25zdCBwcm9tcHRzOiBQcm9tcHRbXSA9IGludGVyYWN0aW9uTW9kZWwucHJvbXB0cyA/IGludGVyYWN0aW9uTW9kZWwucHJvbXB0cyA6IFtdO1xuICAgICAgICBjb25zdCBkaWFsb2c6IERpYWxvZyA9IGludGVyYWN0aW9uTW9kZWwuZGlhbG9nID8gaW50ZXJhY3Rpb25Nb2RlbC5kaWFsb2cgOiB7fTtcblxuICAgICAgICBjb25zdCBkaWFsb2dJbnRlbnRzOiBEaWFsb2dJbnRlbnRbXSA9IGRpYWxvZy5pbnRlbnRzID8gZGlhbG9nLmludGVudHMgOiBbXTtcbiAgICAgICAgY29uc3QgZGVsZWdhdGlvblN0cmF0ZWd5OiBEZWxlZ2F0aW9uU3RyYXRlZ3lUeXBlIHwgdW5kZWZpbmVkID0gZGlhbG9nLmRlbGVnYXRpb25TdHJhdGVneTtcblxuICAgICAgICB0aGlzLmFkZEludGVudHMoLi4uaW50ZW50cyk7XG4gICAgICAgIHRoaXMuYWRkT3JNZXJnZVNsb3RUeXBlcyguLi5zbG90VHlwZXMpO1xuICAgICAgICB0aGlzLmFkZERpYWxvZ0ludGVudHMoLi4uZGlhbG9nSW50ZW50cyk7XG4gICAgICAgIGlmIChkZWxlZ2F0aW9uU3RyYXRlZ3kgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5hZGREZWxlZ2F0aW9uU3RyYXRlZ3koZGVsZWdhdGlvblN0cmF0ZWd5KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFkZFByb21wdHMoLi4ucHJvbXB0cyk7XG4gICAgICAgIHRoaXMud2l0aEludm9jYXRpb25OYW1lKGludm9jYXRpb25OYW1lKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCdWlsZCB0aGUgaW50ZXJhY3Rpb24gbW9kZWwuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyBBbiBgSW50ZXJhY3Rpb25Nb2RlbERhdGFgIG9iamVjdC5cbiAgICAgKi9cbiAgICBidWlsZCgpOiBJbnRlcmFjdGlvbk1vZGVsRGF0YSB7XG4gICAgICAgIGlmICghdGhpcy5pbnZvY2F0aW9uTmFtZSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdJbnZvY2F0aW9uIG5hbWUgaXMgbm90IGRlZmluZWQnKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpbnRlcmFjdGlvbk1vZGVsOiBJbnRlcmFjdGlvbk1vZGVsU2NoZW1hID0ge1xuICAgICAgICAgICAgbGFuZ3VhZ2VNb2RlbDoge30sXG4gICAgICAgICAgICBwcm9tcHRzOiBbXVxuICAgICAgICB9O1xuXG4gICAgICAgIGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEudHlwZXMgPSB0aGlzLnNsb3RUeXBlcztcbiAgICAgICAgaW50ZXJhY3Rpb25Nb2RlbC5sYW5ndWFnZU1vZGVsIS5pbnRlbnRzID0gdGhpcy5pbnRlbnRzO1xuICAgICAgICBpZiAodGhpcy5kaWFsb2dJbnRlbnRzLmxlbmd0aCA+IDAgfHwgdGhpcy5kZWxlZ2F0aW9uU3RyYXRlZ3kpIHtcbiAgICAgICAgICAgIGludGVyYWN0aW9uTW9kZWwuZGlhbG9nID0ge307XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZGlhbG9nSW50ZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBpbnRlcmFjdGlvbk1vZGVsLmRpYWxvZyEuaW50ZW50cyA9IHRoaXMuZGlhbG9nSW50ZW50cztcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5kZWxlZ2F0aW9uU3RyYXRlZ3kpIHtcbiAgICAgICAgICAgIGludGVyYWN0aW9uTW9kZWwuZGlhbG9nIS5kZWxlZ2F0aW9uU3RyYXRlZ3kgPSB0aGlzLmRlbGVnYXRpb25TdHJhdGVneTtcbiAgICAgICAgfVxuICAgICAgICBpbnRlcmFjdGlvbk1vZGVsLnByb21wdHMgPSB0aGlzLnByb21wdHM7XG4gICAgICAgIGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEuaW52b2NhdGlvbk5hbWUgPSB0aGlzLmludm9jYXRpb25OYW1lO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpbnRlcmFjdGlvbk1vZGVsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkIHRoZSBpbnRlcmFjdGlvbiBtb2RlbCBhbmQgd3JpdGUgdG8gZGlzay5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBmaWxlbmFtZSAtIEZpbGVuYW1lXG4gICAgICovXG4gICAgYnVpbGRBbmRXcml0ZShmaWxlbmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGludGVyYWN0aW9uTW9kZWxKc29uOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeSh0aGlzLmJ1aWxkKCksIG51bGwsIDIpO1xuICAgICAgICBjb25zdCBwYXRoOiBzdHJpbmcgPSBqb2luKHByb2Nlc3MuY3dkKCksIGZpbGVuYW1lKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLCBpbnRlcmFjdGlvbk1vZGVsSnNvbik7XG4gICAgfVxuXG59XG5cbmZ1bmN0aW9uIG1lcmdlU2xvdFR5cGVWYWx1ZXMoc2xvdFR5cGVWYWx1ZXM6IFR5cGVWYWx1ZVtdIHwgdW5kZWZpbmVkLCBuZXdTbG90VmFsdWU6IFR5cGVWYWx1ZSwgc2xvdE5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICghc2xvdFR5cGVWYWx1ZXMpIHtcbiAgICAgICAgc2xvdFR5cGVWYWx1ZXMgPSBbbmV3U2xvdFZhbHVlXTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBtYXRjaGluZ1ZhbHVlID0gc2xvdFR5cGVWYWx1ZXMuZmluZCh2ID0+IHYubmFtZT8udmFsdWUgPT09IG5ld1Nsb3RWYWx1ZS5uYW1lPy52YWx1ZSB8fCB2LmlkID09PSBuZXdTbG90VmFsdWUuaWQpO1xuICAgIGlmICghbWF0Y2hpbmdWYWx1ZSkge1xuICAgICAgICAvLyB2YWx1ZSBub3QgeWV0IHByZXNlbnQgc28ganVzdCBwdXNoIGl0XG4gICAgICAgIHNsb3RUeXBlVmFsdWVzLnB1c2gobmV3U2xvdFZhbHVlKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIC8vIHZhbHVlIHByZXNlbnQsIHNvIGFkZCBzeW5vbnltc1xuICAgICAgICBpZiAobWF0Y2hpbmdWYWx1ZS5uYW1lPy52YWx1ZSAhPT0gbmV3U2xvdFZhbHVlLm5hbWU/LnZhbHVlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBtZXJnZSBzbG90IHR5cGUgJHtzbG90TmFtZX0sIGFzIHRoZSB2YWx1ZSAke0pTT04uc3RyaW5naWZ5KG5ld1Nsb3RWYWx1ZSl9IGFuZCAke0pTT04uc3RyaW5naWZ5KG1hdGNoaW5nVmFsdWUpfSBoYXMgdGhlIHNhbWUgaWQgYnV0IGRpZmZlcmVudCBuYW1lLnZhbHVlLmApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXRjaGluZ1ZhbHVlLmlkICE9PSBuZXdTbG90VmFsdWUuaWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IG1lcmdlIHNsb3QgdHlwZSAke3Nsb3ROYW1lfSwgYXMgdGhlIHZhbHVlICR7SlNPTi5zdHJpbmdpZnkobmV3U2xvdFZhbHVlKX0gYW5kICR7SlNPTi5zdHJpbmdpZnkobWF0Y2hpbmdWYWx1ZSl9IGhhcyB0aGUgc2FtZSBuYW1lLnZhbHVlIGJ1dCBkaWZmZXJlbnQgaWQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IHN5bm9ueW0gb2YgbmV3U2xvdFZhbHVlLm5hbWU/LnN5bm9ueW1zID8/IFtdKSB7XG4gICAgICAgICAgICBjb25zdCBtYXRjaGluZ1N5bm9ueW0gPSBtYXRjaGluZ1ZhbHVlLm5hbWU/LnN5bm9ueW1zPy5maW5kKHMgPT4gcyA9PT0gc3lub255bSk7XG4gICAgICAgICAgICBpZiAobWF0Y2hpbmdTeW5vbnltID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAvLyBzeW5vbnltIG5vdCB5ZXQgcHJlc2V0IHNvIGp1c3QgcHVzaCBpdFxuICAgICAgICAgICAgICAgIG1hdGNoaW5nVmFsdWUubmFtZT8uc3lub255bXM/LnB1c2goc3lub255bSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=