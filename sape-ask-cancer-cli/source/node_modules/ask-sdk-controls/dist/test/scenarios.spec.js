"use strict";
/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const chai_1 = require("chai");
const mocha_1 = require("mocha");
const src_1 = require("../src");
const NumberControl_1 = require("../src/commonControls/NumberControl");
const ValueControl_1 = require("../src/commonControls/ValueControl");
const Strings_1 = require("../src/constants/Strings");
const ContainerControl_1 = require("../src/controls/ContainerControl");
const ControlManager_1 = require("../src/controls/ControlManager");
const ControlResult_1 = require("../src/controls/ControlResult");
const GeneralControlIntent_1 = require("../src/intents/GeneralControlIntent");
const SingleValueControlIntent_1 = require("../src/intents/SingleValueControlIntent");
const SessionBehavior_1 = require("../src/runtime/SessionBehavior");
const ContentActs_1 = require("../src/systemActs/ContentActs");
const InitiativeActs_1 = require("../src/systemActs/InitiativeActs");
const TestingUtils_1 = require("../src/utils/testSupport/TestingUtils");
const game_strings_1 = require("./game_strings");
TestingUtils_1.waitForDebugger();
mocha_1.suite("== Single value selector scenarios ==", () => {
    class SingleSelectorManager extends ControlManager_1.ControlManager {
        createControlTree(state) {
            const topControl = new ContainerControl_1.ContainerControl({ id: "root" });
            topControl.addChild(new ValueControl_1.ValueControl({
                id: game_strings_1.GameStrings.ID.PlayerName,
                slotType: 'CUSTOM.name',
                prompts: { requestValue: "none" },
                interactionModel: { targets: [game_strings_1.GameStrings.Target.Name] }
            }));
            return topControl;
        }
    }
    mocha_1.test("simple set-value input should be processed.", async () => {
        // Note: this test demonstrates calling handle() on a single control (yielding a ControlResult)
        const rootControl = new SingleSelectorManager().createControlTree({});
        const input = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of('CUSTOM.name', { 'action': Strings_1.Strings.Action.Set, 'target': game_strings_1.GameStrings.Target.Name, 'CUSTOM.name': "Mike" }));
        const result = new ControlResult_1.ControlResultBuilder(undefined);
        await rootControl.canHandle(input);
        await rootControl.handle(input, result);
        const playerNameState = TestingUtils_1.findControlById(rootControl, game_strings_1.GameStrings.ID.PlayerName);
        chai_1.expect(playerNameState.state.value).eq("Mike");
        chai_1.expect(result.acts).length(1);
        chai_1.expect(result.acts[0]).instanceOf(ContentActs_1.ValueSetAct);
    });
    mocha_1.test("valueType mismatch should cause processing to throw", async () => {
        const rootControl = new SingleSelectorManager().createControlTree({});
        const input = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of('AMAZON.Number', { 'action': Strings_1.Strings.Action.Set, 'target': game_strings_1.GameStrings.Target.Name, 'AMAZON.Number': 'Mike' }));
        chai_1.expect(async () => { await rootControl.handle(input, new ControlResult_1.ControlResultBuilder(undefined)); }).throws;
    });
    mocha_1.test("session ending due to lack of initiative", async () => {
        const rootControl = new SingleSelectorManager().createControlTree({});
        const input = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of('CUSTOM.name', { 'action': Strings_1.Strings.Action.Set, 'target': game_strings_1.GameStrings.Target.Name, 'CUSTOM.name': "Mike" }));
        const result = await TestingUtils_1.simpleInvoke(rootControl, input);
        chai_1.expect(result.acts[0]).instanceOf(ContentActs_1.ValueSetAct);
        chai_1.expect(result.sessionBehavior).equals(SessionBehavior_1.SessionBehavior.OPEN);
    });
});
mocha_1.suite("== Two controls that collect numbers. One is ValueControl{AMAZON.NUMBER} and other is NumberControl ==", () => {
    const PLAYER_COUNT = 'playerCount'; // used for both controlID and target.
    const PLAYER_AGE = 'playerAge'; // used for both controlID and target.
    class TwoSelectorManager extends ControlManager_1.ControlManager {
        createControlTree(state, input) {
            const rootControl = new ContainerControl_1.ContainerControl({ id: 'root' });
            rootControl
                .addChild(new ValueControl_1.ValueControl({
                id: PLAYER_COUNT,
                slotType: 'AMAZON.NUMBER',
                prompts: { requestValue: "none" },
                interactionModel: { targets: [PLAYER_COUNT] }
            }))
                .addChild(new NumberControl_1.NumberControl({
                id: PLAYER_AGE,
                prompts: { requestValue: "none" },
                interactionModel: { targets: [PLAYER_AGE] }
            }));
            return rootControl;
        }
    }
    mocha_1.test("U: set count, A: move focus and ask question", async () => {
        // Note: this test demonstrates calling simpleInvoke() which includes the initiative phase (yielding a composite ControlResult)
        const rootControl = new TwoSelectorManager().createControlTree({});
        const input = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of(src_1.AmazonBuiltInSlotType.NUMBER, { 'action': Strings_1.Strings.Action.Set, 'target': PLAYER_COUNT, 'AMAZON.NUMBER': "3" }));
        const result = await TestingUtils_1.simpleInvoke(rootControl, input);
        const playerCountState = TestingUtils_1.findControlById(rootControl, PLAYER_COUNT);
        chai_1.expect(playerCountState.state.value).eq("3");
        chai_1.expect(result.acts[0]).instanceOf(ContentActs_1.ValueSetAct);
        chai_1.expect(result.acts[1]).instanceOf(InitiativeActs_1.RequestValueAct);
    });
    mocha_1.test("U: set count, A:move focus and ask question, U: change count to specific value", async () => {
        const rootControl = new TwoSelectorManager().createControlTree({});
        // -- turn 1
        const input1 = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of(src_1.AmazonBuiltInSlotType.NUMBER, { 'action': Strings_1.Strings.Action.Set, 'target': PLAYER_COUNT, 'AMAZON.NUMBER': "3" }));
        const result1 = await TestingUtils_1.simpleInvoke(rootControl, input1);
        chai_1.expect(result1.acts).length(2);
        chai_1.expect(result1.acts[1].control.id).eq(PLAYER_AGE); // <-- ask for age
        // -- turn 2
        const request2 = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of(src_1.AmazonBuiltInSlotType.NUMBER, { 'action': Strings_1.Strings.Action.Change, 'target': PLAYER_COUNT, 'AMAZON.NUMBER': "4" }));
        const result2 = await TestingUtils_1.simpleInvoke(rootControl, request2);
        const playerCountState = TestingUtils_1.findControlById(rootControl, PLAYER_COUNT);
        chai_1.expect(playerCountState.state.value).eq("4"); // <--- changed successfully
        chai_1.expect(result2.acts[0]).instanceOf(ContentActs_1.ValueChangedAct); // <--- appropriate feedback act
        chai_1.expect(result2.acts[1]).instanceOf(InitiativeActs_1.RequestValueAct); // <-- ask for age again.
        chai_1.expect(result2.acts[1].control.id).eq(PLAYER_AGE); // <-- ask for age again.
    });
    mocha_1.test("U: set count, A:move focus and ask question, U: change count, A: request value, U: give value (multi-step set)", async () => {
        const rootControl = new TwoSelectorManager().createControlTree();
        // -- turn 1
        const input1 = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of(src_1.AmazonBuiltInSlotType.NUMBER, { 'action': Strings_1.Strings.Action.Set, 'target': PLAYER_COUNT, 'AMAZON.NUMBER': "3" }));
        const result1 = await TestingUtils_1.simpleInvoke(rootControl, input1);
        chai_1.expect(result1.acts).length(2);
        chai_1.expect(result1.acts[1]).instanceof(InitiativeActs_1.RequestValueAct);
        // -- turn 2
        const input2 = TestingUtils_1.TestInput.of(GeneralControlIntent_1.GeneralControlIntent.of({ action: Strings_1.Strings.Action.Change, target: PLAYER_COUNT }));
        const result2 = await TestingUtils_1.simpleInvoke(rootControl, input2);
        chai_1.expect(result2.acts[0]).instanceOf(InitiativeActs_1.RequestChangedValueAct);
        chai_1.expect(result2.acts[0].control.id).eq(PLAYER_COUNT);
        // -- turn 3
        const input3 = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of(src_1.AmazonBuiltInSlotType.NUMBER, { 'AMAZON.NUMBER': '4' }));
        const result3 = await TestingUtils_1.simpleInvoke(rootControl, input3);
        chai_1.expect(result3.acts[0]).instanceOf(ContentActs_1.ValueChangedAct);
        chai_1.expect(result3.acts[0].control.id).eq(PLAYER_COUNT);
        chai_1.expect(result3.acts[1]).instanceOf(InitiativeActs_1.RequestValueAct);
        chai_1.expect(result3.acts[1].control.id === PLAYER_AGE);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmFyaW9zLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90ZXN0L3NjZW5hcmlvcy5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7QUFFSCwrQkFBOEI7QUFDOUIsaUNBQW9DO0FBQ3BDLGdDQUErQztBQUMvQyx1RUFBb0U7QUFDcEUscUVBQWtFO0FBQ2xFLHNEQUF3RDtBQUN4RCx1RUFBb0U7QUFHcEUsbUVBQWdFO0FBQ2hFLGlFQUFxRTtBQUNyRSw4RUFBMkU7QUFDM0Usc0ZBQW1GO0FBQ25GLG9FQUFpRTtBQUNqRSwrREFBNkU7QUFDN0UscUVBQTJGO0FBRTNGLHdFQUFrSDtBQUNsSCxpREFBbUQ7QUFFbkQsOEJBQWUsRUFBRSxDQUFDO0FBR2xCLGFBQUssQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7SUFFaEQsTUFBTSxxQkFBc0IsU0FBUSwrQkFBYztRQUM5QyxpQkFBaUIsQ0FBQyxLQUFVO1lBQ3hCLE1BQU0sVUFBVSxHQUFHLElBQUksbUNBQWdCLENBQUMsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUN4RCxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksMkJBQVksQ0FDaEM7Z0JBQ0ksRUFBRSxFQUFFLDBCQUFFLENBQUMsRUFBRSxDQUFDLFVBQVU7Z0JBQ3BCLFFBQVEsRUFBRSxhQUFhO2dCQUN2QixPQUFPLEVBQUUsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFO2dCQUNqQyxnQkFBZ0IsRUFBRSxFQUFFLE9BQU8sRUFBRSxDQUFDLDBCQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFO2FBQ2xELENBQ0osQ0FBQyxDQUFDO1lBRUgsT0FBTyxVQUFVLENBQUM7UUFDdEIsQ0FBQztLQUNKO0lBQ0QsWUFBSSxDQUFDLDZDQUE2QyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBRTNELCtGQUErRjtRQUUvRixNQUFNLFdBQVcsR0FBRyxJQUFJLHFC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QUUsZUFBZSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNqSCxNQUFNLE9BQU8sR0FBRyxNQUFNLDJCQUFZLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXhELGFBQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLDZCQUFlLENBQUMsQ0FBQztRQUNwRCxhQUFNLENBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQWUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ25FLGFBQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLGdDQUFlLENBQUMsQ0FBQztRQUNwRCxhQUFNLENBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQWUsQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLFVBQVUsQ0FBQyxDQUFDO0lBQ3JFLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMjAgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tIFwiY2hhaVwiO1xuaW1wb3J0IHsgc3VpdGUsIHRlc3QgfSBmcm9tIFwibW9jaGFcIjtcbmltcG9ydCB7IEFtYXpvbkJ1aWx0SW5TbG90VHlwZSB9IGZyb20gJy4uL3NyYyc7XG5pbXBvcnQgeyBOdW1iZXJDb250cm9sIH0gZnJvbSAnLi4vc3JjL2NvbW1vbkNvbnRyb2xzL051bWJlckNvbnRyb2wnO1xuaW1wb3J0IHsgVmFsdWVDb250cm9sIH0gZnJvbSAnLi4vc3JjL2NvbW1vbkNvbnRyb2xzL1ZhbHVlQ29udHJvbCc7XG5pbXBvcnQgeyBTdHJpbmdzIGFzICQgfSBmcm9tIFwiLi4vc3JjL2NvbnN0YW50cy9TdHJpbmdzXCI7XG5pbXBvcnQgeyBDb250YWluZXJDb250cm9sIH0gZnJvbSAnLi4vc3JjL2NvbnRyb2xzL0NvbnRhaW5lckNvbnRyb2wnO1xuaW1wb3J0IHsgQ29udHJvbCB9IGZyb20gJy4uL3NyYy9jb250cm9scy9Db250cm9sJztcbmltcG9ydCB7IENvbnRyb2xJbnB1dCB9IGZyb20gJy4uL3NyYy9jb250cm9scy9Db250cm9sSW5wdXQnO1xuaW1wb3J0IHsgQ29udHJvbE1hbmFnZXIgfSBmcm9tICcuLi9zcmMvY29udHJvbHMvQ29udHJvbE1hbmFnZXInO1xuaW1wb3J0IHsgQ29udHJvbFJlc3VsdEJ1aWxkZXIgfSBmcm9tICcuLi9zcmMvY29udHJvbHMvQ29udHJvbFJlc3VsdCc7XG5pbXBvcnQgeyBHZW5lcmFsQ29udHJvbEludGVudCB9IGZyb20gJy4uL3NyYy9pbnRlbnRzL0dlbmVyYWxDb250cm9sSW50ZW50JztcbmltcG9ydCB7IFNpbmdsZVZhbHVlQ29udHJvbEludGVudCB9IGZyb20gJy4uL3NyYy9pbnRlbnRzL1NpbmdsZVZhbHVlQ29udHJvbEludGVudCc7XG5pbXBvcnQgeyBTZXNzaW9uQmVoYXZpb3IgfSBmcm9tICcuLi9zcmMvcnVudGltZS9TZXNzaW9uQmVoYXZpb3InO1xuaW1wb3J0IHsgVmFsdWVDaGFuZ2VkQWN0LCBWYWx1ZVNldEFjdCB9IGZyb20gJy4uL3NyYy9zeXN0ZW1BY3RzL0NvbnRlbnRBY3RzJztcbmltcG9ydCB7IFJlcXVlc3RDaGFuZ2VkVmFsdWVBY3QsIFJlcXVlc3RWYWx1ZUFjdCB9IGZyb20gJy4uL3NyYy9zeXN0ZW1BY3RzL0luaXRpYXRpdmVBY3RzJztcbmltcG9ydCB7IFN5c3RlbUFjdCB9IGZyb20gJy4uL3NyYy9zeXN0ZW1BY3RzL1N5c3RlbUFjdCc7XG5pbXBvcnQgeyBmaW5kQ29udHJvbEJ5SWQsIHNpbXBsZUludm9rZSwgVGVzdElucHV0LCB3YWl0Rm9yRGVidWdnZXIgfSBmcm9tIFwiLi4vc3JjL3V0aWxzL3Rlc3RTdXBwb3J0L1Rlc3RpbmdVdGlsc1wiO1xuaW1wb3J0IHsgR2FtZVN0cmluZ3MgYXMgJCQgfSBmcm9tIFwiLi9nYW1lX3N0cmluZ3NcIjtcblxud2FpdEZvckRlYnVnZ2VyKCk7XG5cblxuc3VpdGUoXCI9PSBTaW5nbGUgdmFsdWUgc2VsZWN0b3Igc2NlbmFyaW9zID09XCIsICgpID0+IHtcblxuICAgIGNsYXNzIFNpbmdsZVNlbGVjdG9yTWFuYWdlciBleHRlbmRzIENvbnRyb2xNYW5hZ2VyIHtcbiAgICAgICAgY3JlYXRlQ29udHJvbFRyZWUoc3RhdGU6IGFueSk6IENvbnRyb2wge1xuICAgICAgICAgICAgY29uc3QgdG9wQ29udHJvbCA9IG5ldyBDb250YWluZXJDb250cm9sKHsgaWQ6IFwicm9vdFwiIH0pO1xuICAgICAgICAgICAgdG9wQ29udHJvbC5hZGRDaGlsZChuZXcgVmFsdWVDb250cm9sKFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6ICQkLklELlBsYXllck5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHNsb3RUeXBlOiAnQ1VTVE9NLm5hbWUnLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHRzOiB7IHJlcXVlc3RWYWx1ZTogXCJub25lXCIgfSxcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJhY3Rpb25Nb2RlbDogeyB0YXJnZXRzOiBbJCQuVGFyZ2V0Lk5hbWVdIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApKTtcblxuICAgICAgICAgICAgcmV0dXJuIHRvcENvbnRyb2w7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGVzdChcInNpbXBsZSBzZXQtdmFsdWUgaW5wdXQgc2hvdWxkIGJlIHByb2Nlc3NlZC5cIiwgYXN5bmMgKCkgPT4ge1xuXG4gICAgICAgIC8vIE5vdGU6IHRoaXMgdGVzdCBkZW1vbnN0cmF0ZXMgY2FsbGluZyBoYW5kbGUoKSBvbiBhIHNpbmdsZSBjb250cm9sICh5aWVsZGluZyBhIENvbnRyb2xSZXN1bHQpXG5cbiAgICAgICAgY29uc3Qgcm9vdENvbnRyb2wgPSBuZXcgU2luZ2xlU2VsZWN0b3JNYW5hZ2VyKCkuY3JlYXRlQ29udHJvbFRyZWUoe30pO1xuICAgICAgICBjb25zdCBpbnB1dCA9IFRlc3RJbnB1dC5vZihTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQub2YoJ0NVU1RPTS5uYW1lJywgeyAnYWN0aW9uJzogJC5BY3Rpb24uU2V0LCAndGFyZ2V0JzogJCQuVGFyZ2V0Lk5hbWUsICdDVVNUT00ubmFtZSc6IFwiTWlrZVwiIH0pKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IENvbnRyb2xSZXN1bHRCdWlsZGVyKHVuZGVmaW5lZCEpO1xuICAgICAgICBhd2FpdCByb290Q29udHJvbC5jYW5IYW5kbGUoaW5wdXQpO1xuICAgICAgICBhd2FpdCByb290Q29udHJvbC5oYW5kbGUoaW5wdXQsIHJlc3VsdCk7XG4gICAgICAgIGNvbnN0IHBsYXllck5hbWVTdGF0ZSA9IGZpbmRDb250cm9sQnlJZChyb290Q29udHJvbCwgJCQuSUQuUGxheWVyTmFtZSk7XG4gICAgICAgIGV4cGVjdChwbGF5ZXJOYW1lU3RhdGUuc3RhdGUudmFsdWUpLmVxKFwiTWlrZVwiKTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5hY3RzKS5sZW5ndGgoMSk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuYWN0c1swXSkuaW5zdGFuY2VPZihWYWx1ZVNldEFjdCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KFwidmFsdWVUeXBlIG1pc21hdGNoIHNob3VsZCBjYXVzZSBwcm9jZXNzaW5nIHRvIHRocm93XCIsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgcm9vdENvbnRyb2wgPSBuZXcgU2luZ2xlU2VsZWN0b3JNYW5hZ2VyKCkuY3JlYXRlQ29udHJvbFRyZWUoe30pO1xuICAgICAgICBjb25zdCBpbnB1dCA9IFRlc3RJbnB1dC5vZihTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQub2YoJ0FNQVpPTi5OdW1iZXInLCB7ICdhY3Rpb24nOiAkLkFjdGlvbi5TZXQsICd0YXJnZXQnOiAkJC5UYXJnZXQuTmFtZSwgJ0FNQVpPTi5OdW1iZXInOiAnTWlrZScgfSkpO1xuICAgICAgICBleHBlY3QoYXN5bmMgKCkgPT4geyBhd2FpdCByb290Q29udHJvbC5oYW5kbGUoaW5wdXQsIG5ldyBDb250cm9sUmVzdWx0QnVpbGRlcih1bmRlZmluZWQhKSk7IH0pLnRocm93cztcbiAgICB9KTtcblxuXG4gICAgdGVzdChcInNlc3Npb24gZW5kaW5nIGR1ZSB0byBsYWNrIG9mIGluaXRpYXRpdmVcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByb290Q29udHJvbCA9IG5ldyBTaW5nbGVTZWxlY3Rvck1hbmFnZXIoKS5jcmVhdGVDb250cm9sVHJlZSh7fSk7XG4gICAgICAgIGNvbnN0IGlucHV0ID0gVGVzdElucHV0Lm9mKFNpbmdsZVZhbHVlQ29udHJvbEludGVudC5vZignQ1VTVE9NLm5hbWUnLCB7ICdhY3Rpb24nOiAkLkFjdGlvbi5TZXQsICd0YXJnZXQnOiAkJC5UYXJnZXQuTmFtZSwgJ0NVU1RPTS5uYW1lJzogXCJNaWtlXCIgfSkpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzaW1wbGVJbnZva2Uocm9vdENvbnRyb2wsIGlucHV0KTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5hY3RzWzBdKS5pbnN0YW5jZU9mKFZhbHVlU2V0QWN0KTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5zZXNzaW9uQmVoYXZpb3IpLmVxdWFscyhTZXNzaW9uQmVoYXZpb3IuT1BFTik7XG4gICAgfSk7XG59KTtcblxuXG5zdWl0ZShcIj09IFR3byBjb250cm9scyB0aGF0IGNvbGxlY3QgbnVtYmVycy4gT25lIGlzIFZhbHVlQ29udHJvbHtBTUFaT04uTlVNQkVSfSBhbmQgb3RoZXIgaXMgTnVtYmVyQ29udHJvbCA9PVwiLCAoKSA9PiB7XG5cbiAgICBjb25zdCBQTEFZRVJfQ09VTlQgPSAncGxheWVyQ291bnQnOyAvLyB1c2VkIGZvciBib3RoIGNvbnRyb2xJRCBhbmQgdGFyZ2V0LlxuICAgIGNvbnN0IFBMQVlFUl9BR0UgPSAncGxheWVyQWdlJzsgLy8gdXNlZCBmb3IgYm90aCBjb250cm9sSUQgYW5kIHRhcmdldC5cblxuICAgIGNsYXNzIFR3b1NlbGVjdG9yTWFuYWdlciBleHRlbmRzIENvbnRyb2xNYW5hZ2VyIHtcblxuICAgICAgICBjcmVhdGVDb250cm9sVHJlZShzdGF0ZT86IGFueSwgaW5wdXQ/OiBDb250cm9sSW5wdXQpOiBDb250cm9sIHtcbiAgICAgICAgICAgIGNvbnN0IHJvb3RDb250cm9sID0gbmV3IENvbnRhaW5lckNvbnRyb2woeyBpZDogJ3Jvb3QnIH0pO1xuXG4gICAgICAgICAgICByb290Q29udHJvbFxuICAgICAgICAgICAgICAgIC5hZGRDaGlsZChcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZhbHVlQ29udHJvbChcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogUExBWUVSX0NPVU5ULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsb3RUeXBlOiAnQU1BWk9OLk5VTUJFUicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbXB0czogeyByZXF1ZXN0VmFsdWU6IFwibm9uZVwiIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJhY3Rpb25Nb2RlbDogeyB0YXJnZXRzOiBbUExBWUVSX0NPVU5UXSB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgICAgICAuYWRkQ2hpbGQoXG4gICAgICAgICAgICAgICAgICAgIG5ldyBOdW1iZXJDb250cm9sKFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBQTEFZRVJfQUdFLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21wdHM6IHsgcmVxdWVzdFZhbHVlOiBcIm5vbmVcIiB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVyYWN0aW9uTW9kZWw6IHsgdGFyZ2V0czogW1BMQVlFUl9BR0VdIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJvb3RDb250cm9sO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdGVzdChcIlU6IHNldCBjb3VudCwgQTogbW92ZSBmb2N1cyBhbmQgYXNrIHF1ZXN0aW9uXCIsIGFzeW5jICgpID0+IHtcblxuICAgICAgICAvLyBOb3RlOiB0aGlzIHRlc3QgZGVtb25zdHJhdGVzIGNhbGxpbmcgc2ltcGxlSW52b2tlKCkgd2hpY2ggaW5jbHVkZXMgdGhlIGluaXRpYXRpdmUgcGhhc2UgKHlpZWxkaW5nIGEgY29tcG9zaXRlIENvbnRyb2xSZXN1bHQpXG5cbiAgICAgICAgY29uc3Qgcm9vdENvbnRyb2wgPSBuZXcgVHdvU2VsZWN0b3JNYW5hZ2VyKCkuY3JlYXRlQ29udHJvbFRyZWUoe30pO1xuICAgICAgICBjb25zdCBpbnB1dCA9IFRlc3RJbnB1dC5vZihTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQub2YoQW1hem9uQnVpbHRJblNsb3RUeXBlLk5VTUJFUiwgeyAnYWN0aW9uJzogJC5BY3Rpb24uU2V0LCAndGFyZ2V0JzogUExBWUVSX0NPVU5ULCAnQU1BWk9OLk5VTUJFUicgOiBcIjNcIiB9KSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNpbXBsZUludm9rZShyb290Q29udHJvbCwgaW5wdXQpO1xuICAgICAgICBjb25zdCBwbGF5ZXJDb3VudFN0YXRlID0gZmluZENvbnRyb2xCeUlkKHJvb3RDb250cm9sLCBQTEFZRVJfQ09VTlQpO1xuICAgICAgICBleHBlY3QocGxheWVyQ291bnRTdGF0ZS5zdGF0ZS52YWx1ZSkuZXEoXCIzXCIpO1xuICAgICAgICBleHBlY3QocmVzdWx0LmFjdHNbMF0pLmluc3RhbmNlT2YoVmFsdWVTZXRBY3QpO1xuICAgICAgICBleHBlY3QocmVzdWx0LmFjdHNbMV0pLmluc3RhbmNlT2YoUmVxdWVzdFZhbHVlQWN0KTtcbiAgICB9KTtcblxuICAgIHRlc3QoXCJVOiBzZXQgY291bnQsIEE6bW92ZSBmb2N1cyBhbmQgYXNrIHF1ZXN0aW9uLCBVOiBjaGFuZ2UgY291bnQgdG8gc3BlY2lmaWMgdmFsdWVcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByb290Q29udHJvbCA9IG5ldyBUd29TZWxlY3Rvck1hbmFnZXIoKS5jcmVhdGVDb250cm9sVHJlZSh7fSk7XG5cbiAgICAgICAgLy8gLS0gdHVybiAxXG4gICAgICAgIGNvbnN0IGlucHV0MSA9IFRlc3RJbnB1dC5vZihTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQub2YoQW1hem9uQnVpbHRJblNsb3RUeXBlLk5VTUJFUiwgeyAnYWN0aW9uJzogJC5BY3Rpb24uU2V0LCAndGFyZ2V0JzogUExBWUVSX0NPVU5ULCAnQU1BWk9OLk5VTUJFUic6IFwiM1wiIH0pKTtcbiAgICAgICAgY29uc3QgcmVzdWx0MSA9IGF3YWl0IHNpbXBsZUludm9rZShyb290Q29udHJvbCwgaW5wdXQxKTtcblxuICAgICAgICBleHBlY3QocmVzdWx0MS5hY3RzKS5sZW5ndGgoMik7XG4gICAgICAgIGV4cGVjdCgocmVzdWx0MS5hY3RzWzFdIGFzIFN5c3RlbUFjdCkuY29udHJvbC5pZCkuZXEoUExBWUVSX0FHRSk7IC8vIDwtLSBhc2sgZm9yIGFnZVxuXG4gICAgICAgIC8vIC0tIHR1cm4gMlxuICAgICAgICBjb25zdCByZXF1ZXN0MiA9IFRlc3RJbnB1dC5vZihTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQub2YoQW1hem9uQnVpbHRJblNsb3RUeXBlLk5VTUJFUiwgeyAnYWN0aW9uJzogJC5BY3Rpb24uQ2hhbmdlLCAndGFyZ2V0JzogUExBWUVSX0NPVU5ULCAnQU1BWk9OLk5VTUJFUic6IFwiNFwiIH0pKTtcbiAgICAgICAgY29uc3QgcmVzdWx0MiA9IGF3YWl0IHNpbXBsZUludm9rZShyb290Q29udHJvbCwgcmVxdWVzdDIpO1xuXG4gICAgICAgIGNvbnN0IHBsYXllckNvdW50U3RhdGUgPSBmaW5kQ29udHJvbEJ5SWQocm9vdENvbnRyb2wsIFBMQVlFUl9DT1VOVCk7XG4gICAgICAgIGV4cGVjdChwbGF5ZXJDb3VudFN0YXRlLnN0YXRlLnZhbHVlKS5lcShcIjRcIik7IC8vIDwtLS0gY2hhbmdlZCBzdWNjZXNzZnVsbHlcbiAgICAgICAgZXhwZWN0KHJlc3VsdDIuYWN0c1swXSkuaW5zdGFuY2VPZihWYWx1ZUNoYW5nZWRBY3QpOyAvLyA8LS0tIGFwcHJvcHJpYXRlIGZlZWRiYWNrIGFjdFxuICAgICAgICBleHBlY3QocmVzdWx0Mi5hY3RzWzFdKS5pbnN0YW5jZU9mKFJlcXVlc3RWYWx1ZUFjdCk7IC8vIDwtLSBhc2sgZm9yIGFnZSBhZ2Fpbi5cbiAgICAgICAgZXhwZWN0KChyZXN1bHQyLmFjdHNbMV0gYXMgU3lzdGVtQWN0KS5jb250cm9sLmlkKS5lcShQTEFZRVJfQUdFKTsgLy8gPC0tIGFzayBmb3IgYWdlIGFnYWluLlxuICAgIH0pO1xuXG5cbiAgICB0ZXN0KFwiVTogc2V0IGNvdW50LCBBOm1vdmUgZm9jdXMgYW5kIGFzayBxdWVzdGlvbiwgVTogY2hhbmdlIGNvdW50LCBBOiByZXF1ZXN0IHZhbHVlLCBVOiBnaXZlIHZhbHVlIChtdWx0aS1zdGVwIHNldClcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByb290Q29udHJvbCA9IG5ldyBUd29TZWxlY3Rvck1hbmFnZXIoKS5jcmVhdGVDb250cm9sVHJlZSgpO1xuXG4gICAgICAgIC8vIC0tIHR1cm4gMVxuICAgICAgICBjb25zdCBpbnB1dDEgPSBUZXN0SW5wdXQub2YoU2luZ2xlVmFsdWVDb250cm9sSW50ZW50Lm9mKEFtYXpvbkJ1aWx0SW5TbG90VHlwZS5OVU1CRVIsIHsgJ2FjdGlvbic6ICQuQWN0aW9uLlNldCwgJ3RhcmdldCc6IFBMQVlFUl9DT1VOVCwgJ0FNQVpPTi5OVU1CRVInOiBcIjNcIiB9KSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDEgPSBhd2FpdCBzaW1wbGVJbnZva2Uocm9vdENvbnRyb2wsIGlucHV0MSk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQxLmFjdHMpLmxlbmd0aCgyKTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdDEuYWN0c1sxXSkuaW5zdGFuY2VvZihSZXF1ZXN0VmFsdWVBY3QpO1xuXG4gICAgICAgIC8vIC0tIHR1cm4gMlxuICAgICAgICBjb25zdCBpbnB1dDIgPSBUZXN0SW5wdXQub2YoR2VuZXJhbENvbnRyb2xJbnRlbnQub2YoeyBhY3Rpb246ICQuQWN0aW9uLkNoYW5nZSwgdGFyZ2V0OiBQTEFZRVJfQ09VTlQgfSkpO1xuICAgICAgICBjb25zdCByZXN1bHQyID0gYXdhaXQgc2ltcGxlSW52b2tlKHJvb3RDb250cm9sLCBpbnB1dDIpO1xuICAgICAgICBleHBlY3QocmVzdWx0Mi5hY3RzWzBdKS5pbnN0YW5jZU9mKFJlcXVlc3RDaGFuZ2VkVmFsdWVBY3QpO1xuICAgICAgICBleHBlY3QoKHJlc3VsdDIuYWN0c1swXSBhcyBTeXN0ZW1BY3QpLmNvbnRyb2wuaWQpLmVxKFBMQVlFUl9DT1VOVCk7XG5cbiAgICAgICAgLy8gLS0gdHVybiAzXG4gICAgICAgIGNvbnN0IGlucHV0MyA9IFRlc3RJbnB1dC5vZihTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQub2YoQW1hem9uQnVpbHRJblNsb3RUeXBlLk5VTUJFUiwgeyAnQU1BWk9OLk5VTUJFUic6ICc0JyB9KSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDMgPSBhd2FpdCBzaW1wbGVJbnZva2Uocm9vdENvbnRyb2wsIGlucHV0Myk7XG5cbiAgICAgICAgZXhwZWN0KHJlc3VsdDMuYWN0c1swXSkuaW5zdGFuY2VPZihWYWx1ZUNoYW5nZWRBY3QpO1xuICAgICAgICBleHBlY3QoKHJlc3VsdDMuYWN0c1swXSBhcyBTeXN0ZW1BY3QpLmNvbnRyb2wuaWQpLmVxKFBMQVlFUl9DT1VOVCk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQzLmFjdHNbMV0pLmluc3RhbmNlT2YoUmVxdWVzdFZhbHVlQWN0KTtcbiAgICAgICAgZXhwZWN0KChyZXN1bHQzLmFjdHNbMV0gYXMgU3lzdGVtQWN0KS5jb250cm9sLmlkID09PSBQTEFZRVJfQUdFKTtcbiAgICB9KTtcbn0pO1xuIl19