"use strict";
/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const chai_1 = require("chai");
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const mocha_1 = require("mocha");
const Strings_1 = require("../src/constants/Strings");
const ControlManager_1 = require("../src/controls/ControlManager");
const ErrorUtils_1 = require("../src/utils/ErrorUtils");
const TestingUtils_1 = require("../src/utils/testSupport/TestingUtils");
const game_strings_1 = require("./game_strings");
const SingleValueControlIntent_1 = require("../src/intents/SingleValueControlIntent");
const GeneralControlIntent_1 = require("../src/intents/GeneralControlIntent");
const InitiativeActs_1 = require("../src/systemActs/InitiativeActs");
const ContainerControl_1 = require("../src/controls/ContainerControl");
const ValueControl_1 = require("../src/commonControls/ValueControl");
const NumberControl_1 = require("../src/commonControls/NumberControl");
/**
 * Demonstrate standard ControlState object but with different Controls to handle them
 * the choice of control to use is by controlState.type and by registering the control types
 * with the UserInterface so that it can function as a control factory.
 */
mocha_1.suite("== Custom policy scenarios (custom_policy.ts) ==", () => {
    mocha_1.test("container with custom canHandle that always returns false.", async () => {
        const rootControl = new CustomManager('never').createControlTree();
        const input = TestingUtils_1.TestInput.of(SingleValueControlIntent_1.SingleValueControlIntent.of('CUSTOM.name', { 'action': Strings_1.Strings.Action.Set, 'target': game_strings_1.GameStrings.Target.Name, 'CUSTOM.name': "Mike" }));
        const result = await TestingUtils_1.simpleInvoke(rootControl, input);
        chai_1.expect(result.acts).length(0);
    });
    mocha_1.test("Default canHandle returns first listed control (playerName)", async () => {
        const rootControl = new CustomManager('normal').createControlTree();
        const input = TestingUtils_1.TestInput.of(GeneralControlIntent_1.GeneralControlIntent.of({ action: Strings_1.Strings.Action.Set })); // TODO:handle SingleValueControlIntent with just slotTypes
        const result = await TestingUtils_1.simpleInvoke(rootControl, input);
        chai_1.expect(result.acts[0]).instanceOf(InitiativeActs_1.RequestValueAct);
        chai_1.expect(result.acts[0].control.id).equals(game_strings_1.GameStrings.ID.PlayerName);
    });
    mocha_1.test("Custom policy for container.canHandle returns different initiative control (playerAge rather than playerName)", async () => {
        const rootControl = new CustomManager('reverse').createControlTree();
        const input = TestingUtils_1.TestInput.of(GeneralControlIntent_1.GeneralControlIntent.of({ action: Strings_1.Strings.Action.Set })); // TODO:handle SingleValueControlIntent with just slotTypes
        const result = await TestingUtils_1.simpleInvoke(rootControl, input);
        chai_1.expect(result.acts[0]).instanceOf(InitiativeActs_1.RequestValueAct);
        chai_1.expect(result.acts[0].control.id).equals(game_strings_1.GameStrings.ID.PlayerAge); // <====== RESULT: Requesting Age rather than Name.
    });
});
class CustomManager extends ControlManager_1.ControlManager {
    constructor(type) {
        super();
        this.type = type;
    }
    createControlTree(state, input) {
        let topControl;
        switch (this.type) {
            case 'normal':
                topControl = new ContainerControl_1.ContainerControl({ id: game_strings_1.GameStrings.ID.PlayerContainer });
                break;
            case 'never':
                topControl = new NeverHandlesControl({ id: game_strings_1.GameStrings.ID.PlayerContainer });
                break;
            case 'reverse':
                topControl = new ReverseOrderControl({ id: game_strings_1.GameStrings.ID.PlayerContainer });
                break;
            default: throw new Error();
        }
        topControl.addChild(new ValueControl_1.ValueControl({
            id: game_strings_1.GameStrings.ID.PlayerName,
            slotType: 'CUSTOM.name',
            prompts: { requestValue: "none" },
            interactionModel: { targets: [game_strings_1.GameStrings.Target.Name] }
        }));
        topControl.addChild(new NumberControl_1.NumberControl({
            id: game_strings_1.GameStrings.ID.PlayerAge,
            prompts: { requestValue: "none" },
            interactionModel: { targets: [game_strings_1.GameStrings.Target.Age] }
        }));
        return topControl;
    }
}
/**
 * A ContainerControl that will never handle an input.
 */
class NeverHandlesControl extends ContainerControl_1.ContainerControl {
    async canHandle(input) {
        return false;
    }
}
/**
 * A ContainerControl that iterates its children backwards when looking for a child to handle an input.
 */
class ReverseOrderControl extends ContainerControl_1.ContainerControl {
    async canHandle(input) {
        return this.canHandleByChild(input);
    }
    async handle(input, resultBuilder) {
        return this.handleByChild(input, resultBuilder);
    }
    async canTakeInitiative(input) {
        return this.canTakeInitiativeByChild(input);
    }
    async takeInitiative(input, resultBuilder) {
        return this.takeInitiativeByChild(input, resultBuilder);
    }
    async decideHandlingChild(candidates, input) {
        ErrorUtils_1.throwIf(candidates.length === 0, "options is empty");
        return lodash_1.default.last(candidates); // <====== CUSTOM: return last rather than first
    }
    async decideInitiativeChild(candidates, input) {
        ErrorUtils_1.throwIf(candidates.length === 0, "options is empty");
        return lodash_1.default.last(candidates); // <====== CUSTOM: return last rather than first
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tX3BvbGljeS5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdGVzdC9jdXN0b21fcG9saWN5LnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7OztHQVdHOzs7QUFFSCwrQkFBOEI7QUFDOUIsNERBQXVCO0FBQ3ZCLGlDQUFvQztBQUNwQyxzREFBd0Q7QUFHeEQsbUVBQWdFO0FBRWhFLHdEQUFrRDtBQUNsRCx3RUFBZ0Y7QUFDaEYsaURBQW1EO0FBQ25ELHNGQUFtRjtBQUNuRiw4RUFBMkU7QUFDM0UscUVBQW1FO0FBRW5FLHVFQUFvRTtBQUNwRSxxRUFBa0U7QUFDbEUsdUVBQW9FO0FBR3BFOzs7O0dBSUc7QUFDSCxhQUFLLENBQUMsa0RBQWtELEVBQUUsR0FBRyxFQUFFO0lBQzNELFlBQUksQ0FBQyw0REFBNEQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMxRSxNQUFNLFdBQVcsR0FBRyxJQUFJLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ25FLE1BQU0sS0FBSyxHQUFHLHdCQUFTLENBQUMsRUFBRSxDQUFDLG1EQUF3QixDQUFDLEVBQUUsQ0FBQyxhQUFhLEVBQUUsRUFBRSxRQUFRLEVBQUUsaUJBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSwwQkFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNwSixNQUFNLE1BQU0sR0FBRyxNQUFNLDJCQUFZLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3RELGFBQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLENBQUMsQ0FBQyxDQUFDO0lBRUgsWUFBSSxDQUFDLDZEQUE2RCxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzNFLE1BQU0sV0FBVyxH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QW1CLENBQUMsVUFBcUIsRUFBRSxLQUFtQjtRQUNoRSxvQkFBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDckQsT0FBTyxnQkFBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQyxDQUFDLGdEQUFnRDtJQUNoRixDQUFDO0lBRUQsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQXFCLEVBQUUsS0FBbUI7UUFDbEUsb0JBQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3JELE9BQU8sZ0JBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFFLENBQUMsQ0FBQyxnREFBZ0Q7SUFDaEYsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDIwIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICogWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogb3IgaW4gdGhlIFwibGljZW5zZVwiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkXG4gKiBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nXG4gKiBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgZXhwZWN0IH0gZnJvbSBcImNoYWlcIjtcbmltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7IHN1aXRlLCB0ZXN0IH0gZnJvbSBcIm1vY2hhXCI7XG5pbXBvcnQgeyBTdHJpbmdzIGFzICQgfSBmcm9tIFwiLi4vc3JjL2NvbnN0YW50cy9TdHJpbmdzXCI7XG5pbXBvcnQgeyBDb250cm9sIH0gZnJvbSAnLi4vc3JjL2NvbnRyb2xzL0NvbnRyb2wnO1xuaW1wb3J0IHsgQ29udHJvbElucHV0IH0gZnJvbSAnLi4vc3JjL2NvbnRyb2xzL0NvbnRyb2xJbnB1dCc7XG5pbXBvcnQgeyBDb250cm9sTWFuYWdlciB9IGZyb20gJy4uL3NyYy9jb250cm9scy9Db250cm9sTWFuYWdlcic7XG5pbXBvcnQgeyBDb250cm9sUmVzdWx0QnVpbGRlciB9IGZyb20gJy4uL3NyYy9jb250cm9scy9Db250cm9sUmVzdWx0JztcbmltcG9ydCB7IHRocm93SWYgfSBmcm9tICcuLi9zcmMvdXRpbHMvRXJyb3JVdGlscyc7XG5pbXBvcnQgeyBzaW1wbGVJbnZva2UsIFRlc3RJbnB1dCB9IGZyb20gJy4uL3NyYy91dGlscy90ZXN0U3VwcG9ydC9UZXN0aW5nVXRpbHMnO1xuaW1wb3J0IHsgR2FtZVN0cmluZ3MgYXMgJCQgfSBmcm9tIFwiLi9nYW1lX3N0cmluZ3NcIjtcbmltcG9ydCB7IFNpbmdsZVZhbHVlQ29udHJvbEludGVudCB9IGZyb20gJy4uL3NyYy9pbnRlbnRzL1NpbmdsZVZhbHVlQ29udHJvbEludGVudCc7XG5pbXBvcnQgeyBHZW5lcmFsQ29udHJvbEludGVudCB9IGZyb20gJy4uL3NyYy9pbnRlbnRzL0dlbmVyYWxDb250cm9sSW50ZW50JztcbmltcG9ydCB7IFJlcXVlc3RWYWx1ZUFjdCB9IGZyb20gJy4uL3NyYy9zeXN0ZW1BY3RzL0luaXRpYXRpdmVBY3RzJztcbmltcG9ydCB7IFN5c3RlbUFjdCB9IGZyb20gJy4uL3NyYy9zeXN0ZW1BY3RzL1N5c3RlbUFjdCc7XG5pbXBvcnQgeyBDb250YWluZXJDb250cm9sIH0gZnJvbSAnLi4vc3JjL2NvbnRyb2xzL0NvbnRhaW5lckNvbnRyb2wnO1xuaW1wb3J0IHsgVmFsdWVDb250cm9sIH0gZnJvbSAnLi4vc3JjL2NvbW1vbkNvbnRyb2xzL1ZhbHVlQ29udHJvbCc7XG5pbXBvcnQgeyBOdW1iZXJDb250cm9sIH0gZnJvbSAnLi4vc3JjL2NvbW1vbkNvbnRyb2xzL051bWJlckNvbnRyb2wnO1xuXG5cbi8qKlxuICogRGVtb25zdHJhdGUgc3RhbmRhcmQgQ29udHJvbFN0YXRlIG9iamVjdCBidXQgd2l0aCBkaWZmZXJlbnQgQ29udHJvbHMgdG8gaGFuZGxlIHRoZW1cbiAqIHRoZSBjaG9pY2Ugb2YgY29udHJvbCB0byB1c2UgaXMgYnkgY29udHJvbFN0YXRlLnR5cGUgYW5kIGJ5IHJlZ2lzdGVyaW5nIHRoZSBjb250cm9sIHR5cGVzXG4gKiB3aXRoIHRoZSBVc2VySW50ZXJmYWNlIHNvIHRoYXQgaXQgY2FuIGZ1bmN0aW9uIGFzIGEgY29udHJvbCBmYWN0b3J5LlxuICovXG5zdWl0ZShcIj09IEN1c3RvbSBwb2xpY3kgc2NlbmFyaW9zIChjdXN0b21fcG9saWN5LnRzKSA9PVwiLCAoKSA9PiB7XG4gICAgdGVzdChcImNvbnRhaW5lciB3aXRoIGN1c3RvbSBjYW5IYW5kbGUgdGhhdCBhbHdheXMgcmV0dXJucyBmYWxzZS5cIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByb290Q29udHJvbCA9IG5ldyBDdXN0b21NYW5hZ2VyKCduZXZlcicpLmNyZWF0ZUNvbnRyb2xUcmVlKCk7XG4gICAgICAgIGNvbnN0IGlucHV0ID0gVGVzdElucHV0Lm9mKFNpbmdsZVZhbHVlQ29udHJvbEludGVudC5vZignQ1VTVE9NLm5hbWUnLCB7ICdhY3Rpb24nOiAkLkFjdGlvbi5TZXQsICd0YXJnZXQnOiAkJC5UYXJnZXQuTmFtZSwgJ0NVU1RPTS5uYW1lJzogXCJNaWtlXCIgfSkpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzaW1wbGVJbnZva2Uocm9vdENvbnRyb2wsIGlucHV0KTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5hY3RzKS5sZW5ndGgoMCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KFwiRGVmYXVsdCBjYW5IYW5kbGUgcmV0dXJucyBmaXJzdCBsaXN0ZWQgY29udHJvbCAocGxheWVyTmFtZSlcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByb290Q29udHJvbCA9IG5ldyBDdXN0b21NYW5hZ2VyKCdub3JtYWwnKS5jcmVhdGVDb250cm9sVHJlZSgpO1xuICAgICAgICBjb25zdCBpbnB1dCA9IFRlc3RJbnB1dC5vZihHZW5lcmFsQ29udHJvbEludGVudC5vZih7IGFjdGlvbjogJC5BY3Rpb24uU2V0IH0pKTsgLy8gVE9ETzpoYW5kbGUgU2luZ2xlVmFsdWVDb250cm9sSW50ZW50IHdpdGgganVzdCBzbG90VHlwZXNcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2ltcGxlSW52b2tlKHJvb3RDb250cm9sLCBpbnB1dCk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuYWN0c1swXSkuaW5zdGFuY2VPZihSZXF1ZXN0VmFsdWVBY3QpO1xuICAgICAgICBleHBlY3QoKHJlc3VsdC5hY3RzWzBdIGFzIFN5c3RlbUFjdCkuY29udHJvbC5pZCkuZXF1YWxzKCQkLklELlBsYXllck5hbWUpO1xuICAgIH0pO1xuXG4gICAgdGVzdChcIkN1c3RvbSBwb2xpY3kgZm9yIGNvbnRhaW5lci5jYW5IYW5kbGUgcmV0dXJucyBkaWZmZXJlbnQgaW5pdGlhdGl2ZSBjb250cm9sIChwbGF5ZXJBZ2UgcmF0aGVyIHRoYW4gcGxheWVyTmFtZSlcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByb290Q29udHJvbCA9IG5ldyBDdXN0b21NYW5hZ2VyKCdyZXZlcnNlJykuY3JlYXRlQ29udHJvbFRyZWUoKTtcbiAgICAgICAgY29uc3QgaW5wdXQgPSBUZXN0SW5wdXQub2YoR2VuZXJhbENvbnRyb2xJbnRlbnQub2YoeyBhY3Rpb246ICQuQWN0aW9uLlNldCB9KSk7IC8vIFRPRE86aGFuZGxlIFNpbmdsZVZhbHVlQ29udHJvbEludGVudCB3aXRoIGp1c3Qgc2xvdFR5cGVzXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNpbXBsZUludm9rZShyb290Q29udHJvbCwgaW5wdXQpO1xuICAgICAgICBleHBlY3QocmVzdWx0LmFjdHNbMF0pLmluc3RhbmNlT2YoUmVxdWVzdFZhbHVlQWN0KTtcbiAgICAgICAgZXhwZWN0KChyZXN1bHQuYWN0c1swXSBhcyBTeXN0ZW1BY3QpLmNvbnRyb2wuaWQpLmVxdWFscygkJC5JRC5QbGF5ZXJBZ2UpOyAgIC8vIDw9PT09PT0gUkVTVUxUOiBSZXF1ZXN0aW5nIEFnZSByYXRoZXIgdGhhbiBOYW1lLlxuICAgIH0pO1xufSk7XG5cbmNsYXNzIEN1c3RvbU1hbmFnZXIgZXh0ZW5kcyBDb250cm9sTWFuYWdlciB7XG4gICAgdHlwZTogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IodHlwZTogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMudHlwZSA9IHR5cGU7XG4gICAgfVxuXG4gICAgY3JlYXRlQ29udHJvbFRyZWUoc3RhdGU/OiBhbnksIGlucHV0PzogQ29udHJvbElucHV0KTogQ29udHJvbCB7XG4gICAgICAgIGxldCB0b3BDb250cm9sOiBDb250YWluZXJDb250cm9sO1xuICAgICAgICBzd2l0Y2ggKHRoaXMudHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnbm9ybWFsJzogdG9wQ29udHJvbCA9IG5ldyBDb250YWluZXJDb250cm9sKHsgaWQ6ICQkLklELlBsYXllckNvbnRhaW5lciB9KTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICduZXZlcic6IHRvcENvbnRyb2wgPSBuZXcgTmV2ZXJIYW5kbGVzQ29udHJvbCh7IGlkOiAkJC5JRC5QbGF5ZXJDb250YWluZXIgfSk7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAncmV2ZXJzZSc6IHRvcENvbnRyb2wgPSBuZXcgUmV2ZXJzZU9yZGVyQ29udHJvbCh7IGlkOiAkJC5JRC5QbGF5ZXJDb250YWluZXIgfSk7IGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0b3BDb250cm9sLmFkZENoaWxkKG5ldyBWYWx1ZUNvbnRyb2woXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWQ6ICQkLklELlBsYXllck5hbWUsXG4gICAgICAgICAgICAgICAgc2xvdFR5cGU6ICdDVVNUT00ubmFtZScsXG4gICAgICAgICAgICAgICAgcHJvbXB0czogeyByZXF1ZXN0VmFsdWU6IFwibm9uZVwiIH0sXG4gICAgICAgICAgICAgICAgaW50ZXJhY3Rpb25Nb2RlbDogeyB0YXJnZXRzOiBbJCQuVGFyZ2V0Lk5hbWVdIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgKSk7XG5cbiAgICAgICAgdG9wQ29udHJvbC5hZGRDaGlsZChuZXcgTnVtYmVyQ29udHJvbChcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZDogJCQuSUQuUGxheWVyQWdlLFxuICAgICAgICAgICAgICAgIHByb21wdHM6IHsgcmVxdWVzdFZhbHVlOiBcIm5vbmVcIiB9LFxuICAgICAgICAgICAgICAgIGludGVyYWN0aW9uTW9kZWw6IHsgdGFyZ2V0czogWyQkLlRhcmdldC5BZ2VdIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgKSk7XG5cbiAgICAgICAgcmV0dXJuIHRvcENvbnRyb2w7XG4gICAgfVxufVxuXG4vKipcbiAqIEEgQ29udGFpbmVyQ29udHJvbCB0aGF0IHdpbGwgbmV2ZXIgaGFuZGxlIGFuIGlucHV0LlxuICovXG5cbmNsYXNzIE5ldmVySGFuZGxlc0NvbnRyb2wgZXh0ZW5kcyBDb250YWluZXJDb250cm9sIHtcbiAgICBhc3luYyBjYW5IYW5kbGUoaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuXG4vKipcbiAqIEEgQ29udGFpbmVyQ29udHJvbCB0aGF0IGl0ZXJhdGVzIGl0cyBjaGlsZHJlbiBiYWNrd2FyZHMgd2hlbiBsb29raW5nIGZvciBhIGNoaWxkIHRvIGhhbmRsZSBhbiBpbnB1dC5cbiAqL1xuY2xhc3MgUmV2ZXJzZU9yZGVyQ29udHJvbCBleHRlbmRzIENvbnRhaW5lckNvbnRyb2wge1xuXG4gICAgYXN5bmMgY2FuSGFuZGxlKGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuSGFuZGxlQnlDaGlsZChpbnB1dCk7XG4gICAgfVxuXG4gICAgYXN5bmMgaGFuZGxlKGlucHV0OiBDb250cm9sSW5wdXQsIHJlc3VsdEJ1aWxkZXI6IENvbnRyb2xSZXN1bHRCdWlsZGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhbmRsZUJ5Q2hpbGQoaW5wdXQsIHJlc3VsdEJ1aWxkZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIGNhblRha2VJbml0aWF0aXZlKGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuVGFrZUluaXRpYXRpdmVCeUNoaWxkKGlucHV0KTtcbiAgICB9XG5cbiAgICBhc3luYyB0YWtlSW5pdGlhdGl2ZShpbnB1dDogQ29udHJvbElucHV0LCByZXN1bHRCdWlsZGVyOiBDb250cm9sUmVzdWx0QnVpbGRlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YWtlSW5pdGlhdGl2ZUJ5Q2hpbGQoaW5wdXQsIHJlc3VsdEJ1aWxkZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIGRlY2lkZUhhbmRsaW5nQ2hpbGQoY2FuZGlkYXRlczogQ29udHJvbFtdLCBpbnB1dDogQ29udHJvbElucHV0KTogUHJvbWlzZTxDb250cm9sIHwgdW5kZWZpbmVkPiB7XG4gICAgICAgIHRocm93SWYoY2FuZGlkYXRlcy5sZW5ndGggPT09IDAsIFwib3B0aW9ucyBpcyBlbXB0eVwiKTtcbiAgICAgICAgcmV0dXJuIF8ubGFzdChjYW5kaWRhdGVzKSE7IC8vIDw9PT09PT0gQ1VTVE9NOiByZXR1cm4gbGFzdCByYXRoZXIgdGhhbiBmaXJzdFxuICAgIH1cblxuICAgIGFzeW5jIGRlY2lkZUluaXRpYXRpdmVDaGlsZChjYW5kaWRhdGVzOiBDb250cm9sW10sIGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPENvbnRyb2wgfCB1bmRlZmluZWQ+IHtcbiAgICAgICAgdGhyb3dJZihjYW5kaWRhdGVzLmxlbmd0aCA9PT0gMCwgXCJvcHRpb25zIGlzIGVtcHR5XCIpO1xuICAgICAgICByZXR1cm4gXy5sYXN0KGNhbmRpZGF0ZXMpITsgLy8gPD09PT09PSBDVVNUT006IHJldHVybiBsYXN0IHJhdGhlciB0aGFuIGZpcnN0XG4gICAgfVxufSJdfQ==